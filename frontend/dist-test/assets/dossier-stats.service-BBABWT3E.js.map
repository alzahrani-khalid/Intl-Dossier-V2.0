{"version":3,"file":"dossier-stats.service-BBABWT3E.js","sources":["../../src/services/dossier-stats.service.ts"],"sourcesContent":["/**\n * Dossier Stats Service\n * Feature: 030-health-commitment\n *\n * API client for fetching dossier statistics (commitments, engagements, documents, health scores)\n * Connects to Supabase Edge Functions: dossier-stats, calculate-health-score\n */\n\nimport { supabase } from '@/lib/supabase';\n\n/**\n * Dossier statistics response\n */\nexport interface DossierStats {\n  dossierId: string;\n  commitments?: {\n    total: number;\n    active: number;\n    overdue: number;\n    fulfilled: number;\n    upcoming: number;\n    fulfillmentRate: number;\n  };\n  engagements?: {\n    total365d: number;\n    recent90d: number;\n    latestDate: string | null;\n    frequencyScore: number;\n  };\n  documents?: {\n    total: number;\n  };\n  health?: {\n    overallScore: number | null;\n    components: {\n      engagementFrequency: number;\n      commitmentFulfillment: number;\n      recencyScore: number;\n    } | null;\n    sufficientData: boolean;\n    reason: string | null;\n    calculatedAt: string | null;\n  };\n  dataFreshness?: {\n    isCurrent: boolean;\n    calculatedAt: string | null;\n    ageMinutes: number | null;\n  };\n}\n\n/**\n * Bulk dossier stats response\n */\nexport interface BulkDossierStatsResponse {\n  stats: DossierStats[];\n  totalCount: number;\n}\n\n/**\n * Health score response\n */\nexport interface HealthScoreResponse {\n  dossierId: string;\n  overallScore: number | null;\n  components: {\n    engagementFrequency: number;\n    commitmentFulfillment: number;\n    recencyScore: number;\n  };\n  sufficientData: boolean;\n  reason: string | null;\n  calculatedAt: string;\n  calculationTimeMs: number;\n  cached: boolean;\n}\n\n/**\n * Get statistics for a single dossier\n *\n * @param dossierId - UUID of the dossier\n * @param include - Optional array of stat categories to include (default: all)\n * @returns Dossier statistics\n */\nexport async function getStats(\n  dossierId: string,\n  include?: Array<'commitments' | 'engagements' | 'documents' | 'health'>\n): Promise<DossierStats> {\n  const { data: session } = await supabase.auth.getSession();\n\n  if (!session.session) {\n    throw new Error('User not authenticated');\n  }\n\n  const url = new URL(\n    `${import.meta.env.VITE_SUPABASE_URL}/functions/v1/dossier-stats`\n  );\n  url.searchParams.append('dossierId', dossierId);\n  if (include && include.length > 0) {\n    url.searchParams.append('include', include.join(','));\n  }\n\n  const response = await fetch(url.toString(), {\n    method: 'GET',\n    headers: {\n      Authorization: `Bearer ${session.session.access_token}`,\n      'Content-Type': 'application/json',\n    },\n  });\n\n  if (!response.ok) {\n    const error = await response.json();\n    throw new Error(error.error?.message_en || 'Failed to fetch dossier stats');\n  }\n\n  return response.json();\n}\n\n/**\n * Get statistics for multiple dossiers in a single request\n *\n * @param dossierIds - Array of dossier UUIDs (max 100)\n * @param include - Optional array of stat categories to include (default: all)\n * @returns Bulk dossier statistics\n */\nexport async function getBulkStats(\n  dossierIds: string[],\n  include?: Array<'commitments' | 'engagements' | 'documents' | 'health'>\n): Promise<BulkDossierStatsResponse> {\n  const { data: session } = await supabase.auth.getSession();\n\n  if (!session.session) {\n    throw new Error('User not authenticated');\n  }\n\n  if (dossierIds.length === 0) {\n    return { stats: [], totalCount: 0 };\n  }\n\n  if (dossierIds.length > 100) {\n    throw new Error('Cannot fetch more than 100 dossiers at once');\n  }\n\n  const response = await fetch(\n    `${import.meta.env.VITE_SUPABASE_URL}/functions/v1/dossier-stats`,\n    {\n      method: 'POST',\n      headers: {\n        Authorization: `Bearer ${session.session.access_token}`,\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({\n        dossierIds,\n        include,\n      }),\n    }\n  );\n\n  if (!response.ok) {\n    const error = await response.json();\n    throw new Error(error.error?.message_en || 'Failed to fetch bulk dossier stats');\n  }\n\n  return response.json();\n}\n\n/**\n * Calculate or retrieve health score for a dossier\n *\n * @param dossierId - UUID of the dossier\n * @param forceRecalculation - If true, recalculate even if cached score exists (default: false)\n * @returns Health score response\n */\nexport async function calculateHealthScore(\n  dossierId: string,\n  forceRecalculation = false\n): Promise<HealthScoreResponse> {\n  const { data: session } = await supabase.auth.getSession();\n\n  if (!session.session) {\n    throw new Error('User not authenticated');\n  }\n\n  const response = await fetch(\n    `${import.meta.env.VITE_SUPABASE_URL}/functions/v1/calculate-health-score`,\n    {\n      method: 'POST',\n      headers: {\n        Authorization: `Bearer ${session.session.access_token}`,\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({\n        dossierId,\n        forceRecalculation,\n      }),\n    }\n  );\n\n  if (!response.ok) {\n    const error = await response.json();\n    throw new Error(error.error?.message_en || 'Failed to calculate health score');\n  }\n\n  return response.json();\n}\n\n/**\n * Get health score color based on value\n *\n * @param score - Health score (0-100) or null\n * @returns Tailwind CSS color class\n */\nexport function getHealthScoreColor(score: number | null): string {\n  if (score === null) return 'text-gray-400';\n  if (score >= 80) return 'text-green-600 dark:text-green-400';\n  if (score >= 60) return 'text-yellow-600 dark:text-yellow-400';\n  if (score >= 40) return 'text-orange-600 dark:text-orange-400';\n  return 'text-red-600 dark:text-red-400';\n}\n\n/**\n * Get health score label based on value\n *\n * @param score - Health score (0-100) or null\n * @returns Human-readable label\n */\nexport function getHealthScoreLabel(score: number | null): string {\n  if (score === null) return 'Insufficient Data';\n  if (score >= 80) return 'Excellent';\n  if (score >= 60) return 'Good';\n  if (score >= 40) return 'Fair';\n  return 'Poor';\n}\n\n/**\n * Health distribution breakdown by tier\n */\nexport interface HealthDistribution {\n  excellent: number; // 80-100\n  good: number; // 60-79\n  fair: number; // 40-59\n  poor: number; // 0-39\n}\n\n/**\n * Health aggregation for a group (region, bloc, or classification)\n */\nexport interface HealthAggregation {\n  groupValue: string;\n  averageHealthScore: number;\n  dossierCount: number;\n  healthDistribution: HealthDistribution;\n}\n\n/**\n * Dashboard aggregations response\n */\nexport interface DashboardAggregationsResponse {\n  aggregations: HealthAggregation[];\n  totalDossiers: number;\n  groupBy: string;\n}\n\n/**\n * Dashboard aggregations request filter\n */\nexport interface DashboardAggregationsFilter {\n  dossierType?: 'country' | 'organization' | 'forum';\n  minHealthScore?: number;\n}\n\n/**\n * Get dashboard health aggregations grouped by region or org_type\n *\n * @param groupBy - Field to group by (region for countries, org_type for organizations)\n * @param filter - Optional filter criteria\n * @returns Dashboard aggregations\n */\nexport async function getDashboardAggregations(\n  groupBy: 'region' | 'org_type',\n  filter?: DashboardAggregationsFilter\n): Promise<DashboardAggregationsResponse> {\n  const { data: session } = await supabase.auth.getSession();\n\n  if (!session.session) {\n    throw new Error('User not authenticated');\n  }\n\n  const response = await fetch(\n    `${import.meta.env.VITE_SUPABASE_URL}/functions/v1/dossier-stats/dashboard-aggregations`,\n    {\n      method: 'POST',\n      headers: {\n        Authorization: `Bearer ${session.session.access_token}`,\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({\n        groupBy,\n        filter,\n      }),\n    }\n  );\n\n  if (!response.ok) {\n    const error = await response.json();\n    throw new Error(\n      error.error?.message_en || 'Failed to fetch dashboard aggregations'\n    );\n  }\n\n  return response.json();\n}\n"],"names":["getStats","dossierId","include","session","supabase","url","response","error","getHealthScoreColor","score","getHealthScoreLabel","getDashboardAggregations","groupBy","filter"],"mappings":"wCAmFA,eAAsBA,EACpBC,EACAC,EACuB,CACvB,KAAM,CAAE,KAAMC,CAAA,EAAY,MAAMC,EAAS,KAAK,WAAA,EAE9C,GAAI,CAACD,EAAQ,QACX,MAAM,IAAI,MAAM,wBAAwB,EAG1C,MAAME,EAAM,IAAI,IACd,qEAAoC,EAEtCA,EAAI,aAAa,OAAO,YAAaJ,CAAS,EAC1CC,GAAWA,EAAQ,OAAS,GAC9BG,EAAI,aAAa,OAAO,UAAWH,EAAQ,KAAK,GAAG,CAAC,EAGtD,MAAMI,EAAW,MAAM,MAAMD,EAAI,WAAY,CAC3C,OAAQ,MACR,QAAS,CACP,cAAe,UAAUF,EAAQ,QAAQ,YAAY,GACrD,eAAgB,kBAAA,CAClB,CACD,EAED,GAAI,CAACG,EAAS,GAAI,CAChB,MAAMC,EAAQ,MAAMD,EAAS,KAAA,EAC7B,MAAM,IAAI,MAAMC,EAAM,OAAO,YAAc,+BAA+B,CAC5E,CAEA,OAAOD,EAAS,KAAA,CAClB,CAgGO,SAASE,EAAoBC,EAA8B,CAChE,OAAIA,IAAU,KAAa,gBACvBA,GAAS,GAAW,qCACpBA,GAAS,GAAW,uCACpBA,GAAS,GAAW,uCACjB,gCACT,CAQO,SAASC,EAAoBD,EAA8B,CAChE,OAAIA,IAAU,KAAa,oBACvBA,GAAS,GAAW,YACpBA,GAAS,GAAW,OACpBA,GAAS,GAAW,OACjB,MACT,CA8CA,eAAsBE,EACpBC,EACAC,EACwC,CACxC,KAAM,CAAE,KAAMV,CAAA,EAAY,MAAMC,EAAS,KAAK,WAAA,EAE9C,GAAI,CAACD,EAAQ,QACX,MAAM,IAAI,MAAM,wBAAwB,EAG1C,MAAMG,EAAW,MAAM,MACrB,6FACA,CACE,OAAQ,OACR,QAAS,CACP,cAAe,UAAUH,EAAQ,QAAQ,YAAY,GACrD,eAAgB,kBAAA,EAElB,KAAM,KAAK,UAAU,CACnB,QAAAS,EACA,OAAAC,CAAA,CACD,CAAA,CACH,EAGF,GAAI,CAACP,EAAS,GAAI,CAChB,MAAMC,EAAQ,MAAMD,EAAS,KAAA,EAC7B,MAAM,IAAI,MACRC,EAAM,OAAO,YAAc,wCAAA,CAE/B,CAEA,OAAOD,EAAS,KAAA,CAClB"}