{"version":3,"file":"useAfterAction-DL23SY7H.js","sources":["../../src/hooks/useAfterAction.ts"],"sourcesContent":["import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query';\nimport { supabase } from '@/lib/supabase';\n\n// Types based on API spec\nexport interface Decision {\n  id: string;\n  after_action_id: string;\n  description: string;\n  rationale?: string | null;\n  decision_maker: string;\n  decision_date: string;\n  created_at: string;\n}\n\nexport interface CreateDecision {\n  description: string;\n  rationale?: string;\n  decision_maker: string;\n  decision_date: string;\n}\n\nexport interface Commitment {\n  id: string;\n  after_action_id: string;\n  dossier_id: string;\n  description: string;\n  priority: 'low' | 'medium' | 'high' | 'critical';\n  status: 'pending' | 'in_progress' | 'completed' | 'cancelled' | 'overdue';\n  owner_type: 'internal' | 'external';\n  owner_user_id?: string | null;\n  owner_contact_id?: string | null;\n  tracking_mode: 'automatic' | 'manual';\n  due_date: string;\n  completed_at?: string | null;\n  ai_confidence?: number | null;\n}\n\nexport interface CreateCommitment {\n  description: string;\n  priority: 'low' | 'medium' | 'high' | 'critical';\n  owner_type: 'internal' | 'external';\n  owner_user_id?: string;\n  owner_contact_email?: string;\n  owner_contact_name?: string;\n  due_date: string;\n  ai_confidence?: number;\n}\n\nexport interface Risk {\n  id: string;\n  after_action_id: string;\n  description: string;\n  severity: 'low' | 'medium' | 'high' | 'critical';\n  likelihood: 'unlikely' | 'possible' | 'likely' | 'certain';\n  mitigation_strategy?: string | null;\n  owner?: string | null;\n  ai_confidence?: number | null;\n}\n\nexport interface CreateRisk {\n  description: string;\n  severity: 'low' | 'medium' | 'high' | 'critical';\n  likelihood: 'unlikely' | 'possible' | 'likely' | 'certain';\n  mitigation_strategy?: string;\n  owner?: string;\n  ai_confidence?: number;\n}\n\nexport interface FollowUpAction {\n  id: string;\n  after_action_id: string;\n  description: string;\n  assigned_to?: string | null;\n  target_date?: string | null;\n  completed: boolean;\n}\n\nexport interface CreateFollowUpAction {\n  description: string;\n  assigned_to?: string;\n  target_date?: string;\n}\n\nexport interface AfterActionRecord {\n  id: string;\n  engagement_id: string;\n  dossier_id: string;\n  publication_status: 'draft' | 'published' | 'edit_requested' | 'edit_approved' | 'edit_rejected';\n  is_confidential: boolean;\n  attendees?: string[];\n  notes?: string | null;\n  decisions?: Decision[];\n  commitments?: Commitment[];\n  risks?: Risk[];\n  follow_up_actions?: FollowUpAction[];\n  created_by: string;\n  created_at: string;\n  updated_by?: string | null;\n  updated_at: string;\n  published_by?: string | null;\n  published_at?: string | null;\n  version: number;\n}\n\nexport interface CreateAfterActionRequest {\n  engagement_id: string;\n  is_confidential: boolean;\n  attendees?: string[];\n  notes?: string;\n  decisions?: CreateDecision[];\n  commitments?: CreateCommitment[];\n  risks?: CreateRisk[];\n  follow_up_actions?: CreateFollowUpAction[];\n}\n\nexport interface UpdateAfterActionRequest extends CreateAfterActionRequest {\n  version: number;\n}\n\nexport interface AfterActionVersion {\n  id: string;\n  after_action_id: string;\n  version_number: number;\n  publication_status: 'draft' | 'published' | 'edit_requested' | 'edit_approved' | 'edit_rejected';\n  is_confidential: boolean;\n  attendees?: string[];\n  notes?: string | null;\n  decisions?: Decision[];\n  commitments?: Commitment[];\n  risks?: Risk[];\n  follow_up_actions?: FollowUpAction[];\n  created_by: string;\n  created_at: string;\n  superseded: boolean;\n}\n\n// Fetch single after-action by ID\nexport function useAfterAction(id: string | undefined) {\n  return useQuery({\n    queryKey: ['after-action', id],\n    queryFn: async () => {\n      if (!id) throw new Error('After-action ID is required');\n\n      const { data, error } = await supabase.functions.invoke('after-actions-get', {\n        body: { id },\n      });\n\n      if (error) throw error;\n      return data as AfterActionRecord;\n    },\n    enabled: !!id,\n  });\n}\n\n// Fetch after-actions list for a dossier\nexport function useAfterActions(\n  dossierId: string | undefined,\n  options?: {\n    status?: 'draft' | 'published' | 'edit_requested';\n    limit?: number;\n    offset?: number;\n  }\n) {\n  return useQuery({\n    queryKey: ['after-actions', dossierId, options],\n    queryFn: async () => {\n      if (!dossierId) throw new Error('Dossier ID is required');\n\n      const { data, error } = await supabase.functions.invoke('after-actions-list', {\n        body: { dossier_id: dossierId, ...options },\n      });\n\n      if (error) throw error;\n      return data as { data: AfterActionRecord[]; total: number };\n    },\n    enabled: !!dossierId,\n  });\n}\n\n// Create after-action mutation\nexport function useCreateAfterAction() {\n  const queryClient = useQueryClient();\n\n  return useMutation({\n    mutationFn: async (request: CreateAfterActionRequest) => {\n      const { data, error } = await supabase.functions.invoke('after-actions-create', {\n        body: request,\n      });\n\n      if (error) throw error;\n      return data as AfterActionRecord;\n    },\n    onSuccess: (data) => {\n      // Invalidate after-actions list for the dossier\n      queryClient.invalidateQueries({ queryKey: ['after-actions', data.dossier_id] });\n      // Set the single after-action in cache\n      queryClient.setQueryData(['after-action', data.id], data);\n    },\n  });\n}\n\n// Update after-action mutation with optimistic locking\nexport function useUpdateAfterAction(id: string) {\n  const queryClient = useQueryClient();\n\n  return useMutation({\n    mutationFn: async (request: UpdateAfterActionRequest) => {\n      const { data, error } = await supabase.functions.invoke('after-actions-update', {\n        body: { id, ...request },\n      });\n\n      if (error) {\n        // Check for version conflict\n        if (error.message?.includes('version') || error.message?.includes('conflict')) {\n          throw new Error('Record was modified by another user. Please refresh.');\n        }\n        throw error;\n      }\n      return data as AfterActionRecord;\n    },\n    onMutate: async (newData) => {\n      // Cancel outgoing refetches\n      await queryClient.cancelQueries({ queryKey: ['after-action', id] });\n\n      // Snapshot previous value\n      const previousAfterAction = queryClient.getQueryData<AfterActionRecord>(['after-action', id]);\n\n      // Optimistically update\n      if (previousAfterAction) {\n        queryClient.setQueryData(['after-action', id], {\n          ...previousAfterAction,\n          ...newData,\n          version: newData.version + 1,\n          updated_at: new Date().toISOString(),\n        });\n      }\n\n      return { previousAfterAction };\n    },\n    onError: (_err, _newData, context) => {\n      // Rollback on error\n      if (context?.previousAfterAction) {\n        queryClient.setQueryData(['after-action', id], context.previousAfterAction);\n      }\n    },\n    onSuccess: (data) => {\n      // Update cache with server data\n      queryClient.setQueryData(['after-action', id], data);\n      // Invalidate list\n      queryClient.invalidateQueries({ queryKey: ['after-actions', data.dossier_id] });\n    },\n  });\n}\n\n// Fetch version history for an after-action\nexport function useAfterActionVersions(afterActionId: string | undefined) {\n  return useQuery({\n    queryKey: ['after-action-versions', afterActionId],\n    queryFn: async () => {\n      if (!afterActionId) throw new Error('After-action ID is required');\n\n      const { data, error } = await supabase.functions.invoke('after-actions-versions', {\n        body: { after_action_id: afterActionId },\n      });\n\n      if (error) throw error;\n      return data as AfterActionVersion[];\n    },\n    enabled: !!afterActionId,\n  });\n}\n"],"names":["useAfterAction","id","useQuery","data","error","supabase","useCreateAfterAction","queryClient","useQueryClient","useMutation","request","useAfterActionVersions","afterActionId"],"mappings":"mGAyIO,SAASA,EAAeC,EAAwB,CACrD,OAAOC,EAAS,CACd,SAAU,CAAC,eAAgBD,CAAE,EAC7B,QAAS,SAAY,CACnB,GAAI,CAACA,EAAI,MAAM,IAAI,MAAM,6BAA6B,EAEtD,KAAM,CAAE,KAAAE,EAAM,MAAAC,CAAA,EAAU,MAAMC,EAAS,UAAU,OAAO,oBAAqB,CAC3E,KAAM,CAAE,GAAAJ,CAAA,CAAG,CACZ,EAED,GAAIG,EAAO,MAAMA,EACjB,OAAOD,CACT,EACA,QAAS,CAAC,CAACF,CAAA,CACZ,CACH,CA4BO,SAASK,GAAuB,CACrC,MAAMC,EAAcC,EAAA,EAEpB,OAAOC,EAAY,CACjB,WAAY,MAAOC,GAAsC,CACvD,KAAM,CAAE,KAAAP,EAAM,MAAAC,CAAA,EAAU,MAAMC,EAAS,UAAU,OAAO,uBAAwB,CAC9E,KAAMK,CAAA,CACP,EAED,GAAIN,EAAO,MAAMA,EACjB,OAAOD,CACT,EACA,UAAYA,GAAS,CAEnBI,EAAY,kBAAkB,CAAE,SAAU,CAAC,gBAAiBJ,EAAK,UAAU,EAAG,EAE9EI,EAAY,aAAa,CAAC,eAAgBJ,EAAK,EAAE,EAAGA,CAAI,CAC1D,CAAA,CACD,CACH,CAwDO,SAASQ,EAAuBC,EAAmC,CACxE,OAAOV,EAAS,CACd,SAAU,CAAC,wBAAyBU,CAAa,EACjD,QAAS,SAAY,CACnB,GAAI,CAACA,EAAe,MAAM,IAAI,MAAM,6BAA6B,EAEjE,KAAM,CAAE,KAAAT,EAAM,MAAAC,CAAA,EAAU,MAAMC,EAAS,UAAU,OAAO,yBAA0B,CAChF,KAAM,CAAE,gBAAiBO,CAAA,CAAc,CACxC,EAED,GAAIR,EAAO,MAAMA,EACjB,OAAOD,CACT,EACA,QAAS,CAAC,CAACS,CAAA,CACZ,CACH"}