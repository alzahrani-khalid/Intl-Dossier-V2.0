{"version":3,"file":"EntityLinkManager-HzbH6mRj.js","sources":["../../src/services/entity-links-api.ts","../../src/hooks/use-entity-search.ts","../../src/hooks/use-entity-links.ts","../../src/components/entity-links/EntitySearchDialog.tsx","../../src/components/entity-links/LinkTypeBadge.tsx","../../src/components/entity-links/LinkCard.tsx","../../src/components/entity-links/LinkList.tsx","../../src/hooks/use-ai-suggestions.ts","../../src/components/entity-links/AISuggestionPanel.tsx","../../src/components/ai/EntityLinkSuggestions.tsx","../../src/components/entity-links/EntityLinkManager.tsx"],"sourcesContent":["/**\n * Intake Entity Links API Client\n * Feature: 024-intake-entity-linking\n *\n * Typed API client wrapper for intake entity linking operations.\n * Handles authentication, error handling, and response parsing.\n */\n\nimport { createClient } from '@supabase/supabase-js';\nimport type {\n  EntityLink,\n  CreateLinkRequest,\n  UpdateLinkRequest,\n  BatchCreateLinksRequest,\n  ReorderLinksRequest,\n  LinkAuditLog,\n  EntitySearchResult,\n  EntityType,\n} from '../../../backend/src/types/intake-entity-links.types';\nimport type {\n  AILinkSuggestion,\n  GenerateSuggestionsRequest,\n  AcceptSuggestionRequest,\n  SuggestionGenerationResult,\n} from '../../../backend/src/types/ai-suggestions.types';\n\n// Initialize Supabase client\nconst supabaseUrl = import.meta.env.VITE_SUPABASE_URL;\nconst supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;\n\nif (!supabaseUrl || !supabaseAnonKey) {\n  throw new Error('Missing Supabase environment variables');\n}\n\nexport const supabase = createClient(supabaseUrl, supabaseAnonKey);\n\nconst FUNCTIONS_BASE_URL = `${supabaseUrl}/functions/v1`;\n\n/**\n * API Response types\n */\nexport interface APISuccessResponse<T> {\n  success: true;\n  data: T;\n  message?: string;\n}\n\nexport interface APIErrorResponse {\n  success: false;\n  error: {\n    code: string;\n    message: string;\n    details?: Array<{\n      field?: string;\n      issue: string;\n    }>;\n  };\n}\n\nexport type APIResponse<T> = APISuccessResponse<T> | APIErrorResponse;\n\n/**\n * API Error class\n */\nexport class EntityLinksAPIError extends Error {\n  code: string;\n  details?: Array<{ field?: string; issue: string }>;\n\n  constructor(error: APIErrorResponse['error']) {\n    super(error.message);\n    this.name = 'EntityLinksAPIError';\n    this.code = error.code;\n    this.details = error.details;\n  }\n}\n\n/**\n * Helper function to make authenticated requests\n */\nasync function fetchWithAuth<T>(\n  endpoint: string,\n  options: RequestInit = {}\n): Promise<T> {\n  const {\n    data: { session },\n  } = await supabase.auth.getSession();\n\n  if (!session) {\n    throw new Error('Not authenticated');\n  }\n\n  const response = await fetch(`${FUNCTIONS_BASE_URL}${endpoint}`, {\n    ...options,\n    headers: {\n      'Authorization': `Bearer ${session.access_token}`,\n      'Content-Type': 'application/json',\n      ...options.headers,\n    },\n  });\n\n  const data: APIResponse<T> = await response.json();\n\n  if (!data.success) {\n    throw new EntityLinksAPIError(data.error);\n  }\n\n  return data.data;\n}\n\n/**\n * Entity search filters interface\n */\nexport interface EntitySearchFilters {\n  query?: string;\n  entity_types?: EntityType[];\n  organization_id?: string;\n  classification_level?: number;\n  include_archived?: boolean;\n  limit?: number;\n}\n\n/**\n * Entity intakes filters interface\n */\nexport interface EntityIntakesFilters {\n  status?: string[];\n  from_date?: string;\n  to_date?: string;\n  page?: number;\n  limit?: number;\n}\n\n/**\n * Entity intakes response interface\n */\nexport interface EntityIntakesResponse {\n  items: Array<{\n    id: string;\n    ticket_number: string;\n    title: string;\n    status: string;\n    priority: string;\n    link_type: string;\n    linked_at: string;\n    linked_by: string;\n  }>;\n  pagination: {\n    page: number;\n    limit: number;\n    total_items: number;\n    total_pages: number;\n    has_next: boolean;\n    has_prev: boolean;\n  };\n}\n\n/**\n * Batch create response interface\n */\nexport interface BatchCreateResponse {\n  created_links: EntityLink[];\n  failed_links: Array<{\n    index: number;\n    error: string;\n  }>;\n}\n\n/**\n * Intake Entity Links API Client\n */\nexport const intakeEntityLinksAPI = {\n  /**\n   * Create a new entity link\n   */\n  async createLink(\n    intakeId: string,\n    data: Omit<CreateLinkRequest, 'intake_id'>\n  ): Promise<EntityLink> {\n    return fetchWithAuth<EntityLink>(`/intake-links-create?intake_id=${intakeId}`, {\n      method: 'POST',\n      body: JSON.stringify(data),\n    });\n  },\n\n  /**\n   * Get all links for an intake\n   */\n  async getLinks(\n    intakeId: string,\n    includeDeleted = false\n  ): Promise<EntityLink[]> {\n    const params = new URLSearchParams();\n    params.append('intake_id', intakeId);\n    params.append('include_deleted', includeDeleted.toString());\n\n    return fetchWithAuth<EntityLink[]>(\n      `/intake-links-get?${params.toString()}`,\n      {\n        method: 'GET',\n      }\n    );\n  },\n\n  /**\n   * Update an existing link\n   */\n  async updateLink(\n    intakeId: string,\n    linkId: string,\n    data: UpdateLinkRequest\n  ): Promise<EntityLink> {\n    return fetchWithAuth<EntityLink>(\n      `/intake-links-update?intake_id=${intakeId}&link_id=${linkId}`,\n      {\n        method: 'PUT',\n        body: JSON.stringify(data),\n      }\n    );\n  },\n\n  /**\n   * Delete a link (soft delete)\n   */\n  async deleteLink(intakeId: string, linkId: string): Promise<void> {\n    await fetchWithAuth<void>(`/intake/${intakeId}/links/${linkId}`, {\n      method: 'DELETE',\n    });\n  },\n\n  /**\n   * Restore a deleted link\n   */\n  async restoreLink(intakeId: string, linkId: string): Promise<EntityLink> {\n    return fetchWithAuth<EntityLink>(\n      `/intake/${intakeId}/links/${linkId}/restore`,\n      {\n        method: 'POST',\n      }\n    );\n  },\n\n  /**\n   * Create multiple links in batch\n   */\n  async createBatchLinks(\n    intakeId: string,\n    data: Omit<BatchCreateLinksRequest, 'intake_id'>\n  ): Promise<BatchCreateResponse> {\n    return fetchWithAuth<BatchCreateResponse>(\n      `/intake-links-batch?intake_id=${intakeId}`,\n      {\n        method: 'POST',\n        body: JSON.stringify(data),\n      }\n    );\n  },\n\n  /**\n   * Reorder links\n   */\n  async reorderLinks(\n    intakeId: string,\n    linkOrders: Array<{ link_id: string; link_order: number }>\n  ): Promise<void> {\n    await fetchWithAuth<void>(`/intake/${intakeId}/links/reorder`, {\n      method: 'PUT',\n      body: JSON.stringify({ link_orders: linkOrders }),\n    });\n  },\n\n  /**\n   * Search for entities to link\n   */\n  async searchEntities(\n    filters: EntitySearchFilters\n  ): Promise<EntitySearchResult[]> {\n    const params = new URLSearchParams();\n\n    if (filters.query) {\n      params.append('q', filters.query); // Use 'q' as expected by Edge Function\n    }\n    if (filters.entity_types && filters.entity_types.length > 0) {\n      params.append('entity_types', filters.entity_types.join(','));\n    }\n    if (filters.organization_id) {\n      params.append('organization_id', filters.organization_id);\n    }\n    if (filters.classification_level !== undefined) {\n      params.append(\n        'classification_level',\n        filters.classification_level.toString()\n      );\n    }\n    if (filters.include_archived !== undefined) {\n      params.append('include_archived', filters.include_archived.toString());\n    }\n    if (filters.limit) {\n      params.append('limit', filters.limit.toString());\n    }\n\n    return fetchWithAuth<EntitySearchResult[]>(\n      `/entities-search?${params.toString()}`,\n      {\n        method: 'GET',\n      }\n    );\n  },\n\n  /**\n   * Get all intakes linked to an entity\n   */\n  async getEntityIntakes(\n    entityType: EntityType,\n    entityId: string,\n    filters?: EntityIntakesFilters\n  ): Promise<EntityIntakesResponse> {\n    const params = new URLSearchParams();\n\n    if (filters?.status && filters.status.length > 0) {\n      params.append('status', filters.status.join(','));\n    }\n    if (filters?.from_date) {\n      params.append('from_date', filters.from_date);\n    }\n    if (filters?.to_date) {\n      params.append('to_date', filters.to_date);\n    }\n    if (filters?.page) {\n      params.append('page', filters.page.toString());\n    }\n    if (filters?.limit) {\n      params.append('limit', filters.limit.toString());\n    }\n\n    return fetchWithAuth<EntityIntakesResponse>(\n      `/entities/${entityType}/${entityId}/intakes?${params.toString()}`,\n      {\n        method: 'GET',\n      }\n    );\n  },\n\n  /**\n   * Get audit log for a link\n   */\n  async getAuditLog(intakeId: string, linkId: string): Promise<LinkAuditLog[]> {\n    return fetchWithAuth<LinkAuditLog[]>(\n      `/intake/${intakeId}/links/${linkId}/audit-log`,\n      {\n        method: 'GET',\n      }\n    );\n  },\n\n  /**\n   * AI Suggestions namespace\n   */\n  ai: {\n    /**\n     * Generate AI link suggestions for an intake\n     */\n    async generateSuggestions(\n      intakeId: string,\n      options?: Omit<GenerateSuggestionsRequest, 'intake_id'>\n    ): Promise<SuggestionGenerationResult> {\n      return fetchWithAuth<SuggestionGenerationResult>(\n        `/intake-links-suggestions?intake_id=${intakeId}`,\n        {\n          method: 'POST',\n          body: JSON.stringify(options || {}),\n        }\n      );\n    },\n\n    /**\n     * Accept an AI suggestion and create a link\n     */\n    async acceptSuggestion(\n      intakeId: string,\n      data: AcceptSuggestionRequest\n    ): Promise<EntityLink> {\n      return fetchWithAuth<EntityLink>(\n        `/intake/${intakeId}/links/suggestions/accept`,\n        {\n          method: 'POST',\n          body: JSON.stringify(data),\n        }\n      );\n    },\n\n    /**\n     * Reject an AI suggestion\n     */\n    async rejectSuggestion(\n      intakeId: string,\n      suggestionId: string\n    ): Promise<void> {\n      await fetchWithAuth<void>(\n        `/intake/${intakeId}/links/suggestions/${suggestionId}/reject`,\n        {\n          method: 'POST',\n        }\n      );\n    },\n  },\n};\n\n/**\n * Export singleton instance\n */\nexport default intakeEntityLinksAPI;\n\n/**\n * Export with alternative names for convenience\n */\nexport const entityLinksApi = intakeEntityLinksAPI;\n","/**\n * Entity Search Hook\n * Feature: 024-intake-entity-linking\n * Task: T044\n *\n * TanStack Query hook for entity search operations\n * with FR-001a ranking (AI confidence 50% + recency 30% + alphabetical 20%)\n */\n\nimport { useQuery } from '@tanstack/react-query';\nimport { useState, useCallback, useEffect } from 'react';\nimport {\n  intakeEntityLinksAPI,\n  type EntitySearchFilters,\n} from '@/services/entity-links-api';\nimport type { EntitySearchResult } from '../../../backend/src/types/intake-entity-links.types';\n\n/**\n * Debounced value hook\n */\nfunction useDebouncedValue<T>(value: T, delay: number): T {\n  const [debouncedValue, setDebouncedValue] = useState<T>(value);\n\n  useEffect(() => {\n    const handler = setTimeout(() => {\n      setDebouncedValue(value);\n    }, delay);\n\n    return () => {\n      clearTimeout(handler);\n    };\n  }, [value, delay]);\n\n  return debouncedValue;\n}\n\n/**\n * Query keys for cache management\n */\nexport const entitySearchKeys = {\n  all: ['entity-search'] as const,\n  searches: () => [...entitySearchKeys.all, 'search'] as const,\n  search: (filters: EntitySearchFilters) =>\n    [...entitySearchKeys.searches(), filters] as const,\n};\n\n/**\n * Entity search options\n */\nexport interface UseEntitySearchOptions {\n  /** Debounce delay in milliseconds (default: 300ms) */\n  debounceMs?: number;\n  /** Minimum query length to trigger search (default: 2) */\n  minQueryLength?: number;\n  /** Enable the query (default: true) */\n  enabled?: boolean;\n  /** Results limit (default: 20) */\n  limit?: number;\n}\n\n/**\n * Hook for entity search with debouncing\n */\nexport function useEntitySearch(\n  filters: Omit<EntitySearchFilters, 'limit'>,\n  options: UseEntitySearchOptions = {}\n) {\n  const {\n    debounceMs = 300,\n    minQueryLength = 2,\n    enabled = true,\n    limit = 20,\n  } = options;\n\n  // Debounce the search query\n  const debouncedQuery = useDebouncedValue(filters.query || '', debounceMs);\n\n  // Determine if search should be enabled\n  const shouldSearch =\n    enabled &&\n    debouncedQuery.length >= minQueryLength;\n\n  return useQuery({\n    queryKey: entitySearchKeys.search({\n      ...filters,\n      query: debouncedQuery,\n      limit,\n    }),\n    queryFn: () =>\n      intakeEntityLinksAPI.searchEntities({\n        ...filters,\n        query: debouncedQuery,\n        limit,\n      }),\n    enabled: shouldSearch,\n    staleTime: 1000 * 60 * 5, // 5 minutes - entity data changes infrequently\n    gcTime: 1000 * 60 * 10, // 10 minutes (formerly cacheTime)\n  });\n}\n\n/**\n * Stateful entity search hook with local state management\n * Useful for search input components\n */\nexport function useEntitySearchState(\n  initialFilters: Omit<EntitySearchFilters, 'query' | 'limit'> = {},\n  options: UseEntitySearchOptions = {}\n) {\n  const [query, setQuery] = useState('');\n  const [selectedTypes, setSelectedTypes] = useState<EntitySearchFilters['entity_types']>(\n    initialFilters.entity_types\n  );\n\n  const searchFilters: Omit<EntitySearchFilters, 'limit'> = {\n    query,\n    entity_types: selectedTypes,\n    organization_id: initialFilters.organization_id,\n    classification_level: initialFilters.classification_level,\n    include_archived: initialFilters.include_archived ?? false,\n  };\n\n  const searchQuery = useEntitySearch(searchFilters, options);\n\n  // Clear query handler\n  const clearSearch = useCallback(() => {\n    setQuery('');\n  }, []);\n\n  // Toggle entity type filter\n  const toggleEntityType = useCallback(\n    (entityType: string) => {\n      setSelectedTypes((prev) => {\n        if (!prev) return [entityType] as EntitySearchFilters['entity_types'];\n        if (prev.includes(entityType as any)) {\n          return prev.filter((t) => t !== entityType) as EntitySearchFilters['entity_types'];\n        }\n        return [...prev, entityType] as EntitySearchFilters['entity_types'];\n      });\n    },\n    []\n  );\n\n  // Clear all filters\n  const clearFilters = useCallback(() => {\n    setQuery('');\n    setSelectedTypes(undefined);\n  }, []);\n\n  return {\n    // Query state\n    query,\n    setQuery,\n\n    // Filter state\n    selectedTypes,\n    setSelectedTypes,\n    toggleEntityType,\n\n    // Actions\n    clearSearch,\n    clearFilters,\n\n    // Search query result\n    ...searchQuery,\n  };\n}\n\n/**\n * Hook to get entity intakes (reverse lookup)\n * For displaying all intake tickets linked to an entity\n */\nexport function useEntityIntakes(\n  entityType: string,\n  entityId: string,\n  filters?: {\n    status?: string[];\n    from_date?: string;\n    to_date?: string;\n    page?: number;\n    limit?: number;\n  }\n) {\n  return useQuery({\n    queryKey: ['entity-intakes', entityType, entityId, filters],\n    queryFn: () =>\n      intakeEntityLinksAPI.getEntityIntakes(\n        entityType as any,\n        entityId,\n        filters\n      ),\n    enabled: !!entityType && !!entityId,\n    staleTime: 1000 * 60 * 2, // 2 minutes\n    gcTime: 1000 * 60 * 10, // 10 minutes\n  });\n}\n\n/**\n * Type guard to check if results are available\n */\nexport function hasSearchResults(\n  data: EntitySearchResult[] | undefined\n): data is EntitySearchResult[] {\n  return Array.isArray(data) && data.length > 0;\n}\n\n/**\n * Helper to format entity type for display\n */\nexport function formatEntityType(entityType: string): string {\n  const typeMap: Record<string, string> = {\n    dossier: 'Dossier',\n    position: 'Position',\n    mou: 'MOU',\n    engagement: 'Engagement',\n    assignment: 'Assignment',\n    commitment: 'Commitment',\n    intelligence_signal: 'Intelligence Signal',\n    organization: 'Organization',\n    country: 'Country',\n    forum: 'Forum',\n    working_group: 'Working Group',\n    topic: 'Topic',\n  };\n\n  return typeMap[entityType] || entityType;\n}\n","/**\n * Entity Links Hook\n * Feature: 024-intake-entity-linking\n * Task: T043\n *\n * TanStack Query hook for intake entity link CRUD operations\n * with optimistic updates for <50ms perceived latency\n */\n\nimport { useMutation, useQuery, useQueryClient } from '@tanstack/react-query';\nimport { useTranslation } from 'react-i18next';\nimport { intakeEntityLinksAPI, type EntityLinksAPIError } from '@/services/entity-links-api';\nimport type {\n  EntityLink,\n  CreateLinkRequest,\n  UpdateLinkRequest,\n} from '../../../backend/src/types/intake-entity-links.types';\nimport { useToast } from './use-toast';\n\n/**\n * Query keys for cache management\n */\nexport const entityLinksKeys = {\n  all: ['entity-links'] as const,\n  lists: () => [...entityLinksKeys.all, 'list'] as const,\n  list: (intakeId: string, includeDeleted = false) =>\n    [...entityLinksKeys.lists(), intakeId, includeDeleted] as const,\n  detail: (intakeId: string, linkId: string) =>\n    [...entityLinksKeys.all, 'detail', intakeId, linkId] as const,\n  auditLog: (intakeId: string, linkId: string) =>\n    [...entityLinksKeys.all, 'audit', intakeId, linkId] as const,\n};\n\n/**\n * Hook to fetch entity links for an intake\n */\nexport function useEntityLinks(intakeId: string, includeDeleted = false) {\n  const { t } = useTranslation();\n\n  return useQuery({\n    queryKey: entityLinksKeys.list(intakeId, includeDeleted),\n    queryFn: () => intakeEntityLinksAPI.getLinks(intakeId, includeDeleted),\n    enabled: !!intakeId,\n    staleTime: 1000 * 60 * 2, // 2 minutes\n    gcTime: 1000 * 60 * 10, // 10 minutes (formerly cacheTime)\n  });\n}\n\n/**\n * Hook to create a new entity link\n * Includes optimistic updates for instant UI feedback\n */\nexport function useCreateEntityLink(intakeId: string) {\n  const { t } = useTranslation();\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  return useMutation({\n    mutationFn: (data: Omit<CreateLinkRequest, 'intake_id'>) =>\n      intakeEntityLinksAPI.createLink(intakeId, data),\n\n    // Optimistic update for <50ms perceived latency\n    onMutate: async (newLink) => {\n      // Cancel any outgoing refetches\n      await queryClient.cancelQueries({\n        queryKey: entityLinksKeys.list(intakeId, false),\n      });\n\n      // Snapshot the previous value\n      const previousLinks = queryClient.getQueryData<EntityLink[]>(\n        entityLinksKeys.list(intakeId, false)\n      );\n\n      // Optimistically update the cache\n      if (previousLinks) {\n        const optimisticLink: EntityLink = {\n          id: `temp-${Date.now()}`, // Temporary ID\n          intake_id: intakeId,\n          entity_type: newLink.entity_type,\n          entity_id: newLink.entity_id,\n          link_type: newLink.link_type,\n          notes: newLink.notes,\n          link_order: previousLinks.length + 1,\n          created_by: 'current-user', // Will be replaced with actual value\n          created_at: new Date().toISOString(),\n          updated_at: new Date().toISOString(),\n          deleted_at: null,\n          deleted_by: null,\n          _version: 1,\n        };\n\n        queryClient.setQueryData<EntityLink[]>(\n          entityLinksKeys.list(intakeId, false),\n          [...previousLinks, optimisticLink]\n        );\n      }\n\n      // Return context with snapshot\n      return { previousLinks };\n    },\n\n    // On error, rollback to previous value\n    onError: (error: EntityLinksAPIError, newLink, context) => {\n      if (context?.previousLinks) {\n        queryClient.setQueryData(\n          entityLinksKeys.list(intakeId, false),\n          context.previousLinks\n        );\n      }\n\n      toast({\n        variant: 'destructive',\n        title: t('entityLinks.createError'),\n        description: error.message || t('entityLinks.createErrorDescription'),\n      });\n    },\n\n    // Always refetch after error or success\n    onSettled: () => {\n      queryClient.invalidateQueries({\n        queryKey: entityLinksKeys.list(intakeId, false),\n      });\n    },\n\n    // On success, show confirmation\n    onSuccess: (data) => {\n      toast({\n        title: t('entityLinks.createSuccess'),\n        description: t('entityLinks.createSuccessDescription'),\n      });\n    },\n  });\n}\n\n/**\n * Hook to update an existing entity link\n */\nexport function useUpdateEntityLink(intakeId: string, linkId: string) {\n  const { t } = useTranslation();\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  return useMutation({\n    mutationFn: (data: UpdateLinkRequest) =>\n      intakeEntityLinksAPI.updateLink(intakeId, linkId, data),\n\n    // Optimistic update\n    onMutate: async (updatedData) => {\n      await queryClient.cancelQueries({\n        queryKey: entityLinksKeys.list(intakeId, false),\n      });\n\n      const previousLinks = queryClient.getQueryData<EntityLink[]>(\n        entityLinksKeys.list(intakeId, false)\n      );\n\n      if (previousLinks) {\n        queryClient.setQueryData<EntityLink[]>(\n          entityLinksKeys.list(intakeId, false),\n          previousLinks.map((link) =>\n            link.id === linkId\n              ? {\n                  ...link,\n                  ...updatedData,\n                  updated_at: new Date().toISOString(),\n                  _version: link._version + 1,\n                }\n              : link\n          )\n        );\n      }\n\n      return { previousLinks };\n    },\n\n    onError: (error: EntityLinksAPIError, updatedData, context) => {\n      if (context?.previousLinks) {\n        queryClient.setQueryData(\n          entityLinksKeys.list(intakeId, false),\n          context.previousLinks\n        );\n      }\n\n      // Handle optimistic locking conflicts\n      if (error.code === 'OPTIMISTIC_LOCK_FAILURE') {\n        toast({\n          variant: 'destructive',\n          title: t('entityLinks.conflictError'),\n          description: t('entityLinks.conflictErrorDescription'),\n        });\n      } else {\n        toast({\n          variant: 'destructive',\n          title: t('entityLinks.updateError'),\n          description: error.message || t('entityLinks.updateErrorDescription'),\n        });\n      }\n    },\n\n    onSettled: () => {\n      queryClient.invalidateQueries({\n        queryKey: entityLinksKeys.list(intakeId, false),\n      });\n    },\n\n    onSuccess: () => {\n      toast({\n        title: t('entityLinks.updateSuccess'),\n        description: t('entityLinks.updateSuccessDescription'),\n      });\n    },\n  });\n}\n\n/**\n * Hook to delete an entity link (soft delete)\n */\nexport function useDeleteEntityLink(intakeId: string) {\n  const { t } = useTranslation();\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  return useMutation({\n    mutationFn: (linkId: string) => intakeEntityLinksAPI.deleteLink(intakeId, linkId),\n\n    // Optimistic update\n    onMutate: async (linkId) => {\n      await queryClient.cancelQueries({\n        queryKey: entityLinksKeys.list(intakeId, false),\n      });\n\n      const previousLinks = queryClient.getQueryData<EntityLink[]>(\n        entityLinksKeys.list(intakeId, false)\n      );\n\n      if (previousLinks) {\n        queryClient.setQueryData<EntityLink[]>(\n          entityLinksKeys.list(intakeId, false),\n          previousLinks.filter((link) => link.id !== linkId)\n        );\n      }\n\n      return { previousLinks };\n    },\n\n    onError: (error: EntityLinksAPIError, linkId, context) => {\n      if (context?.previousLinks) {\n        queryClient.setQueryData(\n          entityLinksKeys.list(intakeId, false),\n          context.previousLinks\n        );\n      }\n\n      toast({\n        variant: 'destructive',\n        title: t('entityLinks.deleteError'),\n        description: error.message || t('entityLinks.deleteErrorDescription'),\n      });\n    },\n\n    onSettled: () => {\n      queryClient.invalidateQueries({\n        queryKey: entityLinksKeys.list(intakeId, false),\n      });\n    },\n\n    onSuccess: () => {\n      toast({\n        title: t('entityLinks.deleteSuccess'),\n        description: t('entityLinks.deleteSuccessDescription'),\n      });\n    },\n  });\n}\n\n/**\n * Hook to restore a deleted entity link\n * Only available to steward+ roles\n */\nexport function useRestoreEntityLink(intakeId: string) {\n  const { t } = useTranslation();\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  return useMutation({\n    mutationFn: (linkId: string) => intakeEntityLinksAPI.restoreLink(intakeId, linkId),\n\n    onSettled: () => {\n      queryClient.invalidateQueries({\n        queryKey: entityLinksKeys.list(intakeId, true),\n      });\n      queryClient.invalidateQueries({\n        queryKey: entityLinksKeys.list(intakeId, false),\n      });\n    },\n\n    onError: (error: EntityLinksAPIError) => {\n      toast({\n        variant: 'destructive',\n        title: t('entityLinks.restoreError'),\n        description: error.message || t('entityLinks.restoreErrorDescription'),\n      });\n    },\n\n    onSuccess: () => {\n      toast({\n        title: t('entityLinks.restoreSuccess'),\n        description: t('entityLinks.restoreSuccessDescription'),\n      });\n    },\n  });\n}\n\n/**\n * Hook to reorder entity links\n * Uses debounced mutations for drag-and-drop\n */\nexport function useReorderEntityLinks(intakeId: string) {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  return useMutation({\n    mutationFn: (linkOrders: Array<{ link_id: string; link_order: number }>) =>\n      intakeEntityLinksAPI.reorderLinks(intakeId, linkOrders),\n\n    // Optimistic update\n    onMutate: async (linkOrders) => {\n      await queryClient.cancelQueries({\n        queryKey: entityLinksKeys.list(intakeId, false),\n      });\n\n      const previousLinks = queryClient.getQueryData<EntityLink[]>(\n        entityLinksKeys.list(intakeId, false)\n      );\n\n      if (previousLinks) {\n        const reorderedLinks = [...previousLinks];\n        linkOrders.forEach(({ link_id, link_order }) => {\n          const linkIndex = reorderedLinks.findIndex((link) => link.id === link_id);\n          if (linkIndex !== -1) {\n            reorderedLinks[linkIndex] = {\n              ...reorderedLinks[linkIndex],\n              link_order,\n            };\n          }\n        });\n\n        reorderedLinks.sort((a, b) => a.link_order - b.link_order);\n\n        queryClient.setQueryData<EntityLink[]>(\n          entityLinksKeys.list(intakeId, false),\n          reorderedLinks\n        );\n      }\n\n      return { previousLinks };\n    },\n\n    onError: (error: EntityLinksAPIError, linkOrders, context) => {\n      if (context?.previousLinks) {\n        queryClient.setQueryData(\n          entityLinksKeys.list(intakeId, false),\n          context.previousLinks\n        );\n      }\n    },\n\n    onSettled: () => {\n      queryClient.invalidateQueries({\n        queryKey: entityLinksKeys.list(intakeId, false),\n      });\n    },\n  });\n}\n\n/**\n * Hook to create multiple entity links in batch\n * Includes optimistic updates for instant UI feedback\n */\nexport function useCreateBatchEntityLinks(intakeId: string) {\n  const { t } = useTranslation();\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  return useMutation({\n    mutationFn: (\n      links: Array<{\n        entity_type: string;\n        entity_id: string;\n        link_type: string;\n        notes?: string;\n      }>\n    ) =>\n      intakeEntityLinksAPI.createBatchLinks(intakeId, {\n        links: links.map((link) => ({\n          ...link,\n          link_type: link.link_type as any,\n          entity_type: link.entity_type as any,\n        })),\n      }),\n\n    // Optimistic update for batch creation\n    onMutate: async (newLinks) => {\n      await queryClient.cancelQueries({\n        queryKey: entityLinksKeys.list(intakeId, false),\n      });\n\n      const previousLinks = queryClient.getQueryData<EntityLink[]>(\n        entityLinksKeys.list(intakeId, false)\n      );\n\n      // Optimistically add all new links\n      if (previousLinks) {\n        const optimisticLinks: EntityLink[] = newLinks.map((link, index) => ({\n          id: `temp-${Date.now()}-${index}`,\n          intake_id: intakeId,\n          entity_type: link.entity_type as any,\n          entity_id: link.entity_id,\n          link_type: link.link_type as any,\n          notes: link.notes || '',\n          link_order: previousLinks.length + index + 1,\n          created_by: 'current-user',\n          created_at: new Date().toISOString(),\n          updated_at: new Date().toISOString(),\n          deleted_at: null,\n          deleted_by: null,\n          _version: 1,\n        }));\n\n        queryClient.setQueryData<EntityLink[]>(\n          entityLinksKeys.list(intakeId, false),\n          [...previousLinks, ...optimisticLinks]\n        );\n      }\n\n      return { previousLinks };\n    },\n\n    onError: (error: EntityLinksAPIError, newLinks, context) => {\n      if (context?.previousLinks) {\n        queryClient.setQueryData(\n          entityLinksKeys.list(intakeId, false),\n          context.previousLinks\n        );\n      }\n\n      toast({\n        variant: 'destructive',\n        title: t('entityLinks.createBatchError'),\n        description: error.message || t('entityLinks.createBatchErrorDescription'),\n      });\n    },\n\n    onSettled: () => {\n      queryClient.invalidateQueries({\n        queryKey: entityLinksKeys.list(intakeId, false),\n      });\n    },\n\n    onSuccess: (data) => {\n      const successCount = data.created_links.length;\n      const failCount = data.failed_links.length;\n\n      if (failCount > 0) {\n        toast({\n          variant: 'default',\n          title: t('entityLinks.createBatchPartialSuccess'),\n          description: t('entityLinks.createBatchPartialSuccessDescription', {\n            success: successCount,\n            failed: failCount,\n          }),\n        });\n      } else {\n        toast({\n          title: t('entityLinks.createBatchSuccess'),\n          description: t('entityLinks.createBatchSuccessDescription', {\n            count: successCount,\n          }),\n        });\n      }\n    },\n  });\n}\n\n/**\n * Hook to fetch audit log for a link\n */\nexport function useEntityLinkAuditLog(intakeId: string, linkId: string) {\n  return useQuery({\n    queryKey: entityLinksKeys.auditLog(intakeId, linkId),\n    queryFn: () => intakeEntityLinksAPI.getAuditLog(intakeId, linkId),\n    enabled: !!intakeId && !!linkId,\n    staleTime: 1000 * 60, // 1 minute\n  });\n}\n","/**\n * Entity Search Dialog Component\n * Feature: 024-intake-entity-linking\n * Task: T047\n *\n * Mobile-first search dialog for finding entities to link\n * with FR-001a ranking (AI 50% + recency 30% + alphabetical 20%)\n */\n\nimport { useState, useCallback, useMemo } from 'react';\nimport { useTranslation } from 'react-i18next';\nimport { Search, X, Loader2, CheckCircle2 } from 'lucide-react';\nimport {\n Dialog,\n DialogContent,\n DialogHeader,\n DialogTitle,\n DialogDescription,\n} from '@/components/ui/dialog';\nimport { Input } from '@/components/ui/input';\nimport { Button } from '@/components/ui/button';\nimport { ScrollArea } from '@/components/ui/scroll-area';\nimport { Badge } from '@/components/ui/badge';\nimport { Checkbox } from '@/components/ui/checkbox';\nimport { cn } from '@/lib/utils';\nimport { useEntitySearchState, formatEntityType } from '@/hooks/use-entity-search';\nimport { useEntityLinks } from '@/hooks/use-entity-links';\nimport type { EntitySearchResult, EntityType } from '../../../../backend/src/types/intake-entity-links.types';\n\n/**\n * Entity type filter options\n */\nconst ENTITY_TYPES: EntityType[] = [\n 'dossier',\n 'position',\n 'mou',\n 'engagement',\n 'assignment',\n 'commitment',\n 'intelligence_signal',\n 'organization',\n 'country',\n 'forum',\n 'working_group',\n 'topic',\n];\n\nexport interface EntitySearchDialogProps {\n /** Whether the dialog is open */\n open: boolean;\n /** Callback when dialog should close */\n onOpenChange: (open: boolean) => void;\n /** Callback when entities are selected (batch mode) */\n onSelect: (entities: EntitySearchResult[], shouldReplacePrimary?: boolean) => void;\n /** Intake ID for fetching existing links */\n intakeId: string;\n /** Organization ID filter */\n organizationId?: string;\n /** Classification level filter */\n classificationLevel?: number;\n /** Whether to include archived entities */\n includeArchived?: boolean;\n}\n\n/**\n * EntitySearchDialog Component\n *\n * Provides a search interface for finding entities to link.\n * Results are ranked by AI confidence, recency, and alphabetical order.\n *\n * @example\n * ```tsx\n * <EntitySearchDialog\n * open={isOpen}\n * onOpenChange={setIsOpen}\n * onSelect={(entity) => createLink(entity)}\n * organizationId={currentOrgId}\n * />\n * ```\n */\nexport function EntitySearchDialog({\n open,\n onOpenChange,\n onSelect,\n intakeId,\n organizationId,\n classificationLevel,\n includeArchived = false,\n}: EntitySearchDialogProps) {\n const { t, i18n } = useTranslation();\n const isRTL = i18n.language === 'ar';\n\n // State for selected entities (multi-select)\n const [selectedEntities, setSelectedEntities] = useState<EntitySearchResult[]>([]);\n // State for which entity should be primary (only one allowed)\n const [primaryEntityKey, setPrimaryEntityKey] = useState<string | null>(null);\n\n const {\n query,\n setQuery,\n selectedTypes,\n toggleEntityType,\n clearFilters,\n data: results,\n isLoading,\n error,\n } = useEntitySearchState(\n {\n organization_id: organizationId,\n classification_level: classificationLevel,\n include_archived: includeArchived,\n },\n {\n debounceMs: 300,\n minQueryLength: 2,\n enabled: open,\n limit: 20,\n }\n );\n\n // Fetch existing links to highlight already-linked entities\n const { data: existingLinks } = useEntityLinks(intakeId, false);\n\n // Create a Set of already-linked entity IDs for quick lookup\n const linkedEntityIds = useMemo(() => {\n if (!existingLinks) return new Set<string>();\n return new Set(\n existingLinks.map((link) => `${link.entity_type}-${link.entity_id}`)\n );\n }, [existingLinks]);\n\n // Check if there's an existing primary link\n const existingPrimaryLink = useMemo(() => {\n if (!existingLinks) return null;\n return existingLinks.find((link) => link.link_type === 'primary');\n }, [existingLinks]);\n\n // Check if user has selected a new primary\n const willReplacePrimary = useMemo(() => {\n return !!existingPrimaryLink && !!primaryEntityKey;\n }, [existingPrimaryLink, primaryEntityKey]);\n\n // Toggle entity selection\n const handleToggleSelect = useCallback(\n (entity: EntitySearchResult) => {\n const entityKey = `${entity.entity_type}-${entity.entity_id}`;\n const isSelected = selectedEntities.some(\n (e) => `${e.entity_type}-${e.entity_id}` === entityKey\n );\n\n if (isSelected) {\n setSelectedEntities(\n selectedEntities.filter(\n (e) => `${e.entity_type}-${e.entity_id}` !== entityKey\n )\n );\n } else {\n setSelectedEntities([...selectedEntities, entity]);\n }\n },\n [selectedEntities]\n );\n\n // Submit selected entities with primary designation\n const handleSubmit = useCallback(() => {\n if (selectedEntities.length > 0) {\n // Add primary designation to entities\n const entitiesWithPrimary = selectedEntities.map((entity) => ({\n ...entity,\n _shouldBePrimary: `${entity.entity_type}-${entity.entity_id}` === primaryEntityKey,\n }));\n // Pass replacement flag if user is replacing an existing primary\n onSelect(entitiesWithPrimary, willReplacePrimary);\n onOpenChange(false);\n setQuery('');\n clearFilters();\n setSelectedEntities([]);\n setPrimaryEntityKey(null);\n }\n }, [selectedEntities, primaryEntityKey, willReplacePrimary, onSelect, onOpenChange, setQuery, clearFilters]);\n\n // Handle dialog close\n const handleClose = useCallback(() => {\n onOpenChange(false);\n setQuery('');\n clearFilters();\n setSelectedEntities([]);\n setPrimaryEntityKey(null);\n }, [onOpenChange, setQuery, clearFilters]);\n\n return (\n <Dialog open={open} onOpenChange={handleClose}>\n <DialogContent\n className={cn(\n // Mobile-first sizing\n 'max-w-full sm:max-w-2xl',\n 'h-[90vh] sm:h-[80vh]', // Always constrain height for scrolling\n 'mx-0 sm:mx-auto',\n 'p-0',\n\n // RTL support\n isRTL && 'text-end'\n )}\n >\n <DialogHeader className=\"px-4 pt-4 sm:px-6 sm:pt-6\">\n <DialogTitle className={cn(\n 'text-lg sm:text-xl',\n 'text-start'\n )}>\n {t('entityLinks.searchDialogTitle')}\n </DialogTitle>\n <DialogDescription className=\"text-start\">\n {t('entityLinks.searchDialogDescription')}\n </DialogDescription>\n </DialogHeader>\n\n <div className=\"flex flex-col h-full overflow-hidden\">\n {/* Search input */}\n <div className={cn(\n 'px-4 pb-3 sm:px-6 sm:pb-4',\n 'border-b'\n )}>\n <div className=\"relative\">\n <Search className={cn(\n 'absolute top-1/2 -translate-y-1/2',\n 'h-4 w-4 sm:h-5 sm:w-5',\n 'text-slate-400',\n isRTL ? 'end-3' : 'start-3'\n )} />\n <Input\n type=\"text\"\n placeholder={t('entityLinks.searchPlaceholder')}\n value={query}\n onChange={(e) => setQuery(e.target.value)}\n className={cn(\n 'w-full',\n 'text-sm sm:text-base',\n 'min-h-11', // 44px touch target\n isRTL ? 'pe-10 ps-3' : 'ps-10 pe-3'\n )}\n dir={isRTL ? 'rtl' : 'ltr'}\n autoFocus\n aria-label={t('entityLinks.searchInput')}\n />\n {query && (\n <Button\n variant=\"ghost\"\n size=\"icon\"\n className={cn(\n 'absolute top-1/2 -translate-y-1/2',\n 'h-8 w-8 sm:h-9 sm:w-9',\n isRTL ? 'start-1' : 'end-1'\n )}\n onClick={() => setQuery('')}\n aria-label={t('common.clear')}\n >\n <X className=\"h-4 w-4\" />\n </Button>\n )}\n </div>\n </div>\n\n {/* Entity type filters */}\n <div className={cn(\n 'px-4 py-3 sm:px-6',\n 'border-b bg-slate-50/50 dark:bg-slate-900/20'\n )}>\n {/* Filter header with clear button */}\n <div className={cn(\n 'flex items-center justify-between mb-3',\n isRTL && 'flex-row-reverse'\n )}>\n <span className=\"text-xs font-medium text-slate-600 dark:text-slate-400\">\n {selectedTypes && selectedTypes.length > 0\n ? `${selectedTypes.length} ${t('entityLinks.filtersSelected', { count: selectedTypes.length })}`\n : t('entityLinks.filterByType')}\n </span>\n {selectedTypes && selectedTypes.length > 0 && (\n <Button\n variant=\"ghost\"\n size=\"sm\"\n className=\"h-7 px-2 text-xs\"\n onClick={clearFilters}\n >\n {t('common.clearFilters')}\n </Button>\n )}\n </div>\n\n {/* Scrollable filter chips */}\n <ScrollArea className=\"w-full\">\n <div className={cn(\n 'flex gap-2 pb-2',\n isRTL && 'flex-row-reverse'\n )}>\n {ENTITY_TYPES.map((type) => {\n const isSelected = selectedTypes?.includes(type);\n return (\n <Button\n key={type}\n variant={isSelected ? 'default' : 'outline'}\n size=\"sm\"\n className={cn(\n 'min-h-9 px-3 flex-shrink-0', // Touch-friendly\n 'text-xs',\n 'touch-manipulation',\n 'whitespace-nowrap',\n 'transition-all duration-200',\n isSelected && 'shadow-sm'\n )}\n onClick={() => toggleEntityType(type)}\n aria-label={t(`entityLinks.entityTypes.${type}`)}\n aria-pressed={isSelected}\n >\n {formatEntityType(type)}\n </Button>\n );\n })}\n </div>\n </ScrollArea>\n </div>\n\n {/* Search results */}\n <ScrollArea className=\"flex-1 overflow-auto\">\n <div className=\"px-4 py-3 sm:px-6 sm:py-4\">\n {/* Loading state */}\n {isLoading && (\n <div className=\"flex items-center justify-center py-8\">\n <Loader2 className=\"h-8 w-8 animate-spin text-slate-400\" />\n <span className={cn(\n 'text-sm text-slate-500',\n isRTL ? 'me-3' : 'ms-3'\n )}>\n {t('common.loading')}\n </span>\n </div>\n )}\n\n {/* Error state */}\n {error && (\n <div className=\"text-center py-8\">\n <p className=\"text-sm text-red-600\">\n {t('entityLinks.searchError')}\n </p>\n </div>\n )}\n\n {/* Empty state - no query yet */}\n {!isLoading && !error && query.length < 2 && (\n <div className=\"text-center py-12\">\n <div className=\"inline-flex items-center justify-center w-16 h-16 rounded-full bg-blue-100 dark:bg-blue-900/30 mb-4\">\n <Search className=\"h-8 w-8 text-blue-600 dark:text-blue-400\" />\n </div>\n <h3 className=\"text-base font-semibold text-slate-900 dark:text-slate-100 mb-2\">\n {t('entityLinks.searchTitle', 'Find and link entities')}\n </h3>\n <p className=\"text-sm text-slate-600 dark:text-slate-400 max-w-sm mx-auto\">\n {t('entityLinks.searchEmptyState', 'Enter at least 2 characters to search for dossiers, positions, countries, and more')}\n </p>\n </div>\n )}\n\n {/* No results state */}\n {!isLoading && !error && query.length >= 2 && results?.length === 0 && (\n <div className=\"text-center py-12\">\n <div className=\"inline-flex items-center justify-center w-16 h-16 rounded-full bg-slate-100 dark:bg-slate-800 mb-4\">\n <Search className=\"h-8 w-8 text-slate-400\" />\n </div>\n <h3 className=\"text-base font-semibold text-slate-900 dark:text-slate-100 mb-2\">\n {t('entityLinks.noResultsTitle', 'No entities found')}\n </h3>\n <p className=\"text-sm text-slate-600 dark:text-slate-400 max-w-sm mx-auto mb-4\">\n {t('entityLinks.noResults', `No entities match \"${query}\"`)}\n </p>\n <div className=\"text-xs text-slate-500 dark:text-slate-400 space-y-1\">\n <p>{t('entityLinks.searchTips', 'Try:')}</p>\n <ul className=\"list-disc list-inside space-y-0.5\">\n <li>{t('entityLinks.tip1', 'Using fewer or different keywords')}</li>\n <li>{t('entityLinks.tip2', 'Checking your spelling')}</li>\n <li>{t('entityLinks.tip3', 'Clearing filters to search all entity types')}</li>\n </ul>\n </div>\n </div>\n )}\n\n {/* Results list */}\n {!isLoading && !error && results && results.length > 0 && (\n <div className=\"space-y-2\">\n {results.map((entity) => {\n const entityKey = `${entity.entity_type}-${entity.entity_id}`;\n const isAlreadyLinked = linkedEntityIds.has(entityKey);\n const isSelected = selectedEntities.some(\n (e) => `${e.entity_type}-${e.entity_id}` === entityKey\n );\n\n return (\n <div\n key={entityKey}\n className={cn(\n 'w-full',\n 'min-h-16 sm:min-h-14', // Touch-friendly\n 'px-3 py-2 sm:px-4 sm:py-3',\n 'border rounded-lg',\n 'transition-all duration-200',\n !isAlreadyLinked && 'hover:bg-slate-50 dark:hover:bg-slate-800 cursor-pointer',\n isSelected && 'bg-blue-50 dark:bg-blue-900/20 border-blue-300 dark:border-blue-700',\n isAlreadyLinked && 'bg-slate-50 dark:bg-slate-800 opacity-60 cursor-not-allowed',\n\n // RTL support\n 'text-start',\n isRTL && 'text-end'\n )}\n onClick={() => !isAlreadyLinked && handleToggleSelect(entity)}\n role=\"checkbox\"\n aria-checked={isSelected}\n aria-disabled={isAlreadyLinked}\n aria-label={t('entityLinks.selectEntity', { name: entity.name })}\n tabIndex={isAlreadyLinked ? -1 : 0}\n onKeyDown={(e) => {\n if (!isAlreadyLinked && (e.key === 'Enter' || e.key === ' ')) {\n e.preventDefault();\n handleToggleSelect(entity);\n }\n }}\n >\n <div className={cn(\n 'flex items-start gap-3',\n isRTL && 'flex-row-reverse'\n )}>\n {/* Checkbox */}\n {!isAlreadyLinked && (\n <Checkbox\n checked={isSelected}\n onCheckedChange={() => handleToggleSelect(entity)}\n className=\"mt-1\"\n aria-hidden=\"true\" // Handled by parent div\n />\n )}\n {isAlreadyLinked && (\n <CheckCircle2 className=\"h-5 w-5 text-green-600 dark:text-green-400 mt-1 flex-shrink-0\" />\n )}\n\n {/* Primary radio button (only for dossier/position if selected) */}\n {!isAlreadyLinked && isSelected && (entity.entity_type === 'dossier' || entity.entity_type === 'position') && (\n <button\n onClick={(e) => {\n e.stopPropagation();\n setPrimaryEntityKey(entityKey);\n }}\n className={cn(\n 'flex items-center gap-1.5',\n 'px-2 py-1 rounded text-xs',\n 'transition-colors duration-200',\n 'touch-manipulation',\n primaryEntityKey === entityKey\n ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 border border-green-300 dark:border-green-700'\n : 'bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 border border-slate-300 dark:border-slate-700 hover:bg-slate-200 dark:hover:bg-slate-700'\n )}\n aria-label={t('entityLinks.setPrimary')}\n >\n <div className={cn(\n 'w-3 h-3 rounded-full border-2 flex items-center justify-center',\n primaryEntityKey === entityKey\n ? 'border-green-600 dark:border-green-400'\n : 'border-slate-400'\n )}>\n {primaryEntityKey === entityKey && (\n <div className=\"w-1.5 h-1.5 rounded-full bg-green-600 dark:bg-green-400\" />\n )}\n </div>\n <span className=\"font-medium\">\n {primaryEntityKey === entityKey ? t('entityLinks.primary') : t('entityLinks.setPrimary')}\n </span>\n </button>\n )}\n\n {/* Entity info */}\n <div className=\"flex-1 min-w-0 space-y-1\">\n {/* Entity name */}\n <div className={cn(\n 'flex items-center gap-2 flex-wrap',\n isRTL && 'flex-row-reverse'\n )}>\n <h4 className={cn(\n 'text-sm sm:text-base font-semibold',\n 'truncate flex-1 min-w-0',\n 'text-start'\n )}>\n {entity.name}\n </h4>\n {/* Entity type badge */}\n <Badge\n variant=\"outline\"\n className={cn(\n \"flex-shrink-0 text-xs\",\n \"bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 border-blue-200 dark:border-blue-800\"\n )}\n >\n {formatEntityType(entity.entity_type)}\n </Badge>\n {/* Already linked badge */}\n {isAlreadyLinked && (\n <Badge\n variant=\"outline\"\n className={cn(\n \"flex-shrink-0 text-xs\",\n \"bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300 border-green-200 dark:border-green-800\"\n )}\n >\n {t('entityLinks.alreadyLinked', 'Already linked')}\n </Badge>\n )}\n </div>\n\n {/* Description (if available) */}\n {entity.description && (\n <p className={cn(\n 'text-xs text-slate-600 dark:text-slate-400',\n 'line-clamp-2',\n 'text-start'\n )}>\n {entity.description}\n </p>\n )}\n\n {/* Metadata row */}\n <div className={cn(\n 'flex items-center gap-3 text-xs text-slate-500 dark:text-slate-400',\n isRTL && 'flex-row-reverse'\n )}>\n {/* AI confidence score (if available) */}\n {entity.similarity_score !== undefined && (\n <span className=\"flex items-center gap-1\">\n <span className=\"font-medium\">Match:</span>\n <span className={cn(\n \"font-semibold\",\n entity.similarity_score > 0.7 ? \"text-green-600 dark:text-green-400\" :\n entity.similarity_score > 0.4 ? \"text-yellow-600 dark:text-yellow-400\" :\n \"text-slate-500\"\n )}>\n {Math.round(entity.similarity_score * 100)}%\n </span>\n </span>\n )}\n\n {/* Classification level (if available) */}\n {entity.classification_level !== undefined && (\n <span className=\"flex items-center gap-1\">\n <span className=\"font-medium\">Level:</span>\n <span>{entity.classification_level}</span>\n </span>\n )}\n\n {/* Last linked date (if available) */}\n {entity.last_linked_at && (\n <span className=\"flex items-center gap-1\">\n <span className=\"font-medium\">Last used:</span>\n <span>{new Date(entity.last_linked_at).toLocaleDateString()}</span>\n </span>\n )}\n </div>\n </div>\n </div>\n </div>\n );\n })}\n </div>\n )}\n </div>\n </ScrollArea>\n\n {/* Footer with selected count and submit button */}\n {selectedEntities.length > 0 && (\n <div className={cn(\n 'px-4 py-3 sm:px-6 sm:py-4',\n 'border-t bg-slate-50/50 dark:bg-slate-900/20',\n 'space-y-2'\n )}>\n {/* Warning message when replacing primary */}\n {willReplacePrimary && existingPrimaryLink && (\n <div className={cn(\n 'flex items-start gap-2 p-2 sm:p-3',\n 'bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg',\n isRTL && 'flex-row-reverse'\n )}>\n <div className=\"flex-shrink-0 mt-0.5\">\n <svg className=\"h-4 w-4 sm:h-5 sm:w-5 text-amber-600 dark:text-amber-400\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n </svg>\n </div>\n <div className=\"flex-1 min-w-0\">\n <p className={cn(\n 'text-xs sm:text-sm text-amber-800 dark:text-amber-200',\n 'text-start'\n )}>\n {t('entityLinks.replacePrimaryWarning', {\n defaultValue: `This will replace the existing primary link (${(existingPrimaryLink as any).entity_name || existingPrimaryLink.entity_id})`,\n currentPrimary: (existingPrimaryLink as any).entity_name || existingPrimaryLink.entity_id\n })}\n </p>\n </div>\n </div>\n )}\n\n {/* Selected count and submit button */}\n <div className={cn(\n 'flex items-center justify-between gap-4',\n isRTL && 'flex-row-reverse'\n )}>\n <span className={cn(\n 'text-sm font-medium text-slate-700 dark:text-slate-300',\n 'text-start'\n )}>\n {t('entityLinks.selectedCount', {\n count: selectedEntities.length,\n defaultValue: `${selectedEntities.length} selected`,\n })}\n </span>\n <Button\n onClick={handleSubmit}\n className={cn(\n 'min-h-11 px-4 sm:px-6',\n 'text-sm sm:text-base',\n 'touch-manipulation'\n )}\n >\n {t('entityLinks.linkSelected', {\n count: selectedEntities.length,\n defaultValue: `Link ${selectedEntities.length} ${selectedEntities.length === 1 ? 'entity' : 'entities'}`,\n })}\n </Button>\n </div>\n </div>\n )}\n </div>\n </DialogContent>\n </Dialog>\n );\n}\n\nexport default EntitySearchDialog;\n","/**\n * Link Type Badge Component\n * Feature: 024-intake-entity-linking\n * Task: T045\n *\n * Mobile-first, RTL-compatible badge for displaying link types\n * Follows mobile-first design principles with logical CSS properties\n */\n\nimport { Badge } from '@/components/ui/badge';\nimport { useTranslation } from 'react-i18next';\nimport { cn } from '@/lib/utils';\nimport type { EntityLink } from '../../../../backend/src/types/intake-entity-links.types';\n\n/**\n * Link type configuration with colors and icons\n */\nconst LINK_TYPE_CONFIG = {\n primary: {\n variant: 'default' as const,\n colorClass: 'bg-blue-600 hover:bg-blue-700 text-white',\n icon: '',\n },\n related: {\n variant: 'secondary' as const,\n colorClass: 'bg-slate-600 hover:bg-slate-700 text-white',\n icon: '',\n },\n requested: {\n variant: 'outline' as const,\n colorClass: 'bg-purple-100 hover:bg-purple-200 text-purple-800 border-purple-300',\n icon: '',\n },\n mentioned: {\n variant: 'outline' as const,\n colorClass: 'bg-amber-100 hover:bg-amber-200 text-amber-800 border-amber-300',\n icon: '',\n },\n assigned_to: {\n variant: 'outline' as const,\n colorClass: 'bg-green-100 hover:bg-green-200 text-green-800 border-green-300',\n icon: '',\n },\n} as const;\n\nexport interface LinkTypeBadgeProps {\n /** Link type to display */\n linkType: EntityLink['link_type'];\n /** Show icon alongside text (default: true on desktop, false on mobile) */\n showIcon?: boolean;\n /** Additional CSS classes */\n className?: string;\n /** Size variant */\n size?: 'sm' | 'default' | 'lg';\n}\n\n/**\n * LinkTypeBadge Component\n *\n * Displays a visually distinct badge for entity link types.\n * Supports mobile-first responsive design and RTL layouts.\n *\n * @example\n * ```tsx\n * <LinkTypeBadge linkType=\"primary\" />\n * <LinkTypeBadge linkType=\"related\" showIcon={true} size=\"lg\" />\n * ```\n */\nexport function LinkTypeBadge({\n linkType,\n showIcon,\n className,\n size = 'default',\n}: LinkTypeBadgeProps) {\n const { t, i18n } = useTranslation();\n const isRTL = i18n.language === 'ar';\n\n const config = LINK_TYPE_CONFIG[linkType] || LINK_TYPE_CONFIG.related;\n\n // Determine if icon should be shown (default: desktop only for space optimization)\n const displayIcon = showIcon ?? false; // Hidden by default on mobile, can be overridden\n\n // Size-specific classes using mobile-first approach\n const sizeClasses = {\n sm: 'text-xs px-2 py-0.5 gap-1',\n default: 'text-sm px-3 py-1 gap-1.5 sm:gap-2',\n lg: 'text-base px-4 py-1.5 gap-2 sm:gap-2.5',\n };\n\n // Translation key for link type\n const translationKey = `entityLinks.linkTypes.${linkType}`;\n\n return (\n <Badge\n variant={config.variant}\n className={cn(\n // Base styles (mobile-first)\n 'inline-flex items-center justify-center',\n 'font-medium',\n 'transition-colors duration-200',\n\n // Size-specific spacing and typography\n sizeClasses[size],\n\n // Color classes\n config.colorClass,\n\n // RTL support: reverse flex direction if needed\n isRTL && displayIcon && 'flex-row-reverse',\n\n // Custom classes\n className\n )}\n // Accessibility\n aria-label={t(translationKey)}\n role=\"status\"\n >\n {/* Icon (conditionally rendered) */}\n {displayIcon && (\n <span\n className=\"inline-block\"\n aria-hidden=\"true\"\n >\n {config.icon}\n </span>\n )}\n\n {/* Link type text */}\n <span className=\"inline-block whitespace-nowrap\">\n {t(translationKey)}\n </span>\n </Badge>\n );\n}\n\n/**\n * Helper function to get link type label for non-component contexts\n */\nexport function getLinkTypeLabel(\n linkType: EntityLink['link_type'],\n t: (key: string) => string\n): string {\n return t(`entityLinks.linkTypes.${linkType}`);\n}\n\n/**\n * Helper to get link type icon\n */\nexport function getLinkTypeIcon(linkType: EntityLink['link_type']): string {\n return LINK_TYPE_CONFIG[linkType]?.icon || LINK_TYPE_CONFIG.related.icon;\n}\n\n/**\n * Helper to get link type color class\n */\nexport function getLinkTypeColorClass(linkType: EntityLink['link_type']): string {\n return LINK_TYPE_CONFIG[linkType]?.colorClass || LINK_TYPE_CONFIG.related.colorClass;\n}\n\nexport default LinkTypeBadge;\n","/**\n * Link Card Component\n * Feature: 024-intake-entity-linking\n * Task: T046\n *\n * Mobile-first, RTL-compatible card for displaying entity links\n * with 44x44px touch targets and inline note editing\n */\n\nimport { useState } from 'react';\nimport { useTranslation } from 'react-i18next';\nimport { Trash2, RotateCcw, Edit2, Check, X, GripVertical } from 'lucide-react';\nimport { Card, CardContent, CardHeader } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Textarea } from '@/components/ui/textarea';\nimport { LinkTypeBadge } from './LinkTypeBadge';\nimport { cn } from '@/lib/utils';\nimport {\n AlertDialog,\n AlertDialogAction,\n AlertDialogCancel,\n AlertDialogContent,\n AlertDialogDescription,\n AlertDialogFooter,\n AlertDialogHeader,\n AlertDialogTitle,\n} from '@/components/ui/alert-dialog';\nimport type { EntityLink } from '../../../../backend/src/types/intake-entity-links.types';\n\nexport interface LinkCardProps {\n /** Entity link data */\n link: EntityLink;\n /** Whether the link is deleted (soft delete) */\n isDeleted?: boolean;\n /** Whether user can restore deleted links (steward+ role) */\n canRestore?: boolean;\n /** Whether drag-and-drop is enabled */\n isDraggable?: boolean;\n /** Callback when delete is requested */\n onDelete?: (linkId: string) => void;\n /** Callback when restore is requested */\n onRestore?: (linkId: string) => void;\n /** Callback when notes are updated */\n onUpdateNotes?: (linkId: string, notes: string) => void;\n /** Additional CSS classes */\n className?: string;\n}\n\n/**\n * LinkCard Component\n *\n * Displays an individual entity link with actions.\n * Supports mobile-first responsive design, RTL layouts, and touch interactions.\n *\n * @example\n * ```tsx\n * <LinkCard\n * link={entityLink}\n * onDelete={(id) => deleteMutation.mutate(id)}\n * onUpdateNotes={(id, notes) => updateMutation.mutate({ notes })}\n * />\n * ```\n */\nexport function LinkCard({\n link,\n isDeleted = false,\n canRestore = false,\n isDraggable = false,\n onDelete,\n onRestore,\n onUpdateNotes,\n className,\n}: LinkCardProps) {\n const { t, i18n } = useTranslation();\n const isRTL = i18n.language === 'ar';\n\n const [isEditing, setIsEditing] = useState(false);\n const [notesValue, setNotesValue] = useState(link.notes || '');\n const [showDeleteDialog, setShowDeleteDialog] = useState(false);\n\n // Handle save notes\n const handleSaveNotes = () => {\n if (onUpdateNotes && notesValue !== link.notes) {\n onUpdateNotes(link.id, notesValue);\n }\n setIsEditing(false);\n };\n\n // Handle cancel edit\n const handleCancelEdit = () => {\n setNotesValue(link.notes || '');\n setIsEditing(false);\n };\n\n // Handle delete confirmation\n const handleDelete = () => {\n if (onDelete) {\n onDelete(link.id);\n }\n setShowDeleteDialog(false);\n };\n\n return (\n <>\n <Card\n className={cn(\n // Base styles (mobile-first)\n 'w-full',\n 'transition-all duration-200',\n\n // Deleted state styling\n isDeleted && 'opacity-60 bg-slate-50 dark:bg-slate-900',\n\n // Hover effects (desktop only)\n !isDeleted && 'hover:shadow-md',\n\n // Custom classes\n className\n )}\n // Accessibility\n role=\"article\"\n aria-label={t('entityLinks.linkCard', { entity: link.entity_id })}\n >\n <CardHeader\n className={cn(\n // Mobile-first padding\n 'px-3 py-3 sm:px-4 sm:py-4',\n 'flex flex-row items-center gap-2 sm:gap-3',\n\n // RTL support\n isRTL && 'flex-row-reverse'\n )}\n >\n {/* Drag handle (if draggable) - 44x44px touch target */}\n {isDraggable && !isDeleted && (\n <button\n className={cn(\n 'flex items-center justify-center',\n 'min-h-11 min-w-11', // 44px minimum touch target\n 'touch-manipulation', // Optimize for touch\n 'cursor-grab active:cursor-grabbing',\n 'text-slate-400 hover:text-slate-600',\n 'transition-colors duration-200',\n '-my-2', // Compensate for card padding\n\n // RTL support\n isRTL ? '-me-1' : '-ms-1'\n )}\n aria-label={t('entityLinks.dragHandle')}\n // Drag handle functionality will be added by parent (LinkList)\n >\n <GripVertical className=\"h-5 w-5\" />\n </button>\n )}\n\n {/* Entity info */}\n <div className=\"flex-1 min-w-0\">\n {/* First line: Entity name (full width for more space) */}\n <h3\n className={cn(\n 'text-sm sm:text-base font-medium',\n 'truncate',\n 'text-start',\n 'mb-1',\n isDeleted && 'line-through'\n )}\n >\n {/* Display entity name from enriched link data */}\n {(link as any).entity_name || link.entity_id}\n </h3>\n\n {/* Second line: Badge + Entity type (same line, same size) */}\n <div className={cn(\n 'flex items-center gap-2',\n isRTL && 'flex-row-reverse'\n )}>\n <LinkTypeBadge\n linkType={link.link_type}\n size=\"sm\"\n />\n <p className={cn(\n 'text-xs sm:text-sm text-slate-500 dark:text-slate-400',\n 'text-start'\n )}>\n {t(`entityLinks.entityTypes.${link.entity_type}`)}\n </p>\n </div>\n </div>\n\n {/* Action buttons - 44x44px touch targets */}\n <div className={cn(\n 'flex items-center gap-1 sm:gap-2',\n\n // RTL support\n isRTL && 'flex-row-reverse'\n )}>\n {!isDeleted && (\n <>\n {/* Edit notes button */}\n {onUpdateNotes && (\n <Button\n variant=\"ghost\"\n size=\"icon\"\n className={cn(\n 'min-h-11 min-w-11', // 44px touch target\n 'touch-manipulation'\n )}\n onClick={() => setIsEditing(!isEditing)}\n aria-label={t('entityLinks.editNotes')}\n >\n <Edit2 className=\"h-4 w-4 sm:h-5 sm:w-5\" />\n </Button>\n )}\n\n {/* Delete button */}\n {onDelete && (\n <Button\n variant=\"ghost\"\n size=\"icon\"\n className={cn(\n 'min-h-11 min-w-11', // 44px touch target\n 'touch-manipulation',\n 'text-red-600 hover:text-red-700 hover:bg-red-50'\n )}\n onClick={() => setShowDeleteDialog(true)}\n aria-label={t('entityLinks.deleteLink')}\n >\n <Trash2 className=\"h-4 w-4 sm:h-5 sm:w-5\" />\n </Button>\n )}\n </>\n )}\n\n {/* Restore button (deleted links, steward+ only) */}\n {isDeleted && canRestore && onRestore && (\n <Button\n variant=\"outline\"\n size=\"sm\"\n className={cn(\n 'min-h-11 px-3 sm:px-4', // 44px height touch target\n 'touch-manipulation',\n 'text-blue-600 border-blue-300 hover:bg-blue-50'\n )}\n onClick={() => onRestore(link.id)}\n aria-label={t('entityLinks.restoreLink')}\n >\n <RotateCcw className={cn(\n 'h-4 w-4',\n isRTL ? 'ms-2' : 'me-2'\n )} />\n <span className=\"text-xs sm:text-sm\">\n {t('entityLinks.restore')}\n </span>\n </Button>\n )}\n </div>\n </CardHeader>\n\n {/* Notes section (always visible or editable) */}\n {(link.notes || isEditing) && (\n <CardContent className={cn(\n 'px-3 py-0 pb-3 sm:px-4 sm:pb-4',\n 'pt-0'\n )}>\n {isEditing ? (\n <div className=\"space-y-2\">\n <Textarea\n value={notesValue}\n onChange={(e) => setNotesValue(e.target.value)}\n placeholder={t('entityLinks.notesPlaceholder')}\n className={cn(\n 'text-sm resize-none',\n 'min-h-20 sm:min-h-24',\n 'text-start',\n isRTL && 'text-end'\n )}\n maxLength={1000}\n dir={isRTL ? 'rtl' : 'ltr'}\n aria-label={t('entityLinks.notesInput')}\n />\n\n {/* Character count */}\n <div className={cn(\n 'flex items-center justify-between gap-2',\n 'text-xs text-slate-500',\n isRTL && 'flex-row-reverse'\n )}>\n <span className=\"text-start\">\n {notesValue.length}/1000\n </span>\n\n {/* Save/Cancel buttons - 44px touch targets */}\n <div className={cn(\n 'flex gap-2',\n isRTL && 'flex-row-reverse'\n )}>\n <Button\n variant=\"ghost\"\n size=\"sm\"\n className={cn(\n 'min-h-11 px-3', // 44px touch target\n 'touch-manipulation'\n )}\n onClick={handleCancelEdit}\n aria-label={t('common.cancel')}\n >\n <X className={cn(\n 'h-4 w-4',\n isRTL ? 'ms-1' : 'me-1'\n )} />\n <span className=\"text-xs sm:text-sm\">\n {t('common.cancel')}\n </span>\n </Button>\n\n <Button\n variant=\"default\"\n size=\"sm\"\n className={cn(\n 'min-h-11 px-3', // 44px touch target\n 'touch-manipulation'\n )}\n onClick={handleSaveNotes}\n aria-label={t('common.save')}\n >\n <Check className={cn(\n 'h-4 w-4',\n isRTL ? 'ms-1' : 'me-1'\n )} />\n <span className=\"text-xs sm:text-sm\">\n {t('common.save')}\n </span>\n </Button>\n </div>\n </div>\n </div>\n ) : (\n <p className={cn(\n 'text-sm text-slate-600 dark:text-slate-300',\n 'whitespace-pre-wrap',\n 'text-start',\n isRTL && 'text-end'\n )}>\n {link.notes}\n </p>\n )}\n </CardContent>\n )}\n </Card>\n\n {/* Delete confirmation dialog */}\n <AlertDialog open={showDeleteDialog} onOpenChange={setShowDeleteDialog}>\n <AlertDialogContent className={cn(\n 'max-w-md mx-4 sm:mx-auto',\n isRTL && 'text-end'\n )}>\n <AlertDialogHeader>\n <AlertDialogTitle className=\"text-start\">\n {t('entityLinks.deleteConfirmTitle')}\n </AlertDialogTitle>\n <AlertDialogDescription className=\"text-start\">\n {t('entityLinks.deleteConfirmDescription')}\n </AlertDialogDescription>\n </AlertDialogHeader>\n <AlertDialogFooter className={cn(\n isRTL && 'flex-row-reverse'\n )}>\n <AlertDialogCancel className=\" touch-manipulation\">\n {t('common.cancel')}\n </AlertDialogCancel>\n <AlertDialogAction\n className=\" touch-manipulation bg-red-600 hover:bg-red-700\"\n onClick={handleDelete}\n >\n {t('common.delete')}\n </AlertDialogAction>\n </AlertDialogFooter>\n </AlertDialogContent>\n </AlertDialog>\n </>\n );\n}\n\nexport default LinkCard;\n","/**\n * Link List Component\n * Feature: 024-intake-entity-linking\n * Task: T048\n *\n * Mobile-first list of entity links with drag-and-drop reordering\n * Vertical stacking on mobile, optimized for touch interactions\n */\n\nimport { useCallback } from 'react';\nimport { useTranslation } from 'react-i18next';\nimport { cn } from '@/lib/utils';\nimport { LinkCard } from './LinkCard';\nimport { useReorderEntityLinks } from '@/hooks/use-entity-links';\nimport type { EntityLink } from '../../../../backend/src/types/intake-entity-links.types';\n\nexport interface LinkListProps {\n /** Intake ID for this list */\n intakeId: string;\n /** Array of entity links to display */\n links: EntityLink[];\n /** Whether the list shows deleted links */\n showDeleted?: boolean;\n /** Whether user can restore deleted links (steward+ role) */\n canRestore?: boolean;\n /** Enable drag-and-drop reordering */\n enableReorder?: boolean;\n /** Callback when delete is requested */\n onDelete?: (linkId: string) => void;\n /** Callback when restore is requested */\n onRestore?: (linkId: string) => void;\n /** Callback when notes are updated */\n onUpdateNotes?: (linkId: string, notes: string) => void;\n /** Additional CSS classes */\n className?: string;\n}\n\n/**\n * LinkList Component\n *\n * Displays a vertical list of entity links with optional drag-and-drop reordering.\n * Optimized for mobile-first design with touch-friendly interactions.\n *\n * @example\n * ```tsx\n * <LinkList\n * intakeId={intakeId}\n * links={links}\n * enableReorder={true}\n * onDelete={(id) => deleteMutation.mutate(id)}\n * onUpdateNotes={(id, notes) => updateMutation.mutate({ notes })}\n * />\n * ```\n */\nexport function LinkList({\n intakeId,\n links,\n showDeleted = false,\n canRestore = false,\n enableReorder = false,\n onDelete,\n onRestore,\n onUpdateNotes,\n className,\n}: LinkListProps) {\n const { t, i18n } = useTranslation();\n const isRTL = i18n.language === 'ar';\n\n const reorderMutation = useReorderEntityLinks(intakeId);\n\n // Filter links based on showDeleted flag\n const filteredLinks = showDeleted\n ? links.filter((link) => link.deleted_at !== null)\n : links.filter((link) => link.deleted_at === null);\n\n // Sort links by link_order\n const sortedLinks = [...filteredLinks].sort((a, b) => a.link_order - b.link_order);\n\n // Handle drag start (basic implementation - full @dnd-kit implementation in T116)\n const handleDragStart = useCallback((e: React.DragEvent<HTMLDivElement>, linkId: string) => {\n e.dataTransfer.effectAllowed = 'move';\n e.dataTransfer.setData('text/plain', linkId);\n }, []);\n\n // Handle drag over\n const handleDragOver = useCallback((e: React.DragEvent<HTMLDivElement>) => {\n e.preventDefault();\n e.dataTransfer.dropEffect = 'move';\n }, []);\n\n // Handle drop (basic implementation - full @dnd-kit implementation in T116)\n const handleDrop = useCallback(\n (e: React.DragEvent<HTMLDivElement>, targetLinkId: string) => {\n e.preventDefault();\n const draggedLinkId = e.dataTransfer.getData('text/plain');\n\n if (draggedLinkId === targetLinkId) return;\n\n const draggedIndex = sortedLinks.findIndex((link) => link.id === draggedLinkId);\n const targetIndex = sortedLinks.findIndex((link) => link.id === targetLinkId);\n\n if (draggedIndex === -1 || targetIndex === -1) return;\n\n // Create new order array\n const newLinks = [...sortedLinks];\n const [draggedLink] = newLinks.splice(draggedIndex, 1);\n newLinks.splice(targetIndex, 0, draggedLink);\n\n // Update link orders\n const linkOrders = newLinks.map((link, index) => ({\n link_id: link.id,\n link_order: index + 1,\n }));\n\n // Call mutation\n reorderMutation.mutate(linkOrders);\n },\n [sortedLinks, reorderMutation]\n );\n\n // Empty state\n if (sortedLinks.length === 0) {\n return (\n <div className={cn(\n 'text-center py-8 sm:py-12',\n className\n )}>\n <p className=\"text-sm sm:text-base text-slate-500\">\n {showDeleted\n ? t('entityLinks.noDeletedLinks')\n : t('entityLinks.noLinks')}\n </p>\n </div>\n );\n }\n\n return (\n <div\n className={cn(\n // Mobile-first vertical stacking with gap\n 'flex flex-col gap-3 sm:gap-4',\n 'w-full',\n className\n )}\n role=\"list\"\n aria-label={t('entityLinks.linkList')}\n >\n {sortedLinks.map((link) => (\n <div\n key={link.id}\n draggable={enableReorder && !showDeleted}\n onDragStart={(e) => enableReorder && handleDragStart(e, link.id)}\n onDragOver={enableReorder ? handleDragOver : undefined}\n onDrop={(e) => enableReorder && handleDrop(e, link.id)}\n className={cn(\n enableReorder && !showDeleted && 'cursor-move'\n )}\n role=\"listitem\"\n >\n <LinkCard\n link={link}\n isDeleted={showDeleted}\n canRestore={canRestore}\n isDraggable={enableReorder && !showDeleted}\n onDelete={onDelete}\n onRestore={onRestore}\n onUpdateNotes={onUpdateNotes}\n />\n </div>\n ))}\n\n {/* Reordering hint */}\n {enableReorder && !showDeleted && sortedLinks.length > 1 && (\n <p className={cn(\n 'text-xs text-slate-500 text-center',\n 'mt-2',\n 'hidden sm:block' // Only show on desktop\n )}>\n {t('entityLinks.reorderHint')}\n </p>\n )}\n </div>\n );\n}\n\nexport default LinkList;\n","/**\n * AI Suggestions Hook\n *\n * TanStack Query hook for AI-powered entity link suggestions.\n * Implements graceful degradation when AI service is unavailable.\n *\n * Performance targets:\n * - AI suggestions: <3 seconds for 3-5 recommendations (SC-002)\n * - Loading states: Show 2-3 second loading indicator\n * - Timeout: 3 seconds before showing fallback UI\n *\n * @module frontend/src/hooks/use-ai-suggestions\n */\n\nimport { useMutation, useQuery, useQueryClient } from '@tanstack/react-query'\nimport { useTranslation } from 'react-i18next'\nimport type {\n  AILinkSuggestion,\n  GenerateSuggestionsRequest,\n  GenerateSuggestionsResponse,\n  AcceptSuggestionRequest,\n  AcceptSuggestionResponse,\n} from '../types/ai-suggestions.types'\nimport { intakeEntityLinksAPI } from '../services/entity-links-api'\n\n/**\n * Hook for generating AI suggestions\n *\n * Usage:\n * ```tsx\n * const { data, isLoading, error, refetch } = useAISuggestions(intakeId, {\n *   entity_types: ['dossier', 'position'],\n *   enabled: true // Only fetch when user clicks \"Get AI Suggestions\"\n * });\n * ```\n *\n * Graceful degradation:\n * - If AI service returns 503, `error.fallback === 'manual_search'`\n * - Frontend shows manual search dialog as fallback\n * - Retry button available after cooldown period\n *\n * @param intakeId - Intake ticket ID\n * @param options - Query options (entity types, enabled flag)\n * @returns TanStack Query result with suggestions\n */\nexport function useAISuggestions(\n  intakeId: string,\n  options: {\n    entity_types?: string[]\n    max_suggestions?: number\n    enabled?: boolean\n  } = {},\n) {\n  const { t } = useTranslation()\n\n  return useQuery({\n    queryKey: ['ai-suggestions', intakeId, options.entity_types],\n    queryFn: async () => {\n      const request: GenerateSuggestionsRequest = {\n        entity_types: options.entity_types || ['dossier', 'position', 'organization', 'country'],\n        max_suggestions: options.max_suggestions || 5,\n      }\n\n      const response = await intakeEntityLinksAPI.ai.generateSuggestions(intakeId, request)\n      return response\n    },\n    enabled: options.enabled !== false, // Default to enabled\n    staleTime: 60 * 1000, // 1 minute (matches Redis cache TTL)\n    gcTime: 5 * 60 * 1000, // 5 minutes\n    retry: (failureCount, error: any) => {\n      // Don't retry if AI service is unavailable (503)\n      if (error.status === 503) return false\n\n      // Don't retry if rate limited (429)\n      if (error.status === 429) return false\n\n      // Retry up to 2 times for other errors\n      return failureCount < 2\n    },\n    retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 5000),\n    meta: {\n      errorMessage: t('entityLinks.aiSuggestions.error', 'Failed to generate AI suggestions'),\n    },\n  })\n}\n\n/**\n * Hook for accepting AI suggestion and creating link\n *\n * Usage:\n * ```tsx\n * const acceptMutation = useAcceptAISuggestion(intakeId);\n *\n * const handleAccept = (suggestion: AILinkSuggestion) => {\n *   acceptMutation.mutate({\n *     suggestion_id: suggestion.suggestion_id,\n *     entity_id: suggestion.entity_id,\n *     entity_type: suggestion.entity_type,\n *     link_type: suggestion.suggested_link_type\n *   });\n * };\n * ```\n *\n * @param intakeId - Intake ticket ID\n * @returns TanStack Query mutation for accepting suggestion\n */\nexport function useAcceptAISuggestion(intakeId: string) {\n  const queryClient = useQueryClient()\n  const { t } = useTranslation()\n\n  return useMutation({\n    mutationFn: async (request: AcceptSuggestionRequest) => {\n      return await intakeEntityLinksAPI.ai.acceptSuggestion(intakeId, request)\n    },\n    onSuccess: (data, variables) => {\n      // Invalidate entity links query to show new link\n      queryClient.invalidateQueries({ queryKey: ['entity-links', intakeId] })\n\n      // Invalidate AI suggestions query to update acceptance status\n      queryClient.invalidateQueries({ queryKey: ['ai-suggestions', intakeId] })\n\n      // Show success toast (handled by caller)\n    },\n    onError: (_error: any) => {\n      // Error handling in component (show toast)\n    },\n    meta: {\n      successMessage: t(\n        'entityLinks.aiSuggestions.accepted',\n        'AI suggestion accepted and link created',\n      ),\n      errorMessage: t('entityLinks.aiSuggestions.acceptError', 'Failed to accept suggestion'),\n    },\n  })\n}\n\n/**\n * Hook for tracking AI suggestion analytics\n *\n * Tracks:\n * - Suggestion generation requests\n * - Acceptance rate (for SC-005: 90% target)\n * - Time to accept (for user experience metrics)\n * - Fallback to manual search rate\n *\n * @param intakeId - Intake ticket ID\n * @returns Analytics tracking functions\n */\nexport function useAISuggestionAnalytics(_intakeId: string) {\n  const trackSuggestionGenerated = (_suggestionCount: number, _cacheHit: boolean) => {\n    // Send to analytics service (e.g., PostHog, Mixpanel)\n  }\n\n  const trackSuggestionAccepted = (\n    _suggestionId: string,\n    _rank: number,\n    _confidenceScore: number,\n    _timeToAccept: number,\n  ) => {\n    // Track AI suggestion acceptance\n  }\n\n  const trackFallbackToManualSearch = (_reason: string) => {\n    // Track fallback to manual search\n  }\n\n  return {\n    trackSuggestionGenerated,\n    trackSuggestionAccepted,\n    trackFallbackToManualSearch,\n  }\n}\n","/**\n * AI Suggestion Panel Component\n *\n * Displays AI-powered entity link suggestions with confidence scores and reasoning.\n * Implements mobile-first responsive design and RTL support.\n *\n * Features:\n * - Loading state with 2-3 second indicator (SC-002)\n * - Graceful degradation when AI service unavailable\n * - Confidence score visualization\n * - One-click acceptance\n * - Fallback to manual search\n *\n * Mobile-first breakpoints:\n * - Base (320px+): Vertical stacking, full-width cards\n * - sm (640px+): Grid layout with 2 columns\n * - lg (1024px+): Grid layout with 3 columns\n *\n * @module frontend/src/components/entity-links/AISuggestionPanel\n */\n\nimport React, { useState, useEffect } from 'react'\nimport { useTranslation } from 'react-i18next'\nimport { Sparkles, AlertCircle, Search, RefreshCw, CheckCircle2 } from 'lucide-react'\nimport { Button } from '../ui/button'\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '../ui/card'\nimport { Badge } from '../ui/badge'\nimport { Alert, AlertDescription } from '../ui/alert'\nimport { Skeleton } from '../ui/skeleton'\nimport {\n  useAISuggestions,\n  useAcceptAISuggestion,\n  useAISuggestionAnalytics,\n} from '../../hooks/use-ai-suggestions'\nimport type { AILinkSuggestion } from '../../types/ai-suggestions.types'\n\ninterface AISuggestionPanelProps {\n  intakeId: string\n  onManualSearchClick: () => void\n  onSuggestionAccepted: (link: any) => void\n}\n\nexport function AISuggestionPanel({\n  intakeId,\n  onManualSearchClick,\n  onSuggestionAccepted,\n}: AISuggestionPanelProps) {\n  const { t, i18n } = useTranslation()\n  const isRTL = i18n.language === 'ar'\n\n  const [suggestionsEnabled, setSuggestionsEnabled] = useState(false)\n  const [suggestionStartTime, setSuggestionStartTime] = useState<number | null>(null)\n\n  const analytics = useAISuggestionAnalytics(intakeId)\n\n  // Fetch AI suggestions (only when enabled)\n  const {\n    data: suggestionsResponse,\n    isLoading,\n    error,\n    refetch,\n  } = useAISuggestions(intakeId, {\n    enabled: suggestionsEnabled,\n  })\n\n  const acceptMutation = useAcceptAISuggestion(intakeId)\n\n  // Track when suggestions are requested\n  useEffect(() => {\n    if (suggestionsEnabled && !suggestionStartTime) {\n      setSuggestionStartTime(Date.now())\n    }\n  }, [suggestionsEnabled, suggestionStartTime])\n\n  // Track when suggestions are received\n  useEffect(() => {\n    if (suggestionsResponse && suggestionStartTime) {\n      analytics.trackSuggestionGenerated(\n        suggestionsResponse.suggestions.length,\n        suggestionsResponse.metadata?.cache_hit ?? false,\n      )\n    }\n  }, [suggestionsResponse, suggestionStartTime, analytics])\n\n  const handleGetSuggestions = () => {\n    setSuggestionsEnabled(true)\n    setSuggestionStartTime(Date.now())\n  }\n\n  const handleAcceptSuggestion = (suggestion: AILinkSuggestion) => {\n    const acceptStartTime = Date.now()\n\n    acceptMutation.mutate(\n      {\n        suggestion_id: suggestion.suggestion_id,\n        entity_id: suggestion.entity_id,\n        entity_type: suggestion.entity_type,\n        link_type: suggestion.suggested_link_type,\n      },\n      {\n        onSuccess: (data) => {\n          const timeToAccept = Date.now() - acceptStartTime\n\n          analytics.trackSuggestionAccepted(\n            suggestion.suggestion_id,\n            suggestion.rank,\n            suggestion.confidence_score,\n            timeToAccept,\n          )\n\n          onSuggestionAccepted(data.link)\n        },\n      },\n    )\n  }\n\n  const handleFallbackToManualSearch = () => {\n    analytics.trackFallbackToManualSearch('user_clicked_manual_search')\n    onManualSearchClick()\n  }\n\n  // Format confidence score as percentage\n  const formatConfidence = (score: number) => {\n    return `${Math.round(score * 100)}%`\n  }\n\n  // Get confidence badge variant\n  const getConfidenceBadgeVariant = (score: number): 'default' | 'secondary' | 'destructive' => {\n    if (score >= 0.85) return 'default' // High confidence (green)\n    if (score >= 0.75) return 'secondary' // Medium confidence (blue)\n    return 'destructive' // Low confidence (red)\n  }\n\n  // Initial state: Show \"Get AI Suggestions\" button\n  if (!suggestionsEnabled) {\n    return (\n      <Card className=\"w-full\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2 text-start\">\n            <Sparkles className={`h-5 w-5 text-purple-500 ${isRTL ? 'ms-2' : 'me-2'}`} />\n            {t('entityLinks.aiSuggestions.title', 'AI-Powered Suggestions')}\n          </CardTitle>\n          <CardDescription className=\"text-start\">\n            {t(\n              'entityLinks.aiSuggestions.description',\n              'Let AI analyze your intake content and suggest relevant entities to link',\n            )}\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <Button\n            onClick={handleGetSuggestions}\n            className=\"w-full sm:w-auto px-4\"\n            variant=\"default\"\n          >\n            <Sparkles className={`h-4 w-4 ${isRTL ? 'ms-2' : 'me-2'}`} />\n            {t('entityLinks.aiSuggestions.getButton', 'Get AI Suggestions')}\n          </Button>\n        </CardContent>\n      </Card>\n    )\n  }\n\n  // Loading state: Show skeleton cards (2-3 second indicator)\n  if (isLoading) {\n    return (\n      <Card className=\"w-full\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2 text-start\">\n            <RefreshCw\n              className={`h-5 w-5 animate-spin text-purple-500 ${isRTL ? 'ms-2' : 'me-2'}`}\n            />\n            {t('entityLinks.aiSuggestions.loading', 'Analyzing intake content...')}\n          </CardTitle>\n          <CardDescription className=\"text-start\">\n            {t('entityLinks.aiSuggestions.loadingDescription', 'This usually takes 2-3 seconds')}\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4\">\n            {[1, 2, 3].map((i) => (\n              <Card key={i} className=\"p-4\">\n                <Skeleton className=\"h-6 w-3/4 mb-2\" />\n                <Skeleton className=\"h-4 w-1/2 mb-4\" />\n                <Skeleton className=\"h-16 w-full mb-2\" />\n                <Skeleton className=\"h-10 w-full\" />\n              </Card>\n            ))}\n          </div>\n        </CardContent>\n      </Card>\n    )\n  }\n\n  // Error state: Show fallback to manual search\n  if (error) {\n    const errorData = (error as any).response?.data\n    const isFallbackAvailable = errorData?.fallback === 'manual_search'\n\n    return (\n      <Card className=\"w-full\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2 text-start text-destructive\">\n            <AlertCircle className={`h-5 w-5 ${isRTL ? 'ms-2' : 'me-2'}`} />\n            {t('entityLinks.aiSuggestions.error', 'AI Service Unavailable')}\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <Alert variant=\"destructive\">\n            <AlertDescription className=\"text-start\">\n              {errorData?.details ||\n                t(\n                  'entityLinks.aiSuggestions.errorDescription',\n                  'Unable to generate AI suggestions at this time',\n                )}\n            </AlertDescription>\n          </Alert>\n\n          {isFallbackAvailable && (\n            <div className=\"flex flex-col sm:flex-row gap-2\">\n              <Button onClick={handleFallbackToManualSearch} variant=\"default\" className=\"flex-1 \">\n                <Search className={`h-4 w-4 ${isRTL ? 'ms-2' : 'me-2'}`} />\n                {t('entityLinks.aiSuggestions.manualSearch', 'Use Manual Search')}\n              </Button>\n\n              {errorData?.retry_after && (\n                <Button\n                  onClick={() => {\n                    setSuggestionsEnabled(false)\n                    setTimeout(() => setSuggestionsEnabled(true), 1000)\n                  }}\n                  variant=\"outline\"\n                  className=\"\"\n                >\n                  <RefreshCw className={`h-4 w-4 ${isRTL ? 'ms-2' : 'me-2'}`} />\n                  {t('entityLinks.aiSuggestions.retry', 'Retry')}\n                </Button>\n              )}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    )\n  }\n\n  // Success state: Show suggestions\n  const suggestions = suggestionsResponse?.suggestions || []\n\n  if (suggestions.length === 0) {\n    return (\n      <Card className=\"w-full\">\n        <CardHeader>\n          <CardTitle className=\"text-start\">\n            {t('entityLinks.aiSuggestions.noResults', 'No Suggestions Found')}\n          </CardTitle>\n          <CardDescription className=\"text-start\">\n            {t(\n              'entityLinks.aiSuggestions.noResultsDescription',\n              'AI could not find relevant entities. Try manual search.',\n            )}\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <Button\n            onClick={handleFallbackToManualSearch}\n            variant=\"default\"\n            className=\"w-full sm:w-auto \"\n          >\n            <Search className={`h-4 w-4 ${isRTL ? 'ms-2' : 'me-2'}`} />\n            {t('entityLinks.aiSuggestions.manualSearch', 'Use Manual Search')}\n          </Button>\n        </CardContent>\n      </Card>\n    )\n  }\n\n  return (\n    <Card className=\"w-full\">\n      <CardHeader>\n        <CardTitle className=\"flex items-center gap-2 text-start\">\n          <CheckCircle2 className={`h-5 w-5 text-green-500 ${isRTL ? 'ms-2' : 'me-2'}`} />\n          {t('entityLinks.aiSuggestions.resultsTitle', 'AI Suggestions')}\n        </CardTitle>\n        <CardDescription className=\"text-start\">\n          {t('entityLinks.aiSuggestions.resultsDescription', {\n            count: suggestions.length,\n            defaultValue: `Found ${suggestions.length} relevant entities. Click to create link.`,\n          })}\n        </CardDescription>\n      </CardHeader>\n      <CardContent>\n        <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4\">\n          {suggestions.map((suggestion) => (\n            <Card\n              key={suggestion.suggestion_id}\n              className=\"p-4 hover:border-primary transition-colors\"\n            >\n              <div className=\"space-y-3\">\n                {/* Entity name and type */}\n                <div>\n                  <h4 className=\"font-semibold text-start text-sm sm:text-base line-clamp-2\">\n                    {suggestion.entity_name}\n                  </h4>\n                  <p className=\"text-xs text-muted-foreground text-start mt-1\">\n                    {t(`entityTypes.${suggestion.entity_type}`, suggestion.entity_type)}\n                  </p>\n                </div>\n\n                {/* Confidence score */}\n                <div className=\"flex items-center gap-2\">\n                  <Badge variant={getConfidenceBadgeVariant(suggestion.confidence_score)}>\n                    {formatConfidence(suggestion.confidence_score)}\n                  </Badge>\n                  <span className=\"text-xs text-muted-foreground\">\n                    {t('entityLinks.aiSuggestions.confidence', 'Confidence')}\n                  </span>\n                </div>\n\n                {/* Reasoning */}\n                <p className=\"text-xs text-muted-foreground text-start line-clamp-3\">\n                  {suggestion.reasoning}\n                </p>\n\n                {/* Accept button */}\n                <Button\n                  onClick={() => handleAcceptSuggestion(suggestion)}\n                  disabled={acceptMutation.isPending}\n                  className=\"w-full \"\n                  size=\"sm\"\n                >\n                  {acceptMutation.isPending ? (\n                    <>\n                      <RefreshCw className={`h-3 w-3 animate-spin ${isRTL ? 'ms-2' : 'me-2'}`} />\n                      {t('entityLinks.aiSuggestions.accepting', 'Creating...')}\n                    </>\n                  ) : (\n                    <>\n                      {t('entityLinks.aiSuggestions.accept', 'Create Link')}\n                      {suggestion.rank === 1 && ' (Primary)'}\n                    </>\n                  )}\n                </Button>\n              </div>\n            </Card>\n          ))}\n        </div>\n\n        {/* Manual search fallback */}\n        <div className=\"mt-4 pt-4 border-t\">\n          <Button\n            onClick={handleFallbackToManualSearch}\n            variant=\"outline\"\n            className=\"w-full sm:w-auto \"\n          >\n            <Search className={`h-4 w-4 ${isRTL ? 'ms-2' : 'me-2'}`} />\n            {t('entityLinks.aiSuggestions.stillUseManualSearch', 'Or use manual search')}\n          </Button>\n        </div>\n      </CardContent>\n    </Card>\n  )\n}\n","/**\n * EntityLinkSuggestions Component\n * Feature: 033-ai-brief-generation\n * Task: T048\n *\n * Component for displaying and managing AI-suggested entity links:\n * - Shows proposals with confidence scores\n * - Approve/reject workflow\n * - Displays approved links\n */\n\nimport { useState } from 'react'\nimport { useTranslation } from 'react-i18next'\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'\nimport { Button } from '@/components/ui/button'\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'\nimport { Badge } from '@/components/ui/badge'\nimport { Progress } from '@/components/ui/progress'\nimport { Alert, AlertDescription } from '@/components/ui/alert'\nimport { Skeleton } from '@/components/ui/skeleton'\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip'\nimport { cn } from '@/lib/utils'\nimport {\n  Sparkles,\n  Check,\n  X,\n  Link2,\n  FileText,\n  User,\n  Calendar,\n  Target,\n  Loader2,\n  RefreshCw,\n  Trash2,\n  ExternalLink,\n} from 'lucide-react'\nimport { supabase } from '@/store/authStore'\n\nexport interface LinkProposal {\n  id: string\n  entity_type: string\n  entity_id: string\n  confidence_score: number\n  justification: string\n  status: string\n  created_at: string\n}\n\nexport interface EntityLink {\n  id: string\n  entity_type: string\n  entity_id: string\n  entity_name?: string\n  is_ai_suggested: boolean\n  created_at: string\n}\n\nexport interface EntityLinkSuggestionsProps {\n  ticketId: string\n  onLinkClick?: (entityType: string, entityId: string) => void\n  className?: string\n}\n\nconst API_BASE = import.meta.env.VITE_API_URL || '/api'\n\nconst ENTITY_ICONS: Record<string, typeof FileText> = {\n  dossier: FileText,\n  position: Target,\n  person: User,\n  engagement: Calendar,\n  commitment: Check,\n}\n\nexport function EntityLinkSuggestions({\n  ticketId,\n  onLinkClick,\n  className,\n}: EntityLinkSuggestionsProps) {\n  const { t, i18n } = useTranslation('entity-linking')\n  const isRTL = i18n.language === 'ar'\n  const queryClient = useQueryClient()\n  const [isGenerating, setIsGenerating] = useState(false)\n\n  // Fetch proposals\n  const { data: proposals, isLoading: proposalsLoading } = useQuery({\n    queryKey: ['entity-proposals', ticketId],\n    queryFn: async () => {\n      const {\n        data: { session },\n      } = await supabase.auth.getSession()\n      const response = await fetch(\n        `${API_BASE}/ai/intake/${ticketId}/proposals?status=pending_approval`,\n        {\n          headers: { Authorization: `Bearer ${session?.access_token}` },\n        },\n      )\n      if (!response.ok) throw new Error('Failed to fetch proposals')\n      const result = await response.json()\n      return result.data as LinkProposal[]\n    },\n  })\n\n  // Fetch approved links\n  const { data: links, isLoading: linksLoading } = useQuery({\n    queryKey: ['entity-links', ticketId],\n    queryFn: async () => {\n      const {\n        data: { session },\n      } = await supabase.auth.getSession()\n      const response = await fetch(`${API_BASE}/ai/intake/${ticketId}/links`, {\n        headers: { Authorization: `Bearer ${session?.access_token}` },\n      })\n      if (!response.ok) throw new Error('Failed to fetch links')\n      const result = await response.json()\n      return result.data as EntityLink[]\n    },\n  })\n\n  // Generate proposals mutation\n  const generateMutation = useMutation({\n    mutationFn: async () => {\n      const {\n        data: { session },\n      } = await supabase.auth.getSession()\n      const response = await fetch(`${API_BASE}/ai/intake/${ticketId}/propose-links`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          Authorization: `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({ language: i18n.language }),\n      })\n      if (!response.ok) throw new Error('Failed to generate proposals')\n      return response.json()\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['entity-proposals', ticketId] })\n    },\n  })\n\n  // Approve proposal mutation\n  const approveMutation = useMutation({\n    mutationFn: async (proposalId: string) => {\n      const {\n        data: { session },\n      } = await supabase.auth.getSession()\n      const response = await fetch(`${API_BASE}/ai/proposals/${proposalId}/approve`, {\n        method: 'POST',\n        headers: { Authorization: `Bearer ${session?.access_token}` },\n      })\n      if (!response.ok) throw new Error('Failed to approve proposal')\n      return response.json()\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['entity-proposals', ticketId] })\n      queryClient.invalidateQueries({ queryKey: ['entity-links', ticketId] })\n    },\n  })\n\n  // Reject proposal mutation\n  const rejectMutation = useMutation({\n    mutationFn: async (proposalId: string) => {\n      const {\n        data: { session },\n      } = await supabase.auth.getSession()\n      const response = await fetch(`${API_BASE}/ai/proposals/${proposalId}/reject`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          Authorization: `Bearer ${session?.access_token}`,\n        },\n        body: JSON.stringify({}),\n      })\n      if (!response.ok) throw new Error('Failed to reject proposal')\n      return response.json()\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['entity-proposals', ticketId] })\n    },\n  })\n\n  // Delete link mutation\n  const deleteLinkMutation = useMutation({\n    mutationFn: async (linkId: string) => {\n      const {\n        data: { session },\n      } = await supabase.auth.getSession()\n      const response = await fetch(`${API_BASE}/ai/intake/links/${linkId}`, {\n        method: 'DELETE',\n        headers: { Authorization: `Bearer ${session?.access_token}` },\n      })\n      if (!response.ok) throw new Error('Failed to delete link')\n      return response.json()\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['entity-links', ticketId] })\n    },\n  })\n\n  const handleGenerate = async () => {\n    setIsGenerating(true)\n    try {\n      await generateMutation.mutateAsync()\n    } finally {\n      setIsGenerating(false)\n    }\n  }\n\n  const getConfidenceColor = (score: number) => {\n    if (score >= 90) return 'bg-green-500'\n    if (score >= 70) return 'bg-yellow-500'\n    return 'bg-orange-500'\n  }\n\n  const getConfidenceLabel = (score: number) => {\n    if (score >= 90) return t('confidence.high', 'High')\n    if (score >= 70) return t('confidence.medium', 'Medium')\n    return t('confidence.low', 'Low')\n  }\n\n  const isLoading = proposalsLoading || linksLoading\n  const pendingProposals = proposals?.filter((p) => p.status === 'pending_approval') || []\n  const hasProposals = pendingProposals.length > 0\n  const hasLinks = (links?.length || 0) > 0\n\n  return (\n    <Card className={cn('w-full', className)} dir={isRTL ? 'rtl' : 'ltr'}>\n      <CardHeader className=\"pb-3\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <Link2 className=\"h-5 w-5 text-primary\" />\n            <CardTitle className=\"text-lg\">{t('title', 'Entity Links')}</CardTitle>\n          </div>\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            onClick={handleGenerate}\n            disabled={isGenerating || generateMutation.isPending}\n          >\n            {isGenerating || generateMutation.isPending ? (\n              <Loader2 className=\"h-4 w-4 me-1 animate-spin\" />\n            ) : (\n              <Sparkles className={cn('h-4 w-4 me-1', isRTL && 'rotate-180')} />\n            )}\n            {t('suggestLinks', 'Suggest Links')}\n          </Button>\n        </div>\n        <CardDescription>\n          {t('description', 'AI-suggested and manually linked entities')}\n        </CardDescription>\n      </CardHeader>\n\n      <CardContent className=\"space-y-4\">\n        {isLoading ? (\n          <div className=\"space-y-3\">\n            <Skeleton className=\"h-16 w-full\" />\n            <Skeleton className=\"h-16 w-full\" />\n          </div>\n        ) : (\n          <>\n            {/* Pending Proposals */}\n            {hasProposals && (\n              <div className=\"space-y-3\">\n                <h4 className=\"text-sm font-medium text-muted-foreground flex items-center gap-2\">\n                  <Sparkles className=\"h-4 w-4\" />\n                  {t('pendingProposals', 'AI Suggestions')} ({pendingProposals.length})\n                </h4>\n                {pendingProposals.map((proposal) => (\n                  <ProposalCard\n                    key={proposal.id}\n                    proposal={proposal}\n                    isRTL={isRTL}\n                    onApprove={() => approveMutation.mutate(proposal.id)}\n                    onReject={() => rejectMutation.mutate(proposal.id)}\n                    isApproving={approveMutation.isPending}\n                    isRejecting={rejectMutation.isPending}\n                    getConfidenceColor={getConfidenceColor}\n                    getConfidenceLabel={getConfidenceLabel}\n                    t={t}\n                  />\n                ))}\n              </div>\n            )}\n\n            {/* Approved Links */}\n            {hasLinks && (\n              <div className=\"space-y-3\">\n                <h4 className=\"text-sm font-medium text-muted-foreground flex items-center gap-2\">\n                  <Check className=\"h-4 w-4\" />\n                  {t('linkedEntities', 'Linked Entities')} ({links?.length})\n                </h4>\n                {links?.map((link) => (\n                  <LinkCard\n                    key={link.id}\n                    link={link}\n                    onDelete={() => deleteLinkMutation.mutate(link.id)}\n                    onClick={() => onLinkClick?.(link.entity_type, link.entity_id)}\n                    isDeleting={deleteLinkMutation.isPending}\n                  />\n                ))}\n              </div>\n            )}\n\n            {/* Empty State */}\n            {!hasProposals && !hasLinks && (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                <Link2 className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n                <p className=\"text-sm\">{t('noLinks', 'No linked entities yet')}</p>\n                <p className=\"text-xs mt-1\">\n                  {t('noLinksHint', 'Click \"Suggest Links\" to get AI recommendations')}\n                </p>\n              </div>\n            )}\n\n            {/* Generation Error */}\n            {generateMutation.isError && (\n              <Alert variant=\"destructive\">\n                <AlertDescription className=\"flex items-center justify-between\">\n                  <span>{t('errors.generateFailed', 'Failed to generate suggestions')}</span>\n                  <Button variant=\"ghost\" size=\"sm\" onClick={handleGenerate}>\n                    <RefreshCw className=\"h-4 w-4 me-1\" />\n                    {t('retry', 'Retry')}\n                  </Button>\n                </AlertDescription>\n              </Alert>\n            )}\n          </>\n        )}\n      </CardContent>\n    </Card>\n  )\n}\n\ntype TFunc = ReturnType<typeof useTranslation>['t']\n\ninterface ProposalCardProps {\n  proposal: LinkProposal\n  isRTL: boolean\n  onApprove: () => void\n  onReject: () => void\n  isApproving: boolean\n  isRejecting: boolean\n  getConfidenceColor: (score: number) => string\n  getConfidenceLabel: (score: number) => string\n  t: TFunc\n}\n\nfunction ProposalCard({\n  proposal,\n  isRTL,\n  onApprove,\n  onReject,\n  isApproving,\n  isRejecting,\n  getConfidenceColor,\n  getConfidenceLabel,\n  t,\n}: ProposalCardProps) {\n  const Icon = ENTITY_ICONS[proposal.entity_type] || FileText\n\n  return (\n    <div className=\"border rounded-lg p-3 bg-muted/30 space-y-2\">\n      <div className=\"flex items-start justify-between gap-2\">\n        <div className=\"flex items-start gap-2 flex-1\">\n          <div className=\"p-1.5 rounded bg-primary/10\">\n            <Icon className=\"h-4 w-4 text-primary\" />\n          </div>\n          <div className=\"flex-1 min-w-0\">\n            <div className=\"flex items-center gap-2\">\n              <Badge variant=\"outline\" className=\"text-xs capitalize\">\n                {proposal.entity_type}\n              </Badge>\n              <TooltipProvider>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div className=\"flex items-center gap-1\">\n                      <Progress\n                        value={proposal.confidence_score}\n                        className={cn('h-2 w-16', getConfidenceColor(proposal.confidence_score))}\n                      />\n                      <span className=\"text-xs text-muted-foreground\">\n                        {proposal.confidence_score}%\n                      </span>\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    {getConfidenceLabel(proposal.confidence_score)}{' '}\n                    {t('confidence.label', 'confidence')}\n                  </TooltipContent>\n                </Tooltip>\n              </TooltipProvider>\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1 line-clamp-2\">\n              {proposal.justification}\n            </p>\n          </div>\n        </div>\n        <div className=\"flex items-center gap-1 shrink-0\">\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            className=\"h-8 w-8 text-green-600 hover:text-green-700 hover:bg-green-100\"\n            onClick={onApprove}\n            disabled={isApproving || isRejecting}\n          >\n            {isApproving ? (\n              <Loader2 className=\"h-4 w-4 animate-spin\" />\n            ) : (\n              <Check className=\"h-4 w-4\" />\n            )}\n          </Button>\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            className=\"h-8 w-8 text-red-600 hover:text-red-700 hover:bg-red-100\"\n            onClick={onReject}\n            disabled={isApproving || isRejecting}\n          >\n            {isRejecting ? <Loader2 className=\"h-4 w-4 animate-spin\" /> : <X className=\"h-4 w-4\" />}\n          </Button>\n        </div>\n      </div>\n    </div>\n  )\n}\n\ninterface LinkCardProps {\n  link: EntityLink\n  onDelete: () => void\n  onClick?: () => void\n  isDeleting: boolean\n}\n\nfunction LinkCard({ link, onDelete, onClick, isDeleting }: LinkCardProps) {\n  const Icon = ENTITY_ICONS[link.entity_type] || FileText\n\n  return (\n    <div className=\"border rounded-lg p-3 flex items-center justify-between gap-2 hover:bg-muted/30 transition-colors\">\n      <div className=\"flex items-center gap-2 flex-1 cursor-pointer\" onClick={onClick}>\n        <div className=\"p-1.5 rounded bg-primary/10\">\n          <Icon className=\"h-4 w-4 text-primary\" />\n        </div>\n        <div className=\"flex-1 min-w-0\">\n          <div className=\"flex items-center gap-2\">\n            <span className=\"text-sm font-medium truncate\">\n              {link.entity_name || link.entity_id.substring(0, 8)}\n            </span>\n            <Badge variant=\"outline\" className=\"text-xs capitalize\">\n              {link.entity_type}\n            </Badge>\n            {link.is_ai_suggested && (\n              <Badge variant=\"secondary\" className=\"text-xs\">\n                <Sparkles className=\"h-3 w-3 me-1\" />\n                AI\n              </Badge>\n            )}\n          </div>\n        </div>\n        {onClick && <ExternalLink className=\"h-4 w-4 text-muted-foreground\" />}\n      </div>\n      <Button\n        variant=\"ghost\"\n        size=\"icon\"\n        className=\"h-8 w-8 text-muted-foreground hover:text-destructive\"\n        onClick={(e) => {\n          e.stopPropagation()\n          onDelete()\n        }}\n        disabled={isDeleting}\n      >\n        {isDeleting ? <Loader2 className=\"h-4 w-4 animate-spin\" /> : <Trash2 className=\"h-4 w-4\" />}\n      </Button>\n    </div>\n  )\n}\n\nexport default EntityLinkSuggestions\n","/**\n * Entity Link Manager Component\n * Feature: 024-intake-entity-linking\n * Task: T049\n *\n * Main container component for managing entity links on intake tickets\n * Lazy loaded for performance optimization\n */\n\nimport { useState, useMemo } from 'react'\nimport { useTranslation } from 'react-i18next'\nimport { useNavigate } from '@tanstack/react-router'\nimport { Plus, Trash, Link as LinkIcon } from 'lucide-react'\nimport { Button } from '@/components/ui/button'\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'\nimport { cn } from '@/lib/utils'\nimport { EntitySearchDialog } from './EntitySearchDialog'\nimport { LinkList } from './LinkList'\nimport { AISuggestionPanel } from './AISuggestionPanel'\nimport EntityLinkSuggestions from '@/components/ai/EntityLinkSuggestions'\nimport {\n  useEntityLinks,\n  useCreateEntityLink,\n  useCreateBatchEntityLinks,\n  useDeleteEntityLink,\n  useRestoreEntityLink,\n} from '@/hooks/use-entity-links'\nimport { intakeEntityLinksAPI } from '@/services/entity-links-api'\nimport type {\n  EntitySearchResult,\n  LinkType,\n} from '../../../../backend/src/types/intake-entity-links.types'\n\nexport interface EntityLinkManagerProps {\n  /** Intake ticket ID */\n  intakeId: string\n  /** Organization ID for filtering entities */\n  organizationId?: string\n  /** User's clearance level for filtering entities */\n  classificationLevel?: number\n  /** Whether user can restore deleted links (steward+ role) */\n  canRestore?: boolean\n  /** Enable drag-and-drop reordering */\n  enableReorder?: boolean\n  /** Use new AI agent-based suggestions (Feature 033) */\n  useAgentSuggestions?: boolean\n  /** Additional CSS classes */\n  className?: string\n}\n\n/**\n * EntityLinkManager Component\n *\n * Manages all entity link operations for an intake ticket.\n * Provides search dialog, link list, and deleted links management.\n *\n * @example\n * ```tsx\n * <EntityLinkManager\n * intakeId={intakeId}\n * organizationId={currentOrgId}\n * classificationLevel={userProfile.clearance_level}\n * canRestore={hasRole('steward')}\n * enableReorder={true}\n * />\n * ```\n */\nexport function EntityLinkManager({\n  intakeId,\n  organizationId,\n  classificationLevel,\n  canRestore = false,\n  enableReorder = false,\n  useAgentSuggestions = true,\n  className,\n}: EntityLinkManagerProps) {\n  const { t, i18n } = useTranslation()\n  const isRTL = i18n.language === 'ar'\n  const navigate = useNavigate()\n\n  const [isSearchDialogOpen, setIsSearchDialogOpen] = useState(false)\n  const [activeTab, setActiveTab] = useState<'active' | 'deleted'>('active')\n\n  // Fetch entity links\n  const { data: links = [], isLoading, error } = useEntityLinks(intakeId, activeTab === 'deleted')\n\n  // Mutations\n  const createLinkMutation = useCreateEntityLink(intakeId)\n  const createBatchLinksMutation = useCreateBatchEntityLinks(intakeId)\n  const deleteLinkMutation = useDeleteEntityLink(intakeId)\n  const restoreLinkMutation = useRestoreEntityLink(intakeId)\n\n  // Separate active and deleted links\n  const activeLinks = useMemo(() => links.filter((link) => link.deleted_at === null), [links])\n  const deletedLinks = useMemo(() => links.filter((link) => link.deleted_at !== null), [links])\n\n  // Handle entity selection from search dialog (supports both single and batch)\n  const handleEntitySelect = async (\n    entities: EntitySearchResult[],\n    shouldReplacePrimary?: boolean,\n  ) => {\n    // Check if there's already a primary link in the active links\n    const existingPrimaryLink = activeLinks.find((link) => link.link_type === 'primary')\n\n    // If user wants to replace the primary, convert the old primary to 'related' first\n    if (shouldReplacePrimary && existingPrimaryLink) {\n      try {\n        // Update the existing primary link to 'related' using API client directly\n        await intakeEntityLinksAPI.updateLink(intakeId, existingPrimaryLink.id, {\n          link_type: 'related',\n        })\n      } catch (error) {\n        console.error('[EntityLinkManager] Failed to demote existing primary:', error)\n        // Continue anyway - the backend will reject duplicate primaries\n      }\n    }\n\n    // Map entities to link format\n    // Use the _shouldBePrimary flag from the dialog to determine link type\n    const linksToCreate = entities.map((entity: any) => {\n      // Determine link type based on user's selection or fallback logic\n      let linkType: LinkType = 'related' // Default to related\n\n      // Check if user explicitly marked this as primary\n      if (entity._shouldBePrimary) {\n        // If we're replacing, allow setting new primary\n        // If no existing primary, allow setting new primary\n        if (shouldReplacePrimary || !existingPrimaryLink) {\n          linkType = 'primary'\n        }\n      } else if (\n        // Fallback: if no primary exists and this is first anchor entity\n        !existingPrimaryLink &&\n        !shouldReplacePrimary &&\n        !entities.some((e: any) => e._shouldBePrimary) && // No explicit primary selection\n        (entity.entity_type === 'dossier' || entity.entity_type === 'position') &&\n        entities.indexOf(entity) ===\n          entities.findIndex((e) => e.entity_type === 'dossier' || e.entity_type === 'position')\n      ) {\n        linkType = 'primary'\n      }\n\n      return {\n        entity_type: entity.entity_type,\n        entity_id: entity.entity_id,\n        link_type: linkType,\n        notes: '',\n      }\n    })\n\n    // Use batch creation for multiple entities, single creation for one entity\n    if (linksToCreate.length === 1) {\n      createLinkMutation.mutate(linksToCreate[0])\n    } else if (linksToCreate.length > 1) {\n      createBatchLinksMutation.mutate(linksToCreate)\n    }\n  }\n\n  // Handle link deletion\n  const handleDeleteLink = (linkId: string) => {\n    deleteLinkMutation.mutate(linkId)\n  }\n\n  // Handle link restoration\n  const handleRestoreLink = (linkId: string) => {\n    restoreLinkMutation.mutate(linkId)\n  }\n\n  // Handle notes update\n  const handleUpdateNotes = async (linkId: string, notes: string) => {\n    try {\n      await intakeEntityLinksAPI.updateLink(intakeId, linkId, { notes })\n      // Optionally show success toast or refetch data here\n    } catch (error) {\n      console.error('[EntityLinkManager] Failed to update notes:', error)\n      // Optionally show error toast here\n    }\n  }\n\n  // Handle entity link click (navigate to entity)\n  const handleLinkClick = (entityType: string, entityId: string) => {\n    switch (entityType) {\n      case 'dossier':\n        navigate({ to: '/dossiers/$id', params: { id: entityId } })\n        break\n      case 'position':\n        navigate({ to: '/positions/$id', params: { id: entityId } })\n        break\n      case 'person':\n        navigate({ to: '/persons/$id', params: { id: entityId } })\n        break\n      case 'engagement':\n        navigate({ to: '/engagements/$engagementId', params: { engagementId: entityId } })\n        break\n      case 'commitment':\n        navigate({ to: '/commitments', search: { id: entityId } })\n        break\n      default:\n        navigate({\n          to: '/search',\n          search: { q: entityId, type: entityType, includeArchived: false },\n        })\n    }\n  }\n\n  return (\n    <div\n      className={cn(\n        // Container styles\n        'w-full',\n        className,\n      )}\n      aria-label={t('entityLinks.manager')}\n    >\n      {/* Header with actions */}\n      <div\n        className={cn(\n          'flex items-center justify-between',\n          'mb-4 sm:mb-6',\n          'gap-3 sm:gap-4',\n          isRTL && 'flex-row-reverse',\n        )}\n      >\n        <div className={cn('flex items-center gap-2', isRTL && 'flex-row-reverse')}>\n          <LinkIcon className=\"h-5 w-5 sm:h-6 sm:w-6 text-slate-600 dark:text-slate-400\" />\n          <h2\n            className={cn(\n              'text-lg sm:text-xl font-semibold',\n              'text-slate-900 dark:text-slate-100',\n              'text-start',\n            )}\n          >\n            {t('entityLinks.title')}\n          </h2>\n        </div>\n\n        {/* Add link button */}\n        <Button\n          variant=\"default\"\n          className={cn('px-4 sm:px-6', 'touch-manipulation', 'text-sm sm:text-base')}\n          onClick={() => setIsSearchDialogOpen(true)}\n          disabled={isLoading || createLinkMutation.isPending}\n          aria-label={t('entityLinks.addLink')}\n        >\n          <Plus className={cn('h-4 w-4 sm:h-5 sm:w-5', isRTL ? 'ms-2' : 'me-2')} />\n          <span className=\"hidden sm:inline\">{t('entityLinks.addLink')}</span>\n          <span className=\"sm:hidden\">{t('entityLinks.add')}</span>\n        </Button>\n      </div>\n\n      {/* AI Suggestions Panel - Use new agent-based suggestions (Feature 033) or legacy */}\n      <div className=\"mb-6 sm:mb-8\">\n        {useAgentSuggestions ? (\n          <EntityLinkSuggestions ticketId={intakeId} onLinkClick={handleLinkClick} />\n        ) : (\n          <AISuggestionPanel\n            intakeId={intakeId}\n            onManualSearchClick={() => setIsSearchDialogOpen(true)}\n            onSuggestionAccepted={(_link) => {\n              // Link is automatically added via mutation\n            }}\n          />\n        )}\n      </div>\n\n      {/* Tabs for active/deleted links */}\n      <Tabs\n        value={activeTab}\n        onValueChange={(value) => setActiveTab(value as 'active' | 'deleted')}\n        className=\"w-full\"\n      >\n        <TabsList\n          className={cn('w-full sm:w-auto', 'grid grid-cols-2 sm:inline-grid', 'mb-4 sm:mb-6')}\n        >\n          <TabsTrigger value=\"active\" className={cn('touch-manipulation', 'text-sm sm:text-base')}>\n            <span className={cn(isRTL && 'ms-2')}>\n              {t('entityLinks.activeLinks')} ({activeLinks.length})\n            </span>\n          </TabsTrigger>\n\n          {/* Deleted tab (show badge if there are deleted links) */}\n          <TabsTrigger value=\"deleted\" className={cn('touch-manipulation', 'text-sm sm:text-base')}>\n            <Trash\n              className={cn(\n                'h-4 w-4',\n                deletedLinks.length > 0 && 'text-red-600',\n                isRTL ? 'ms-2' : 'me-2',\n              )}\n            />\n            <span>\n              {t('entityLinks.deletedLinks')} ({deletedLinks.length})\n            </span>\n          </TabsTrigger>\n        </TabsList>\n\n        {/* Active links tab */}\n        <TabsContent value=\"active\" className=\"mt-0\">\n          {/* Loading state */}\n          {isLoading && (\n            <div className=\"flex items-center justify-center py-8 sm:py-12\">\n              <div className=\"animate-pulse text-slate-400\">{t('common.loading')}</div>\n            </div>\n          )}\n\n          {/* Error state */}\n          {error && (\n            <div className=\"text-center py-8 sm:py-12\">\n              <p className=\"text-sm sm:text-base text-red-600\">{t('entityLinks.loadError')}</p>\n            </div>\n          )}\n\n          {/* Links list */}\n          {!isLoading && !error && (\n            <LinkList\n              intakeId={intakeId}\n              links={activeLinks}\n              showDeleted={false}\n              enableReorder={enableReorder}\n              onDelete={handleDeleteLink}\n              onUpdateNotes={handleUpdateNotes}\n            />\n          )}\n        </TabsContent>\n\n        {/* Deleted links tab */}\n        <TabsContent value=\"deleted\" className=\"mt-0\">\n          {/* Loading state */}\n          {isLoading && (\n            <div className=\"flex items-center justify-center py-8 sm:py-12\">\n              <div className=\"animate-pulse text-slate-400\">{t('common.loading')}</div>\n            </div>\n          )}\n\n          {/* Error state */}\n          {error && (\n            <div className=\"text-center py-8 sm:py-12\">\n              <p className=\"text-sm sm:text-base text-red-600\">{t('entityLinks.loadError')}</p>\n            </div>\n          )}\n\n          {/* Deleted links list */}\n          {!isLoading && !error && (\n            <LinkList\n              intakeId={intakeId}\n              links={deletedLinks}\n              showDeleted={true}\n              canRestore={canRestore}\n              onRestore={handleRestoreLink}\n            />\n          )}\n        </TabsContent>\n      </Tabs>\n\n      {/* Entity search dialog */}\n      <EntitySearchDialog\n        open={isSearchDialogOpen}\n        onOpenChange={setIsSearchDialogOpen}\n        onSelect={handleEntitySelect}\n        intakeId={intakeId}\n        organizationId={organizationId}\n        classificationLevel={classificationLevel}\n        includeArchived={false}\n      />\n    </div>\n  )\n}\n\nexport default EntityLinkManager\n"],"names":["supabaseUrl","supabaseAnonKey","supabase","createClient","FUNCTIONS_BASE_URL","EntityLinksAPIError","error","fetchWithAuth","endpoint","options","session","data","intakeEntityLinksAPI","intakeId","includeDeleted","params","linkId","linkOrders","filters","entityType","entityId","suggestionId","useDebouncedValue","value","delay","debouncedValue","setDebouncedValue","useState","useEffect","handler","entitySearchKeys","useEntitySearch","debounceMs","minQueryLength","enabled","limit","debouncedQuery","shouldSearch","useQuery","useEntitySearchState","initialFilters","query","setQuery","selectedTypes","setSelectedTypes","searchFilters","searchQuery","clearSearch","useCallback","toggleEntityType","prev","t","clearFilters","formatEntityType","entityLinksKeys","useEntityLinks","useTranslation","useCreateEntityLink","toast","useToast","queryClient","useQueryClient","useMutation","newLink","previousLinks","optimisticLink","context","useDeleteEntityLink","link","useRestoreEntityLink","useReorderEntityLinks","reorderedLinks","link_id","link_order","linkIndex","a","b","useCreateBatchEntityLinks","links","newLinks","optimisticLinks","index","successCount","failCount","ENTITY_TYPES","EntitySearchDialog","open","onOpenChange","onSelect","organizationId","classificationLevel","includeArchived","i18n","isRTL","selectedEntities","setSelectedEntities","primaryEntityKey","setPrimaryEntityKey","results","isLoading","existingLinks","linkedEntityIds","useMemo","existingPrimaryLink","willReplacePrimary","handleToggleSelect","entity","entityKey","isSelected","e","handleSubmit","entitiesWithPrimary","handleClose","jsx","Dialog","jsxs","DialogContent","cn","DialogHeader","DialogTitle","DialogDescription","Search","Input","Button","X","ScrollArea","type","Loader2","isAlreadyLinked","Checkbox","CheckCircle2","Badge","LINK_TYPE_CONFIG","LinkTypeBadge","linkType","showIcon","className","size","config","displayIcon","sizeClasses","translationKey","LinkCard","isDeleted","canRestore","isDraggable","onDelete","onRestore","onUpdateNotes","isEditing","setIsEditing","notesValue","setNotesValue","showDeleteDialog","setShowDeleteDialog","handleSaveNotes","handleCancelEdit","handleDelete","Fragment","Card","CardHeader","GripVertical","Edit2","Trash2","RotateCcw","CardContent","Textarea","Check","AlertDialog","AlertDialogContent","AlertDialogHeader","AlertDialogTitle","AlertDialogDescription","AlertDialogFooter","AlertDialogCancel","AlertDialogAction","LinkList","showDeleted","enableReorder","reorderMutation","sortedLinks","handleDragStart","handleDragOver","handleDrop","targetLinkId","draggedLinkId","draggedIndex","targetIndex","draggedLink","useAISuggestions","request","failureCount","attemptIndex","useAcceptAISuggestion","variables","_error","useAISuggestionAnalytics","_intakeId","_suggestionCount","_cacheHit","_suggestionId","_rank","_confidenceScore","_timeToAccept","_reason","AISuggestionPanel","onManualSearchClick","onSuggestionAccepted","suggestionsEnabled","setSuggestionsEnabled","suggestionStartTime","setSuggestionStartTime","analytics","suggestionsResponse","refetch","acceptMutation","handleGetSuggestions","handleAcceptSuggestion","suggestion","acceptStartTime","timeToAccept","handleFallbackToManualSearch","formatConfidence","score","getConfidenceBadgeVariant","CardTitle","Sparkles","CardDescription","RefreshCw","i","Skeleton","errorData","isFallbackAvailable","AlertCircle","Alert","AlertDescription","suggestions","API_BASE","ENTITY_ICONS","FileText","Target","User","Calendar","EntityLinkSuggestions","ticketId","onLinkClick","isGenerating","setIsGenerating","proposals","proposalsLoading","response","linksLoading","generateMutation","approveMutation","proposalId","rejectMutation","deleteLinkMutation","handleGenerate","getConfidenceColor","getConfidenceLabel","pendingProposals","p","hasProposals","hasLinks","Link2","proposal","ProposalCard","onApprove","onReject","isApproving","isRejecting","Icon","TooltipProvider","Tooltip","TooltipTrigger","Progress","TooltipContent","onClick","isDeleting","ExternalLink","EntityLinkManager","useAgentSuggestions","navigate","useNavigate","isSearchDialogOpen","setIsSearchDialogOpen","activeTab","setActiveTab","createLinkMutation","createBatchLinksMutation","restoreLinkMutation","activeLinks","deletedLinks","handleEntitySelect","entities","shouldReplacePrimary","linksToCreate","handleDeleteLink","handleRestoreLink","handleUpdateNotes","notes","handleLinkClick","LinkIcon","Plus","_link","Tabs","TabsList","TabsTrigger","Trash","TabsContent"],"mappings":"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"}