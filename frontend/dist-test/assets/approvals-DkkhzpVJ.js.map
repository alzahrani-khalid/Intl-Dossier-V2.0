{"version":3,"file":"approvals-DkkhzpVJ.js","sources":["../../src/routes/_protected/admin/approvals.tsx?tsr-split=component"],"sourcesContent":["/**\n * Route: /admin/approvals\n * Admin reassignment panel for stuck approvals\n */\n\nimport { createFileRoute } from '@tanstack/react-router';\nimport { useState } from 'react';\nimport { useTranslation } from 'react-i18next';\nimport { Card } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { supabase } from '@/lib/supabase';\nimport { AlertCircle, Users, Shield } from 'lucide-react';\nimport { Skeleton } from '@/components/ui/skeleton';\n\nexport const Route = createFileRoute('/_protected/admin/approvals')({\n component: AdminApprovalsPage,\n beforeLoad: async () => {\n // Check admin role\n const { data: { session } } = await supabase.auth.getSession();\n const user = session?.user;\n const isAdmin = user?.user_metadata?.role === 'admin' || user?.app_metadata?.role === 'admin';\n\n if (!isAdmin) {\n throw new Error('Admin access required');\n }\n },\n});\n\nconst API_BASE_URL = import.meta.env.VITE_SUPABASE_URL + '/functions/v1';\n\nasync function fetchUnderReviewPositions() {\n const { data: { session } } = await supabase.auth.getSession();\n const response = await fetch(`${API_BASE_URL}/positions-list?status=under_review`, {\n headers: {\n 'Authorization': `Bearer ${session?.access_token}`,\n 'Content-Type': 'application/json',\n },\n });\n\n if (!response.ok) {\n throw new Error('Failed to fetch positions');\n }\n\n const data = await response.json();\n return data.data || [];\n}\n\nasync function reassignApproval(approvalId: string, newApproverId: string, reason: string) {\n const { data: { session } } = await supabase.auth.getSession();\n const response = await fetch(`${API_BASE_URL}/approvals-reassign?id=${approvalId}`, {\n method: 'PUT',\n headers: {\n 'Authorization': `Bearer ${session?.access_token}`,\n 'Content-Type': 'application/json',\n },\n body: JSON.stringify({\n reassign_to: newApproverId,\n reason,\n }),\n });\n\n if (!response.ok) {\n throw new Error('Failed to reassign approval');\n }\n\n return response.json();\n}\n\nfunction AdminApprovalsPage() {\n const { t } = useTranslation();\n const queryClient = useQueryClient();\n const [isReassignDialogOpen, setIsReassignDialogOpen] = useState(false);\n const [selectedPosition, setSelectedPosition] = useState<any>(null);\n const [reassignData, setReassignData] = useState({\n newApproverId: '',\n reason: '',\n });\n\n const { data: positions, isLoading } = useQuery({\n queryKey: ['admin', 'approvals', 'under_review'],\n queryFn: fetchUnderReviewPositions,\n staleTime: 30 * 1000, // 30 seconds\n });\n\n const reassignMutation = useMutation({\n mutationFn: ({ approvalId, newApproverId, reason }: { approvalId: string; newApproverId: string; reason: string }) =>\n reassignApproval(approvalId, newApproverId, reason),\n onSuccess: () => {\n queryClient.invalidateQueries({ queryKey: ['admin', 'approvals'] });\n setIsReassignDialogOpen(false);\n setReassignData({ newApproverId: '', reason: '' });\n },\n });\n\n const handleReassign = (position: any) => {\n setSelectedPosition(position);\n setIsReassignDialogOpen(true);\n };\n\n const handleReassignSubmit = () => {\n if (selectedPosition && reassignData.newApproverId && reassignData.reason) {\n reassignMutation.mutate({\n approvalId: selectedPosition.current_approval_id || '', // This would need to come from the position\n newApproverId: reassignData.newApproverId,\n reason: reassignData.reason,\n });\n }\n };\n\n if (isLoading) {\n return (\n <div className=\"container mx-auto py-6 space-y-4\">\n <Skeleton className=\"h-8 w-64\" />\n <Skeleton className=\"h-96\" />\n </div>\n );\n }\n\n return (\n <div className=\"container mx-auto py-6 space-y-6\">\n {/* Header */}\n <div className=\"flex items-center gap-3\">\n <div className=\"p-3 bg-red-100 dark:bg-red-900 rounded-lg\">\n <Shield className=\"h-6 w-6 text-red-600 dark:text-red-400\" />\n </div>\n <div>\n <h1 className=\"text-3xl font-bold\">\n {t('admin.approvals.title', 'Admin: Approval Management')}\n </h1>\n <p className=\"text-muted-foreground\">\n {t('admin.approvals.subtitle', 'Reassign stuck approvals and manage approval chains')}\n </p>\n </div>\n </div>\n\n {/* Warning Banner */}\n <Card className=\"p-4 border-yellow-500 bg-yellow-50 dark:bg-yellow-900/20\">\n <div className=\"flex items-start gap-3\">\n <AlertCircle className=\"h-5 w-5 text-yellow-600 dark:text-yellow-400 mt-0.5\" />\n <div>\n <p className=\"font-medium text-yellow-800 dark:text-yellow-200\">\n {t('admin.approvals.warning', 'Admin Privileges Active')}\n </p>\n <p className=\"text-sm text-yellow-700 dark:text-yellow-300\">\n {t('admin.approvals.warningText', 'All reassignments are logged and require a reason for audit trail compliance.')}\n </p>\n </div>\n </div>\n </Card>\n\n {/* Positions Under Review Table */}\n <Card className=\"p-6\">\n <div className=\"mb-4\">\n <h2 className=\"text-xl font-semibold\">\n {t('admin.approvals.underReview', 'Positions Under Review')}\n </h2>\n <p className=\"text-sm text-muted-foreground\">\n {t('admin.approvals.underReviewDesc', 'All positions currently in the approval workflow')}\n </p>\n </div>\n\n <Table>\n <TableHeader>\n <TableRow>\n <TableHead>{t('admin.approvals.position', 'Position')}</TableHead>\n <TableHead>{t('admin.approvals.stage', 'Current Stage')}</TableHead>\n <TableHead>{t('admin.approvals.category', 'Category')}</TableHead>\n <TableHead>{t('admin.approvals.submittedDate', 'Submitted')}</TableHead>\n <TableHead>{t('admin.approvals.actions', 'Actions')}</TableHead>\n </TableRow>\n </TableHeader>\n <TableBody>\n {positions && positions.length > 0 ? (\n positions.map((position: any) => (\n <TableRow key={position.id}>\n <TableCell>\n <div>\n <p className=\"font-medium\">{position.title_en}</p>\n <p className=\"text-sm text-muted-foreground\">{position.title_ar}</p>\n </div>\n </TableCell>\n <TableCell>\n <Badge variant=\"secondary\">\n {t('admin.approvals.stageOf', 'Stage {{current}} of {{total}}', {\n current: position.current_stage,\n total: position.approval_chain_config?.stages?.length || 0,\n })}\n </Badge>\n </TableCell>\n <TableCell>{position.thematic_category || '-'}</TableCell>\n <TableCell className=\"text-sm text-muted-foreground\">\n {new Date(position.created_at).toLocaleDateString()}\n </TableCell>\n <TableCell>\n <Button\n variant=\"outline\"\n size=\"sm\"\n onClick={() => handleReassign(position)}\n >\n <Users className=\"me-2 h-4 w-4\" />\n {t('admin.approvals.reassign', 'Reassign')}\n </Button>\n </TableCell>\n </TableRow>\n ))\n ) : (\n <TableRow>\n <TableCell colSpan={5} className=\"text-center text-muted-foreground\">\n {t('admin.approvals.noPositions', 'No positions under review')}\n </TableCell>\n </TableRow>\n )}\n </TableBody>\n </Table>\n </Card>\n\n {/* Reassign Dialog */}\n <Dialog open={isReassignDialogOpen} onOpenChange={setIsReassignDialogOpen}>\n <DialogContent className=\"sm:max-w-[500px]\">\n <DialogHeader>\n <DialogTitle>{t('admin.approvals.reassignTitle', 'Reassign Approval')}</DialogTitle>\n <DialogDescription>\n {t('admin.approvals.reassignDesc', 'Reassign this approval to a different user. A reason is required for audit purposes.')}\n </DialogDescription>\n </DialogHeader>\n\n <div className=\"space-y-4 py-4\">\n <div className=\"space-y-2\">\n <Label htmlFor=\"position\">\n {t('admin.approvals.position', 'Position')}\n </Label>\n <p className=\"text-sm font-medium\">{selectedPosition?.title_en}</p>\n </div>\n\n <div className=\"space-y-2\">\n <Label htmlFor=\"newApprover\">\n {t('admin.approvals.newApprover', 'New Approver')} *\n </Label>\n <Input\n id=\"newApprover\"\n placeholder={t('admin.approvals.newApproverPlaceholder', 'Enter user ID or search')}\n value={reassignData.newApproverId}\n onChange={(e) => setReassignData({ ...reassignData, newApproverId: e.target.value })}\n />\n </div>\n\n <div className=\"space-y-2\">\n <Label htmlFor=\"reason\">\n {t('admin.approvals.reason', 'Reason for Reassignment')} *\n </Label>\n <Textarea\n id=\"reason\"\n placeholder={t('admin.approvals.reasonPlaceholder', 'e.g., Original approver is on leave, organizational change')}\n value={reassignData.reason}\n onChange={(e) => setReassignData({ ...reassignData, reason: e.target.value })}\n rows={3}\n />\n </div>\n </div>\n\n <DialogFooter>\n <Button variant=\"outline\" onClick={() => setIsReassignDialogOpen(false)}>\n {t('common.cancel', 'Cancel')}\n </Button>\n <Button\n onClick={handleReassignSubmit}\n disabled={!reassignData.newApproverId || !reassignData.reason}\n >\n {t('admin.approvals.confirmReassign', 'Confirm Reassignment')}\n </Button>\n </DialogFooter>\n </DialogContent>\n </Dialog>\n </div>\n );\n}\n"],"names":["API_BASE_URL","import","fetchUnderReviewPositions","data","session","supabase","auth","getSession","response","fetch","headers","access_token","ok","Error","json","reassignApproval","approvalId","newApproverId","reason","method","body","JSON","stringify","reassign_to","AdminApprovalsPage","t","useTranslation","queryClient","useQueryClient","isReassignDialogOpen","setIsReassignDialogOpen","useState","selectedPosition","setSelectedPosition","reassignData","setReassignData","positions","isLoading","useQuery","queryKey","queryFn","staleTime","reassignMutation","useMutation","mutationFn","onSuccess","invalidateQueries","handleReassign","position","handleReassignSubmit","mutate","current_approval_id","jsxs","jsx","Skeleton","Shield","Card","AlertCircle","Table","TableHeader","TableRow","TableHead","TableBody","length","map","TableCell","title_en","title_ar","Badge","current","current_stage","total","approval_chain_config","stages","thematic_category","Date","created_at","toLocaleDateString","Button","Users","id","Dialog","DialogContent","DialogHeader","DialogTitle","DialogDescription","Label","Input","e","target","value","Textarea","DialogFooter"],"mappings":"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"}