{"version":3,"file":"CountryTimeline-ChW1wm5i.js","sources":["../../src/components/KeyContactsPanel.tsx","../../src/hooks/useDossierPositionLinks.ts","../../src/components/positions/DossierPositionsTab.tsx","../../src/services/relationship-api.ts","../../src/hooks/useRelationships.ts","../../src/components/dossiers/CustomNodes.tsx","../../src/components/dossiers/CustomEdges.tsx","../../src/components/dossiers/RelationshipGraph.tsx","../../src/components/dossiers/DossierMoUsTab.tsx","../../src/components/timeline/CountryTimeline.tsx"],"sourcesContent":["import { useTranslation } from 'react-i18next';\nimport { Card, CardContent, CardHeader, CardTitle } from './ui/card';\nimport { Button } from './ui/button';\nimport { Badge } from './ui/badge';\nimport { Skeleton } from './ui/skeleton';\nimport {\n UserPlus,\n Mail,\n Phone,\n Building2,\n Calendar,\n Edit,\n Trash2,\n User,\n} from 'lucide-react';\nimport type { KeyContact } from '../types/dossier';\n\ninterface KeyContactsPanelProps {\n dossierId: string;\n contacts?: KeyContact[];\n isLoading?: boolean;\n onAddContact?: () => void;\n onEditContact?: (contactId: string) => void;\n onDeleteContact?: (contactId: string) => void;\n}\n\nexport function KeyContactsPanel({\n contacts = [],\n isLoading,\n onAddContact,\n onEditContact,\n onDeleteContact,\n}: KeyContactsPanelProps) {\n const { t, i18n } = useTranslation('dossiers');\n\n // Loading skeleton\n if (isLoading) {\n return (\n <Card>\n <CardHeader>\n <CardTitle className=\"text-base\">{t('keyContacts.title')}</CardTitle>\n </CardHeader>\n <CardContent className=\"space-y-4\">\n {[...Array(3)].map((_, index) => (\n <div key={index} className=\"space-y-2\">\n <Skeleton className=\"h-5 w-3/4\" />\n <Skeleton className=\"h-4 w-1/2\" />\n <Skeleton className=\"h-4 w-2/3\" />\n </div>\n ))}\n </CardContent>\n </Card>\n );\n }\n\n // Empty state\n if (!contacts || contacts.length === 0) {\n return (\n <Card>\n <CardHeader>\n <div className=\"flex items-center justify-between\">\n <CardTitle className=\"text-base\">{t('keyContacts.title')}</CardTitle>\n {onAddContact && (\n <Button\n variant=\"ghost\"\n size=\"sm\"\n onClick={onAddContact}\n className=\"h-8 gap-1\"\n aria-label={t('actions.addContact')}\n >\n <UserPlus className=\"size-4\" />\n <span className=\"hidden sm:inline\">{t('actions.addContact')}</span>\n </Button>\n )}\n </div>\n </CardHeader>\n <CardContent>\n <div className=\"flex flex-col items-center justify-center py-8 text-center\">\n <User className=\"mb-4 size-12 text-muted-foreground\" />\n <p className=\"text-sm text-muted-foreground\">{t('keyContacts.empty')}</p>\n {onAddContact && (\n <Button\n variant=\"outline\"\n size=\"sm\"\n onClick={onAddContact}\n className=\"mt-4 gap-2\"\n >\n <UserPlus className=\"size-4\" />\n {t('actions.addContact')}\n </Button>\n )}\n </div>\n </CardContent>\n </Card>\n );\n }\n\n return (\n <Card>\n <CardHeader>\n <div className=\"flex items-center justify-between\">\n <CardTitle className=\"flex items-center gap-2 text-base\">\n {t('keyContacts.title')}\n <Badge variant=\"secondary\">{contacts.length}</Badge>\n </CardTitle>\n {onAddContact && (\n <Button\n variant=\"ghost\"\n size=\"sm\"\n onClick={onAddContact}\n className=\"h-8 gap-1\"\n aria-label={t('actions.addContact')}\n >\n <UserPlus className=\"size-4\" />\n <span className=\"hidden sm:inline\">{t('actions.addContact')}</span>\n </Button>\n )}\n </div>\n </CardHeader>\n <CardContent>\n <ul className=\"space-y-4\" role=\"list\">\n {contacts.map((contact) => (\n <li\n key={contact.id}\n className=\"rounded-lg border p-4 transition-colors hover:bg-muted/50\"\n role=\"listitem\"\n >\n <div className=\"space-y-3\">\n {/* Name and Actions */}\n <div className=\"flex items-start justify-between gap-2\">\n <div className=\"min-w-0 flex-1\">\n <h3 className=\"truncate text-base font-semibold leading-tight\">\n {contact.name}\n </h3>\n {contact.role && (\n <p className=\"truncate text-sm text-muted-foreground\">\n {contact.role}\n </p>\n )}\n </div>\n <div className=\"flex shrink-0 gap-1\">\n {onEditContact && (\n <Button\n variant=\"ghost\"\n size=\"sm\"\n onClick={() => onEditContact(contact.id)}\n className=\"size-8 p-0\"\n aria-label={`${t('edit')} ${contact.name}`}\n >\n <Edit className=\"size-4\" />\n </Button>\n )}\n {onDeleteContact && (\n <Button\n variant=\"ghost\"\n size=\"sm\"\n onClick={() => onDeleteContact(contact.id)}\n className=\"size-8 p-0 text-destructive hover:text-destructive\"\n aria-label={`${t('delete', { ns: 'translation' })} ${contact.name}`}\n >\n <Trash2 className=\"size-4\" />\n </Button>\n )}\n </div>\n </div>\n\n {/* Organization */}\n {contact.organization && (\n <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n <Building2 className=\"size-4 shrink-0\" />\n <span className=\"truncate\">{contact.organization}</span>\n </div>\n )}\n\n {/* Contact Information */}\n <div className=\"space-y-2\">\n {contact.email && (\n <div className=\"flex items-center gap-2 text-sm\">\n <Mail className=\"size-4 shrink-0 text-muted-foreground\" />\n <a\n href={`mailto:${contact.email}`}\n className=\"truncate text-primary hover:underline\"\n aria-label={`${t('keyContacts.email')}: ${contact.email}`}\n >\n {contact.email}\n </a>\n </div>\n )}\n {contact.phone && (\n <div className=\"flex items-center gap-2 text-sm\">\n <Phone className=\"size-4 shrink-0 text-muted-foreground\" />\n <a\n href={`tel:${contact.phone}`}\n className=\"text-primary hover:underline\"\n aria-label={`${t('keyContacts.phone')}: ${contact.phone}`}\n dir=\"ltr\"\n >\n {contact.phone}\n </a>\n </div>\n )}\n </div>\n\n {/* Last Interaction */}\n {contact.last_interaction_date && (\n <div className=\"flex items-center gap-2 border-t pt-2 text-xs text-muted-foreground\">\n <Calendar className=\"size-3 shrink-0\" />\n <span>\n {t('keyContacts.lastInteraction')}:{' '}\n {new Date(contact.last_interaction_date).toLocaleDateString(\n i18n.language,\n {\n year: 'numeric',\n month: 'short',\n day: 'numeric',\n }\n )}\n </span>\n </div>\n )}\n\n {/* Notes */}\n {contact.notes && (\n <p className=\"line-clamp-2 border-t pt-2 text-xs italic text-muted-foreground\">\n {contact.notes}\n </p>\n )}\n </div>\n </li>\n ))}\n </ul>\n </CardContent>\n </Card>\n );\n}","/**\n * Dossier Position Links Hook\n * @module hooks/useDossierPositionLinks\n * @feature 026-unified-dossier-architecture\n * @feature 034-dossier-ui-polish\n *\n * Fetches position papers linked to a dossier with their link_type information.\n * Used in DossierPositionsTab to display positions with their relationship type badges.\n *\n * @description\n * This hook retrieves all position papers linked to a specific dossier through\n * the position_dossier_links junction table. Each link includes:\n * - Link type: 'primary', 'related', or 'reference'\n * - Link notes (optional)\n * - Full position paper data\n *\n * Supports filtering by:\n * - Link type\n * - Position status\n * - Text search across position title and content\n *\n * @example\n * // Basic usage\n * const { links, positions, isLoading } = useDossierPositionLinks('dossier-uuid');\n *\n * @example\n * // With filters\n * const { positions } = useDossierPositionLinks('dossier-uuid', {\n *   link_type: 'primary',\n *   status: 'approved',\n *   search: 'climate',\n * });\n */\n\nimport { useQuery } from '@tanstack/react-query'\nimport { supabase } from '@/lib/supabase'\nimport type { Position } from '@/types/position'\n\n/**\n * Represents a link between a dossier and a position paper\n * @property position_id - UUID of the linked position paper\n * @property dossier_id - UUID of the dossier\n * @property link_type - Relationship type: 'primary' (main topic), 'related' (supporting), or 'reference' (informational)\n * @property notes - Optional notes explaining the relationship\n * @property created_at - ISO timestamp of when the link was created\n * @property created_by - UUID of the user who created the link\n * @property position - Full position paper data\n */\nexport interface DossierPositionLink {\n  position_id: string\n  dossier_id: string\n  link_type: 'primary' | 'related' | 'reference'\n  notes?: string | null\n  created_at: string\n  created_by: string\n  position: Position\n}\n\n/**\n * Filter options for the useDossierPositionLinks hook\n * @property link_type - Filter by relationship type\n * @property status - Filter by position approval status\n * @property search - Text search across position title and content fields\n */\nexport interface UseDossierPositionLinksFilters {\n  link_type?: 'primary' | 'related' | 'reference'\n  status?: string\n  search?: string\n}\n\n/**\n * Return type of the useDossierPositionLinks hook\n * @property links - Array of position-dossier link records with full position data\n * @property positions - Convenience array of just the position papers (with link_type added)\n * @property totalCount - Total number of linked positions\n * @property isLoading - Whether the query is currently loading\n * @property error - Error object if the query failed\n * @property refetch - Function to manually refetch the data\n */\nexport interface UseDossierPositionLinksResult {\n  links: DossierPositionLink[]\n  positions: Position[]\n  totalCount: number\n  isLoading: boolean\n  error: Error | null\n  refetch: () => void\n}\n\n/**\n * Hook to fetch position papers linked to a dossier\n *\n * @description\n * Fetches all positions linked to a dossier with their relationship metadata.\n * The hook returns both the full link records and a convenience array of\n * positions with the link_type injected for easy display.\n *\n * Cache behavior:\n * - staleTime: 2 minutes\n * - Automatically disabled when dossierId is falsy\n *\n * @param dossierId - The UUID of the dossier to fetch linked positions for\n * @param filters - Optional filters for link_type, status, and text search\n * @returns UseDossierPositionLinksResult with links, positions, and query state\n *\n * @example\n * // In a component\n * const { positions, isLoading, error } = useDossierPositionLinks(dossierId);\n *\n * if (isLoading) return <Spinner />;\n * if (error) return <ErrorMessage error={error} />;\n *\n * return positions.map(pos => (\n *   <PositionCard key={pos.id} position={pos} linkType={pos.link_type} />\n * ));\n */\nexport function useDossierPositionLinks(\n  dossierId: string,\n  filters?: UseDossierPositionLinksFilters,\n): UseDossierPositionLinksResult {\n  const { data, isLoading, error, refetch } = useQuery({\n    queryKey: ['dossier-position-links', dossierId, filters],\n    queryFn: async () => {\n      // Build query\n      let query = supabase\n        .from('position_dossier_links')\n        .select(\n          `\n          position_id,\n          dossier_id,\n          link_type,\n          notes,\n          created_at,\n          created_by,\n          position:positions (\n            id,\n            title_en,\n            title_ar,\n            content_en,\n            content_ar,\n            rationale_en,\n            rationale_ar,\n            alignment_notes_en,\n            alignment_notes_ar,\n            thematic_category,\n            status,\n            position_type_id,\n            current_stage,\n            approval_chain_config,\n            consistency_score,\n            author_id,\n            created_at,\n            updated_at,\n            version\n          )\n        `,\n        )\n        .eq('dossier_id', dossierId)\n        .order('created_at', { ascending: false })\n\n      // Apply link_type filter\n      if (filters?.link_type) {\n        query = query.eq('link_type', filters.link_type)\n      }\n\n      const { data: links, error: queryError, count } = await query\n\n      if (queryError) {\n        throw new Error(queryError.message)\n      }\n\n      // Filter by position status if provided\n      let filteredLinks = links || []\n      if (filters?.status) {\n        filteredLinks = filteredLinks.filter((link) => link.position?.status === filters.status)\n      }\n\n      // Filter by search query if provided\n      if (filters?.search) {\n        const searchLower = filters.search.toLowerCase()\n        filteredLinks = filteredLinks.filter((link) => {\n          const position = link.position\n          if (!position) return false\n          return (\n            position.title_en?.toLowerCase().includes(searchLower) ||\n            position.title_ar?.toLowerCase().includes(searchLower) ||\n            position.content_en?.toLowerCase().includes(searchLower) ||\n            position.content_ar?.toLowerCase().includes(searchLower)\n          )\n        })\n      }\n\n      // Extract positions from links and add link_type as metadata\n      const positions = filteredLinks\n        .filter((link) => link.position)\n        .map((link) => ({\n          ...link.position,\n          link_type: link.link_type, // Add link_type to position object\n        })) as Position[]\n\n      return {\n        links: filteredLinks as DossierPositionLink[],\n        positions,\n        total_count: count || filteredLinks.length,\n      }\n    },\n    staleTime: 2 * 60 * 1000, // 2 minutes\n    enabled: !!dossierId,\n  })\n\n  return {\n    links: data?.links || [],\n    positions: data?.positions || [],\n    totalCount: data?.total_count || 0,\n    isLoading,\n    error: error as Error | null,\n    refetch,\n  }\n}\n","/**\n * Dossier Positions Tab (T053)\n *\n * Displays positions filtered by dossier context with search and filters\n * Features: Virtual scrolling, quick attach/detach, context-aware display\n * Integration: Part of dossier detail tabs\n */\n\nimport { useState, useMemo } from 'react';\nimport { useTranslation } from 'react-i18next';\nimport { useDossierPositionLinks } from '../../hooks/useDossierPositionLinks';\nimport { PositionList } from './PositionList';\nimport { AttachPositionDialog } from './AttachPositionDialog';\nimport { Button } from '../ui/button';\nimport { Input } from '../ui/input';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '../ui/select';\nimport { useDebouncedValue } from '../../hooks/useDebouncedValue';\nimport type { PositionStatus, PositionType } from '../../types/position';\n\ninterface DossierPositionsTabProps {\n dossierId: string;\n}\n\nexport function DossierPositionsTab({ dossierId }: DossierPositionsTabProps) {\n const { t } = useTranslation(['positions', 'common']);\n\n // Search and filter state\n const [searchQuery, setSearchQuery] = useState('');\n const [statusFilter, setStatusFilter] = useState<PositionStatus | 'all'>('all');\n const [typeFilter, setTypeFilter] = useState<PositionType | 'all'>('all');\n const [linkTypeFilter, setLinkTypeFilter] = useState<'primary' | 'related' | 'reference' | 'all'>('all');\n const [showAttachDialog, setShowAttachDialog] = useState(false);\n\n // Debounce search input\n const debouncedSearch = useDebouncedValue(searchQuery, 300);\n\n // Fetch positions linked to this dossier with link_type information\n const { positions, totalCount, isLoading, error, refetch } = useDossierPositionLinks(dossierId, {\n link_type: linkTypeFilter === 'all' ? undefined : linkTypeFilter,\n status: statusFilter === 'all' ? undefined : statusFilter,\n search: debouncedSearch,\n });\n\n // Handler for creating new position\n const handleCreatePosition = () => {\n setShowAttachDialog(true);\n };\n\n // Handler for clearing filters\n const handleClearFilters = () => {\n setSearchQuery('');\n setStatusFilter('all');\n setTypeFilter('all');\n setLinkTypeFilter('all');\n };\n\n const hasActiveFilters =\n searchQuery || statusFilter !== 'all' || typeFilter !== 'all' || linkTypeFilter !== 'all';\n\n return (\n <div className=\"space-y-6\">\n {/* Header Actions */}\n <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\n <div className=\"space-y-1\">\n <h2 className=\"text-lg font-semibold text-gray-900 dark:text-gray-100\">\n {t('positions:dossier_tab.title')}\n </h2>\n <p className=\"text-sm text-gray-500 dark:text-gray-400\">\n {t('positions:dossier_tab.subtitle', { count: totalCount })}\n </p>\n </div>\n <Button\n onClick={handleCreatePosition}\n className=\"w-full sm:w-auto\"\n aria-label={t('positions:dossier_tab.create_position')}\n >\n {t('positions:dossier_tab.create_position')}\n </Button>\n </div>\n\n {/* Search and Filters */}\n <div className=\"bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4\">\n <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4\">\n {/* Search Input */}\n <div className=\"lg:col-span-2\">\n <Input\n type=\"search\"\n placeholder={t('positions:dossier_tab.search_placeholder')}\n value={searchQuery}\n onChange={(e) => setSearchQuery(e.target.value)}\n className=\"w-full\"\n aria-label={t('positions:dossier_tab.search_label')}\n />\n </div>\n\n {/* Link Type Filter - NEW */}\n <div>\n <Select\n value={linkTypeFilter}\n onValueChange={(value) =>\n setLinkTypeFilter(value as 'primary' | 'related' | 'reference' | 'all')\n }\n >\n <SelectTrigger aria-label=\"Filter by link type\">\n <SelectValue placeholder=\"All Link Types\" />\n </SelectTrigger>\n <SelectContent>\n <SelectItem value=\"all\">All Link Types</SelectItem>\n <SelectItem value=\"primary\">Primary</SelectItem>\n <SelectItem value=\"related\">Related</SelectItem>\n <SelectItem value=\"reference\">Reference</SelectItem>\n </SelectContent>\n </Select>\n </div>\n\n {/* Status Filter */}\n <div>\n <Select\n value={statusFilter}\n onValueChange={(value) =>\n setStatusFilter(value as PositionStatus | 'all')\n }\n >\n <SelectTrigger aria-label={t('positions:dossier_tab.status_filter')}>\n <SelectValue placeholder={t('positions:dossier_tab.all_statuses')} />\n </SelectTrigger>\n <SelectContent>\n <SelectItem value=\"all\">\n {t('positions:dossier_tab.all_statuses')}\n </SelectItem>\n <SelectItem value=\"draft\">\n {t('positions:status.draft')}\n </SelectItem>\n <SelectItem value=\"review\">\n {t('positions:status.review')}\n </SelectItem>\n <SelectItem value=\"approved\">\n {t('positions:status.approved')}\n </SelectItem>\n <SelectItem value=\"published\">\n {t('positions:status.published')}\n </SelectItem>\n <SelectItem value=\"archived\">\n {t('positions:status.archived')}\n </SelectItem>\n </SelectContent>\n </Select>\n </div>\n </div>\n\n {/* Clear Filters Button */}\n {hasActiveFilters && (\n <div className=\"mt-4 flex justify-end\">\n <Button\n variant=\"ghost\"\n size=\"sm\"\n onClick={handleClearFilters}\n aria-label={t('positions:dossier_tab.clear_filters')}\n >\n {t('common:clear_filters')}\n </Button>\n </div>\n )}\n </div>\n\n {/* Positions List */}\n {error ? (\n <div\n className=\"bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-6 text-center\"\n role=\"alert\"\n >\n <p className=\"text-sm text-red-700 dark:text-red-300\">\n {error instanceof Error\n ? error.message\n : t('positions:dossier_tab.error_loading')}\n </p>\n </div>\n ) : (\n <PositionList\n positions={positions}\n isLoading={isLoading}\n context=\"dossier\"\n dossierId={dossierId}\n hideFilters={true}\n emptyMessage={\n hasActiveFilters\n ? t('positions:dossier_tab.no_results')\n : t('positions:dossier_tab.no_positions')\n }\n />\n )}\n\n {/* Attach Position Dialog */}\n {showAttachDialog && (\n <AttachPositionDialog\n open={showAttachDialog}\n onClose={() => setShowAttachDialog(false)}\n context=\"dossier\"\n contextId={dossierId}\n />\n )}\n </div>\n );\n}\n","/**\n * Relationship API Client\n * Part of: 026-unified-dossier-architecture implementation\n * Updated for: universal-relationship-crud feature\n *\n * Typed API client for dossier relationship operations using universal relationship model.\n * Handles bidirectional relationships between any dossier types for graph traversal.\n */\n\nimport { supabase } from '@/lib/supabase';\n\n// Get Supabase URL for Edge Functions\nconst supabaseUrl = import.meta.env.VITE_SUPABASE_URL;\n\nif (!supabaseUrl) {\n  throw new Error('Missing VITE_SUPABASE_URL environment variable');\n}\n\n/**\n * Relationship Types - Comprehensive list for all dossier types\n */\nexport type RelationshipType =\n  | 'member_of'\n  | 'participates_in'\n  | 'cooperates_with'\n  | 'bilateral_relation'\n  | 'partnership'\n  | 'parent_of'\n  | 'subsidiary_of'\n  | 'related_to'\n  | 'represents'\n  | 'hosted_by'\n  | 'sponsored_by'\n  | 'involves'\n  | 'discusses'\n  | 'participant_in'\n  | 'observer_of'\n  | 'affiliate_of'\n  | 'successor_of'\n  | 'predecessor_of'\n  // Legacy types for backward compatibility\n  | 'membership'\n  | 'parent_child'\n  | 'participation'\n  | 'affiliation'\n  | 'dependency'\n  | 'collaboration';\n\n/**\n * Relationship Status\n */\nexport type RelationshipStatus = 'active' | 'historical' | 'terminated';\n\n/**\n * Dossier Reference in relationship context\n */\nexport interface DossierReference {\n  id: string;\n  type: string;\n  name_en: string;\n  name_ar: string;\n  status: string;\n}\n\n/**\n * API Request types\n */\nexport interface CreateRelationshipRequest {\n  source_dossier_id: string;\n  target_dossier_id: string;\n  relationship_type: RelationshipType;\n  relationship_metadata?: Record<string, unknown>;\n  notes_en?: string;\n  notes_ar?: string;\n  effective_from?: string;\n  effective_to?: string;\n  status?: RelationshipStatus;\n  // Legacy field mappings\n  description_en?: string;\n  description_ar?: string;\n  metadata?: Record<string, unknown>;\n  effective_until?: string;\n}\n\nexport interface UpdateRelationshipRequest {\n  relationship_type?: RelationshipType;\n  relationship_metadata?: Record<string, unknown>;\n  notes_en?: string;\n  notes_ar?: string;\n  effective_from?: string;\n  effective_to?: string;\n  status?: RelationshipStatus;\n  // Legacy field mappings\n  description_en?: string;\n  description_ar?: string;\n  metadata?: Record<string, unknown>;\n  effective_until?: string;\n}\n\nexport interface RelationshipFilters {\n  source_dossier_id?: string;\n  target_dossier_id?: string;\n  dossier_id?: string;\n  relationship_type?: RelationshipType;\n  status?: RelationshipStatus;\n  page?: number;\n  page_size?: number;\n  limit?: number;\n  offset?: number;\n}\n\nexport interface RelationshipWithDossiers {\n  id: string;\n  source_dossier_id: string;\n  target_dossier_id: string;\n  relationship_type: RelationshipType;\n  relationship_metadata: Record<string, unknown>;\n  notes_en?: string;\n  notes_ar?: string;\n  effective_from?: string;\n  effective_to?: string;\n  status: RelationshipStatus;\n  created_at: string;\n  created_by?: string;\n  source_dossier?: DossierReference;\n  target_dossier?: DossierReference;\n}\n\nexport interface RelationshipsListResponse {\n  data: RelationshipWithDossiers[];\n  pagination: {\n    total?: number;\n    limit: number;\n    offset: number;\n    has_more: boolean;\n  };\n  // Legacy format for backward compatibility\n  relationships?: RelationshipWithDossiers[];\n  total_count?: number;\n  page?: number;\n  page_size?: number;\n}\n\n/**\n * API Error class\n */\nexport class RelationshipAPIError extends Error {\n  code: string;\n  status: number;\n  details?: any;\n\n  constructor(message: string, status: number, code: string, details?: any) {\n    super(message);\n    this.name = 'RelationshipAPIError';\n    this.code = code;\n    this.status = status;\n    this.details = details;\n  }\n}\n\n/**\n * Helper function to get auth headers\n */\nasync function getAuthHeaders(): Promise<Record<string, string>> {\n  const { data: { session } } = await supabase.auth.getSession();\n\n  if (!session) {\n    throw new RelationshipAPIError('Not authenticated', 401, 'AUTH_REQUIRED');\n  }\n\n  return {\n    'Content-Type': 'application/json',\n    'Authorization': `Bearer ${session.access_token}`,\n  };\n}\n\n/**\n * Helper function to handle API responses\n */\nasync function handleResponse<T>(response: Response): Promise<T> {\n  if (!response.ok) {\n    let error: any;\n    try {\n      error = await response.json();\n    } catch {\n      error = { message: response.statusText };\n    }\n\n    throw new RelationshipAPIError(\n      error.message || 'API request failed',\n      response.status,\n      error.code || 'API_ERROR',\n      error.details\n    );\n  }\n\n  return response.json();\n}\n\n/**\n * Helper to normalize request for new API format\n */\nfunction normalizeRequest(request: CreateRelationshipRequest | UpdateRelationshipRequest): Record<string, unknown> {\n  const normalized: Record<string, unknown> = { ...request };\n\n  // Map legacy fields to new fields\n  if ('description_en' in request && !('notes_en' in request)) {\n    normalized.notes_en = request.description_en;\n  }\n  if ('description_ar' in request && !('notes_ar' in request)) {\n    normalized.notes_ar = request.description_ar;\n  }\n  if ('metadata' in request && !('relationship_metadata' in request)) {\n    normalized.relationship_metadata = request.metadata;\n  }\n  if ('effective_until' in request && !('effective_to' in request)) {\n    normalized.effective_to = request.effective_until;\n  }\n\n  // Remove legacy fields\n  delete normalized.description_en;\n  delete normalized.description_ar;\n  delete normalized.metadata;\n  delete normalized.effective_until;\n\n  return normalized;\n}\n\n/**\n * Create a new relationship\n */\nexport async function createRelationship(\n  request: CreateRelationshipRequest\n): Promise<RelationshipWithDossiers> {\n  const headers = await getAuthHeaders();\n  const normalizedRequest = normalizeRequest(request);\n\n  const response = await fetch(`${supabaseUrl}/functions/v1/dossier-relationships`, {\n    method: 'POST',\n    headers,\n    body: JSON.stringify(normalizedRequest),\n  });\n\n  return handleResponse<RelationshipWithDossiers>(response);\n}\n\n/**\n * Get a relationship by ID\n */\nexport async function getRelationship(id: string): Promise<RelationshipWithDossiers> {\n  const headers = await getAuthHeaders();\n  const response = await fetch(`${supabaseUrl}/functions/v1/dossier-relationships/${id}`, {\n    method: 'GET',\n    headers,\n  });\n\n  return handleResponse<RelationshipWithDossiers>(response);\n}\n\n/**\n * Update a relationship\n */\nexport async function updateRelationship(\n  id: string,\n  request: UpdateRelationshipRequest\n): Promise<RelationshipWithDossiers> {\n  const headers = await getAuthHeaders();\n  const normalizedRequest = normalizeRequest(request);\n\n  const response = await fetch(`${supabaseUrl}/functions/v1/dossier-relationships/${id}`, {\n    method: 'PATCH',\n    headers,\n    body: JSON.stringify(normalizedRequest),\n  });\n\n  return handleResponse<RelationshipWithDossiers>(response);\n}\n\n/**\n * Delete a relationship\n */\nexport async function deleteRelationship(id: string): Promise<{ success: boolean; id: string }> {\n  const headers = await getAuthHeaders();\n  const response = await fetch(`${supabaseUrl}/functions/v1/dossier-relationships/${id}`, {\n    method: 'DELETE',\n    headers,\n  });\n\n  if (!response.ok) {\n    const error = await response.json().catch(() => ({ message: response.statusText }));\n    throw new RelationshipAPIError(\n      error.message || 'Failed to delete relationship',\n      response.status,\n      error.code || 'DELETE_FAILED',\n      error.details\n    );\n  }\n\n  return response.json();\n}\n\n/**\n * List relationships with filters\n */\nexport async function listRelationships(\n  filters?: RelationshipFilters\n): Promise<RelationshipsListResponse> {\n  const headers = await getAuthHeaders();\n  const params = new URLSearchParams();\n\n  if (filters) {\n    // Map pagination params\n    if (filters.page !== undefined && filters.page_size !== undefined) {\n      params.append('offset', String(filters.page * filters.page_size));\n      params.append('limit', String(filters.page_size));\n    }\n    if (filters.limit !== undefined) params.append('limit', String(filters.limit));\n    if (filters.offset !== undefined) params.append('offset', String(filters.offset));\n\n    // Map filter params\n    if (filters.source_dossier_id) params.append('source_dossier_id', filters.source_dossier_id);\n    if (filters.target_dossier_id) params.append('target_dossier_id', filters.target_dossier_id);\n    if (filters.dossier_id) params.append('dossier_id', filters.dossier_id);\n    if (filters.relationship_type) params.append('relationship_type', filters.relationship_type);\n    if (filters.status) params.append('status', filters.status);\n  }\n\n  const url = `${supabaseUrl}/functions/v1/dossier-relationships${params.toString() ? `?${params.toString()}` : ''}`;\n  const response = await fetch(url, {\n    method: 'GET',\n    headers,\n  });\n\n  return handleResponse<RelationshipsListResponse>(response);\n}\n\n/**\n * Get all relationships for a dossier (bidirectional)\n */\nexport async function getRelationshipsForDossier(\n  dossierId: string,\n  page?: number,\n  page_size?: number\n): Promise<RelationshipsListResponse> {\n  const headers = await getAuthHeaders();\n  const params = new URLSearchParams();\n\n  if (page !== undefined && page_size !== undefined) {\n    params.append('offset', String(page * page_size));\n    params.append('limit', String(page_size));\n  }\n\n  const url = `${supabaseUrl}/functions/v1/dossier-relationships/dossier/${dossierId}${params.toString() ? `?${params.toString()}` : ''}`;\n  const response = await fetch(url, {\n    method: 'GET',\n    headers,\n  });\n\n  return handleResponse<RelationshipsListResponse>(response);\n}\n\n/**\n * Get relationships by type\n */\nexport async function getRelationshipsByType(\n  dossierId: string,\n  relationshipType: RelationshipType,\n  page?: number,\n  page_size?: number\n): Promise<RelationshipsListResponse> {\n  const headers = await getAuthHeaders();\n  const params = new URLSearchParams();\n\n  params.append('relationship_type', relationshipType);\n  if (page !== undefined && page_size !== undefined) {\n    params.append('offset', String(page * page_size));\n    params.append('limit', String(page_size));\n  }\n\n  const url = `${supabaseUrl}/functions/v1/dossier-relationships/dossier/${dossierId}?${params.toString()}`;\n  const response = await fetch(url, {\n    method: 'GET',\n    headers,\n  });\n\n  return handleResponse<RelationshipsListResponse>(response);\n}\n","/**\n * Relationship Hooks\n * Part of: 026-unified-dossier-architecture implementation\n *\n * TanStack Query hooks for relationship operations with automatic caching,\n * invalidation, and graph traversal support.\n */\n\nimport { useMutation, useQuery, useQueryClient, type UseQueryOptions } from '@tanstack/react-query';\nimport {\n  createRelationship,\n  getRelationship,\n  updateRelationship,\n  deleteRelationship,\n  listRelationships,\n  getRelationshipsForDossier,\n  getRelationshipsByType,\n  type CreateRelationshipRequest,\n  type UpdateRelationshipRequest,\n  type RelationshipFilters,\n  type RelationshipWithDossiers,\n  type RelationshipsListResponse,\n  type RelationshipType,\n  RelationshipAPIError,\n} from '@/services/relationship-api';\nimport { toast } from 'sonner';\nimport { useTranslation } from 'react-i18next';\n\n/**\n * Query Keys Factory\n */\nexport const relationshipKeys = {\n  all: ['relationships'] as const,\n  lists: () => [...relationshipKeys.all, 'list'] as const,\n  list: (filters?: RelationshipFilters) => [...relationshipKeys.lists(), { filters }] as const,\n  details: () => [...relationshipKeys.all, 'detail'] as const,\n  detail: (id: string) => [...relationshipKeys.details(), id] as const,\n  forDossier: (dossierId: string, page?: number, page_size?: number) =>\n    [...relationshipKeys.all, 'dossier', dossierId, { page, page_size }] as const,\n  byType: (dossierId: string, type: RelationshipType, page?: number, page_size?: number) =>\n    [...relationshipKeys.all, 'dossier', dossierId, 'type', type, { page, page_size }] as const,\n};\n\n/**\n * Hook to fetch a single relationship by ID\n */\nexport function useRelationship(\n  id: string,\n  options?: Omit<UseQueryOptions<RelationshipWithDossiers, RelationshipAPIError>, 'queryKey' | 'queryFn'>\n) {\n  return useQuery({\n    queryKey: relationshipKeys.detail(id),\n    queryFn: () => getRelationship(id),\n    ...options,\n  });\n}\n\n/**\n * Hook to fetch list of relationships with filters\n */\nexport function useRelationships(\n  filters?: RelationshipFilters,\n  options?: Omit<UseQueryOptions<RelationshipsListResponse, RelationshipAPIError>, 'queryKey' | 'queryFn'>\n) {\n  return useQuery({\n    queryKey: relationshipKeys.list(filters),\n    queryFn: () => listRelationships(filters),\n    ...options,\n  });\n}\n\n/**\n * Hook to fetch all relationships for a dossier (bidirectional)\n */\nexport function useRelationshipsForDossier(\n  dossierId: string,\n  page?: number,\n  page_size?: number,\n  options?: Omit<UseQueryOptions<RelationshipsListResponse, RelationshipAPIError>, 'queryKey' | 'queryFn'>\n) {\n  return useQuery({\n    queryKey: relationshipKeys.forDossier(dossierId, page, page_size),\n    queryFn: () => getRelationshipsForDossier(dossierId, page, page_size),\n    ...options,\n  });\n}\n\n/**\n * Hook to fetch relationships by type\n */\nexport function useRelationshipsByType(\n  dossierId: string,\n  relationshipType: RelationshipType,\n  page?: number,\n  page_size?: number,\n  options?: Omit<UseQueryOptions<RelationshipsListResponse, RelationshipAPIError>, 'queryKey' | 'queryFn'>\n) {\n  return useQuery({\n    queryKey: relationshipKeys.byType(dossierId, relationshipType, page, page_size),\n    queryFn: () => getRelationshipsByType(dossierId, relationshipType, page, page_size),\n    ...options,\n  });\n}\n\n/**\n * Hook to create a new relationship\n */\nexport function useCreateRelationship() {\n  const queryClient = useQueryClient();\n  const { t } = useTranslation();\n\n  return useMutation({\n    mutationFn: (request: CreateRelationshipRequest) => createRelationship(request),\n    onSuccess: (data) => {\n      // Invalidate all relationship lists\n      queryClient.invalidateQueries({ queryKey: relationshipKeys.lists() });\n\n      // Invalidate relationships for both source and target dossiers\n      queryClient.invalidateQueries({\n        queryKey: relationshipKeys.forDossier(data.source_dossier_id),\n      });\n      queryClient.invalidateQueries({\n        queryKey: relationshipKeys.forDossier(data.target_dossier_id),\n      });\n\n      // Set the new relationship in the cache\n      queryClient.setQueryData(relationshipKeys.detail(data.id), data);\n\n      toast.success(t('relationship.create.success'));\n    },\n    onError: (error: RelationshipAPIError) => {\n      toast.error(t('relationship.create.error', { message: error.message }));\n    },\n  });\n}\n\n/**\n * Hook to update a relationship\n */\nexport function useUpdateRelationship() {\n  const queryClient = useQueryClient();\n  const { t } = useTranslation();\n\n  return useMutation({\n    mutationFn: ({ id, request }: { id: string; request: UpdateRelationshipRequest }) =>\n      updateRelationship(id, request),\n    onMutate: async ({ id, request }) => {\n      // Cancel any outgoing refetches\n      await queryClient.cancelQueries({ queryKey: relationshipKeys.detail(id) });\n\n      // Snapshot the previous value\n      const previousRelationship = queryClient.getQueryData<RelationshipWithDossiers>(\n        relationshipKeys.detail(id)\n      );\n\n      // Optimistically update the cache\n      if (previousRelationship) {\n        queryClient.setQueryData<RelationshipWithDossiers>(relationshipKeys.detail(id), {\n          ...previousRelationship,\n          ...request,\n          updated_at: new Date().toISOString(),\n        });\n      }\n\n      return { previousRelationship };\n    },\n    onSuccess: (data, { id }) => {\n      // Update the cache with server response\n      queryClient.setQueryData(relationshipKeys.detail(id), data);\n\n      // Invalidate lists to refetch\n      queryClient.invalidateQueries({ queryKey: relationshipKeys.lists() });\n      queryClient.invalidateQueries({\n        queryKey: relationshipKeys.forDossier(data.source_dossier_id),\n      });\n      queryClient.invalidateQueries({\n        queryKey: relationshipKeys.forDossier(data.target_dossier_id),\n      });\n\n      toast.success(t('relationship.update.success'));\n    },\n    onError: (error: RelationshipAPIError, { id }, context) => {\n      // Rollback optimistic update on error\n      if (context?.previousRelationship) {\n        queryClient.setQueryData(relationshipKeys.detail(id), context.previousRelationship);\n      }\n\n      toast.error(t('relationship.update.error', { message: error.message }));\n    },\n  });\n}\n\n/**\n * Hook to delete a relationship\n */\nexport function useDeleteRelationship() {\n  const queryClient = useQueryClient();\n  const { t } = useTranslation();\n\n  return useMutation({\n    mutationFn: (id: string) => deleteRelationship(id),\n    onMutate: async (id) => {\n      // Cancel any outgoing refetches\n      await queryClient.cancelQueries({ queryKey: relationshipKeys.detail(id) });\n\n      // Snapshot the previous value\n      const previousRelationship = queryClient.getQueryData<RelationshipWithDossiers>(\n        relationshipKeys.detail(id)\n      );\n\n      // Optimistically remove from cache\n      queryClient.removeQueries({ queryKey: relationshipKeys.detail(id) });\n\n      return { previousRelationship };\n    },\n    onSuccess: (_, id, context) => {\n      // Invalidate all lists to refetch without deleted item\n      queryClient.invalidateQueries({ queryKey: relationshipKeys.lists() });\n      queryClient.invalidateQueries({ queryKey: relationshipKeys.all });\n\n      // Invalidate relationships for both dossiers if we have the previous data\n      if (context?.previousRelationship) {\n        queryClient.invalidateQueries({\n          queryKey: relationshipKeys.forDossier(context.previousRelationship.source_dossier_id),\n        });\n        queryClient.invalidateQueries({\n          queryKey: relationshipKeys.forDossier(context.previousRelationship.target_dossier_id),\n        });\n      }\n\n      toast.success(t('relationship.delete.success'));\n    },\n    onError: (error: RelationshipAPIError, id, context) => {\n      // Restore the previous value on error\n      if (context?.previousRelationship) {\n        queryClient.setQueryData(relationshipKeys.detail(id), context.previousRelationship);\n      }\n\n      toast.error(t('relationship.delete.error', { message: error.message }));\n    },\n  });\n}\n\n/**\n * Hook to prefetch relationships for a dossier (useful for hover effects, navigation hints)\n */\nexport function usePrefetchRelationshipsForDossier() {\n  const queryClient = useQueryClient();\n\n  return (dossierId: string) => {\n    queryClient.prefetchQuery({\n      queryKey: relationshipKeys.forDossier(dossierId),\n      queryFn: () => getRelationshipsForDossier(dossierId),\n    });\n  };\n}\n\n/**\n * Hook to invalidate relationship queries (useful after bulk operations)\n */\nexport function useInvalidateRelationships() {\n  const queryClient = useQueryClient();\n\n  return () => {\n    queryClient.invalidateQueries({ queryKey: relationshipKeys.all });\n  };\n}\n\n/**\n * T084: Hook to fetch graph data with degree expansion\n * Fetches relationship graph from starting dossier up to N degrees of separation\n */\nexport interface GraphNode {\n  id: string;\n  type: string;\n  name_en: string;\n  name_ar: string;\n  status: string;\n  degree: number;\n  path: string[];\n}\n\nexport interface GraphEdge {\n  source_id: string;\n  target_id: string;\n  relationship_type: string;\n}\n\nexport interface GraphData {\n  start_dossier_id: string;\n  start_dossier: {\n    id: string;\n    type: string;\n    name_en: string;\n    name_ar: string;\n    status: string;\n  };\n  max_degrees: number;\n  relationship_type_filter: string;\n  nodes: GraphNode[];\n  edges: GraphEdge[];\n  stats: {\n    node_count: number;\n    edge_count: number;\n    max_degree: number;\n    query_time_ms: number;\n    performance_warning: string | null;\n  };\n}\n\nexport const graphKeys = {\n  all: ['graph'] as const,\n  traversal: (startDossierId: string, maxDegrees: number, relationshipType?: string) =>\n    [...graphKeys.all, 'traversal', startDossierId, maxDegrees, relationshipType || 'all'] as const,\n};\n\n/**\n * Fetch graph traversal data from Edge Function\n */\nasync function fetchGraphData(\n  startDossierId: string,\n  maxDegrees: number = 2,\n  relationshipType?: string\n): Promise<GraphData> {\n  const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;\n  const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;\n\n  if (!supabaseUrl || !supabaseAnonKey) {\n    throw new Error('Supabase configuration missing');\n  }\n\n  // Build query params\n  const params = new URLSearchParams({\n    startDossierId,\n    maxDegrees: maxDegrees.toString(),\n  });\n\n  if (relationshipType) {\n    params.append('relationshipType', relationshipType);\n  }\n\n  const url = `${supabaseUrl}/functions/v1/graph-traversal?${params.toString()}`;\n\n  const response = await fetch(url, {\n    method: 'GET',\n    headers: {\n      Authorization: `Bearer ${supabaseAnonKey}`,\n      'Content-Type': 'application/json',\n    },\n  });\n\n  if (!response.ok) {\n    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));\n    throw new RelationshipAPIError(\n      errorData.error || 'Failed to fetch graph data',\n      response.status\n    );\n  }\n\n  return response.json();\n}\n\n/**\n * Hook to fetch graph data with degree expansion\n * Fetches relationship graph from starting dossier up to N degrees of separation\n *\n * @param startDossierId - Starting dossier UUID\n * @param maxDegrees - Maximum degrees of separation (default 2, max 5)\n * @param relationshipType - Optional filter by relationship type\n * @param options - TanStack Query options\n *\n * @example\n * const { data, isLoading, error } = useGraphData('dossier-uuid', 3, 'bilateral_relation');\n * // data contains nodes, edges, and stats for visualization\n */\nexport function useGraphData(\n  startDossierId: string,\n  maxDegrees: number = 2,\n  relationshipType?: string,\n  options?: Omit<UseQueryOptions<GraphData, RelationshipAPIError>, 'queryKey' | 'queryFn'>\n) {\n  const { t } = useTranslation();\n\n  return useQuery({\n    queryKey: graphKeys.traversal(startDossierId, maxDegrees, relationshipType),\n    queryFn: () => fetchGraphData(startDossierId, maxDegrees, relationshipType),\n    enabled: !!startDossierId,\n    staleTime: 5 * 60 * 1000, // 5 minutes - graph data changes infrequently\n    ...options,\n    meta: {\n      errorMessage: t('graph.fetchError', 'Failed to load graph data'),\n    },\n  });\n}\n\n/**\n * Hook to prefetch graph data (useful for hover effects, navigation hints)\n */\nexport function usePrefetchGraphData() {\n  const queryClient = useQueryClient();\n\n  return (startDossierId: string, maxDegrees: number = 2, relationshipType?: string) => {\n    queryClient.prefetchQuery({\n      queryKey: graphKeys.traversal(startDossierId, maxDegrees, relationshipType),\n      queryFn: () => fetchGraphData(startDossierId, maxDegrees, relationshipType),\n      staleTime: 5 * 60 * 1000,\n    });\n  };\n}\n","// Enhanced Card-Style React Flow Nodes for Relationship Graph\nimport { memo } from 'react';\nimport { Handle, Position, NodeProps } from 'reactflow';\nimport { Building2, Globe2, Users2, Sparkles, ChevronRight, FileText, Users, TrendingUp } from 'lucide-react';\n\ninterface CustomNodeData {\n label: string;\n isCenter?: boolean;\n referenceType?: 'country' | 'organization' | 'forum';\n description?: string;\n stats?: {\n mous?: number;\n positions?: number;\n engagements?: number;\n health_score?: number;\n };\n}\n\n// Center Node Component (Current Dossier) - Large Card Style\nexport const CenterNode = memo(({ data }: NodeProps<CustomNodeData>) => {\n return (\n <div className=\"relative group\">\n {/* Animated glow ring */}\n <div className=\"absolute -inset-3 bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 rounded-3xl opacity-60 blur-xl group-hover:opacity-80 transition-opacity duration-500 animate-pulse\"></div>\n\n {/* Main card content */}\n <div className=\"relative w-80 bg-white dark:bg-gray-800 rounded-2xl shadow-2xl border-2 border-blue-400/50 backdrop-blur-sm overflow-hidden\">\n {/* Header with gradient background */}\n <div className=\"bg-gradient-to-br from-blue-500 via-blue-600 to-indigo-700 px-6 py-4 relative\">\n {/* Sparkle badge */}\n <div className=\"absolute -top-2 -right-2 bg-yellow-400 rounded-full p-2 shadow-lg\">\n <Sparkles className=\"w-5 h-5 text-yellow-900 animate-spin\" style={{ animationDuration: '3s' }} />\n </div>\n\n {/* Title */}\n <div className=\"flex items-center gap-3\">\n <div className=\"w-3 h-3 bg-white rounded-full animate-pulse\"></div>\n <div>\n <h3 className=\"text-white font-bold text-lg tracking-wide drop-shadow-lg\">\n {data.label}\n </h3>\n <p className=\"text-blue-100 text-xs mt-0.5\">Current Dossier</p>\n </div>\n </div>\n </div>\n\n {/* Content section */}\n <div className=\"p-5 space-y-4\">\n {/* Description */}\n {data.description && (\n <p className=\"text-gray-600 dark:text-gray-300 text-sm leading-relaxed\">\n {data.description}\n </p>\n )}\n\n {/* Metrics */}\n {data.stats && (\n <div className=\"grid grid-cols-2 gap-3\">\n <div className=\"bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3\">\n <div className=\"flex items-center gap-2 mb-1\">\n <FileText className=\"w-4 h-4 text-blue-600 dark:text-blue-400\" />\n <span className=\"text-xs text-gray-500 dark:text-gray-400\">MoUs</span>\n </div>\n <p className=\"text-2xl font-bold text-blue-600 dark:text-blue-400\">\n {data.stats.mous || 0}\n </p>\n </div>\n <div className=\"bg-purple-50 dark:bg-purple-900/20 rounded-lg p-3\">\n <div className=\"flex items-center gap-2 mb-1\">\n <Users className=\"w-4 h-4 text-purple-600 dark:text-purple-400\" />\n <span className=\"text-xs text-gray-500 dark:text-gray-400\">Positions</span>\n </div>\n <p className=\"text-2xl font-bold text-purple-600 dark:text-purple-400\">\n {data.stats.positions || 0}\n </p>\n </div>\n </div>\n )}\n\n {/* Action footer */}\n <div className=\"flex items-center justify-between pt-3 border-t border-gray-200 dark:border-gray-700\">\n <div className=\"flex items-center gap-2\">\n <div className=\"w-6 h-6 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center\">\n <span className=\"text-white text-xs font-bold\">K</span>\n </div>\n <span className=\"text-xs text-gray-500 dark:text-gray-400\">View Details</span>\n </div>\n <ChevronRight className=\"w-4 h-4 text-gray-400\" />\n </div>\n </div>\n\n {/* Connection Handles */}\n <Handle type=\"target\" position={Position.Left} className=\"w-3 h-3 bg-blue-400 border-2 border-white\" />\n <Handle type=\"source\" position={Position.Right} className=\"w-3 h-3 bg-blue-400 border-2 border-white\" />\n <Handle type=\"target\" position={Position.Top} className=\"w-3 h-3 bg-blue-400 border-2 border-white\" />\n <Handle type=\"source\" position={Position.Bottom} className=\"w-3 h-3 bg-blue-400 border-2 border-white\" />\n </div>\n </div>\n );\n});\n\nCenterNode.displayName = 'CenterNode';\n\n// Related Node Component (Other Dossiers) - Card Style\nexport const RelatedNode = memo(({ data, isConnectable }: NodeProps<CustomNodeData>) => {\n const { referenceType, label, description, stats } = data;\n\n // Get colors and icon based on entity type\n const getNodeStyle = () => {\n switch (referenceType) {\n case 'country':\n return {\n bgGradient: 'from-emerald-50 to-teal-50',\n darkBgGradient: 'dark:from-emerald-900/10 dark:to-teal-900/10',\n headerGradient: 'from-emerald-500 to-teal-600',\n border: 'border-emerald-200 dark:border-emerald-700',\n icon: Globe2,\n iconColor: 'text-emerald-600 dark:text-emerald-400',\n accentColor: 'text-emerald-600 dark:text-emerald-400',\n badgeBg: 'bg-emerald-100 dark:bg-emerald-900/30',\n badgeText: 'text-emerald-700 dark:text-emerald-300',\n label: 'Country',\n };\n case 'organization':\n return {\n bgGradient: 'from-purple-50 to-violet-50',\n darkBgGradient: 'dark:from-purple-900/10 dark:to-violet-900/10',\n headerGradient: 'from-purple-500 to-violet-600',\n border: 'border-purple-200 dark:border-purple-700',\n icon: Building2,\n iconColor: 'text-purple-600 dark:text-purple-400',\n accentColor: 'text-purple-600 dark:text-purple-400',\n badgeBg: 'bg-purple-100 dark:bg-purple-900/30',\n badgeText: 'text-purple-700 dark:text-purple-300',\n label: 'Organization',\n };\n case 'forum':\n return {\n bgGradient: 'from-amber-50 to-orange-50',\n darkBgGradient: 'dark:from-amber-900/10 dark:to-orange-900/10',\n headerGradient: 'from-amber-500 to-orange-600',\n border: 'border-amber-200 dark:border-amber-700',\n icon: Users2,\n iconColor: 'text-amber-600 dark:text-amber-400',\n accentColor: 'text-amber-600 dark:text-amber-400',\n badgeBg: 'bg-amber-100 dark:bg-amber-900/30',\n badgeText: 'text-amber-700 dark:text-amber-300',\n label: 'Forum',\n };\n default:\n return {\n bgGradient: 'from-gray-50 to-slate-50',\n darkBgGradient: 'dark:from-gray-900/10 dark:to-slate-900/10',\n headerGradient: 'from-gray-500 to-slate-600',\n border: 'border-gray-200 dark:border-gray-700',\n icon: Building2,\n iconColor: 'text-gray-600 dark:text-gray-400',\n accentColor: 'text-gray-600 dark:text-gray-400',\n badgeBg: 'bg-gray-100 dark:bg-gray-900/30',\n badgeText: 'text-gray-700 dark:text-gray-300',\n label: 'Entity',\n };\n }\n };\n\n const style = getNodeStyle();\n const IconComponent = style.icon;\n\n return (\n <div className=\"relative group\">\n {/* Hover glow effect */}\n <div className={`absolute -inset-2 bg-gradient-${style.headerGradient} rounded-2xl opacity-0 group-hover:opacity-30 blur-xl transition-opacity duration-300`}></div>\n\n {/* Main card */}\n <div className={`relative w-72 bg-gradient-to-br ${style.bgGradient} ${style.darkBgGradient} rounded-xl shadow-lg border-2 ${style.border} transform transition-all duration-300 group-hover:scale-105 group-hover:shadow-2xl cursor-pointer overflow-hidden`}>\n {/* Header with icon */}\n <div className=\"flex items-center gap-3 px-4 py-3 border-b border-gray-200 dark:border-gray-700\">\n <div className={`p-2 rounded-lg bg-white dark:bg-gray-800 shadow-sm`}>\n <IconComponent className={`w-5 h-5 ${style.iconColor}`} />\n </div>\n <div className=\"flex-1 min-w-0\">\n <h4 className=\"font-semibold text-gray-900 dark:text-white text-sm truncate\">\n {label}\n </h4>\n <span className={`text-xs ${style.badgeBg} ${style.badgeText} px-2 py-0.5 rounded-full`}>\n {style.label}\n </span>\n </div>\n </div>\n\n {/* Content section */}\n <div className=\"p-4 space-y-3\">\n {/* Description */}\n {description && (\n <p className=\"text-gray-600 dark:text-gray-300 text-xs leading-relaxed line-clamp-2\">\n {description}\n </p>\n )}\n\n {/* Metrics - Simplified */}\n {stats && (\n <div className=\"flex gap-2\">\n {stats.mous !== undefined && (\n <div className=\"flex-1 bg-white dark:bg-gray-800 rounded-lg p-2 shadow-sm\">\n <p className=\"text-xs text-gray-500 dark:text-gray-400\">MoUs</p>\n <p className={`text-lg font-bold ${style.accentColor}`}>{stats.mous}</p>\n </div>\n )}\n {stats.engagements !== undefined && (\n <div className=\"flex-1 bg-white dark:bg-gray-800 rounded-lg p-2 shadow-sm\">\n <p className=\"text-xs text-gray-500 dark:text-gray-400\">Engage</p>\n <p className={`text-lg font-bold ${style.accentColor}`}>{stats.engagements}</p>\n </div>\n )}\n </div>\n )}\n\n {/* Health indicator */}\n {stats?.health_score !== undefined && (\n <div className=\"flex items-center gap-2\">\n <TrendingUp className={`w-4 h-4 ${style.iconColor}`} />\n <div className=\"flex-1 h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden\">\n <div\n className={`h-full bg-gradient-to-r ${style.headerGradient} rounded-full transition-all duration-500`}\n style={{ width: `${stats.health_score}%` }}\n ></div>\n </div>\n <span className=\"text-xs text-gray-500 dark:text-gray-400\">{stats.health_score}%</span>\n </div>\n )}\n </div>\n\n {/* Footer */}\n <div className=\"px-4 py-2 bg-white/50 dark:bg-gray-800/50 border-t border-gray-200 dark:border-gray-700 flex items-center justify-between\">\n <div className=\"flex items-center gap-1\">\n <div className=\"w-5 h-5 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center\">\n <span className=\"text-white text-[10px] font-bold\">A</span>\n </div>\n <div className=\"w-5 h-5 rounded-full bg-gradient-to-br from-emerald-400 to-teal-500 flex items-center justify-center -ml-1\">\n <span className=\"text-white text-[10px] font-bold\">B</span>\n </div>\n </div>\n <button className=\"px-3 py-1 bg-primary hover:bg-primary/90 text-primary-foreground text-xs font-semibold rounded-md transition-colors duration-200\">\n View\n </button>\n </div>\n\n {/* Shine effect overlay */}\n <div className=\"absolute inset-0 bg-gradient-to-tr from-transparent via-white/5 to-transparent rounded-xl opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none\"></div>\n\n {/* Connection Handles - Hidden by default */}\n <Handle\n type=\"target\"\n position={Position.Left}\n isConnectable={isConnectable}\n className=\"w-2.5 h-2.5 bg-white border-2 border-current opacity-0 group-hover:opacity-100 transition-opacity\"\n />\n <Handle\n type=\"source\"\n position={Position.Right}\n isConnectable={isConnectable}\n className=\"w-2.5 h-2.5 bg-white border-2 border-current opacity-0 group-hover:opacity-100 transition-opacity\"\n />\n <Handle\n type=\"target\"\n position={Position.Top}\n isConnectable={isConnectable}\n className=\"w-2.5 h-2.5 bg-white border-2 border-current opacity-0 group-hover:opacity-100 transition-opacity\"\n />\n <Handle\n type=\"source\"\n position={Position.Bottom}\n isConnectable={isConnectable}\n className=\"w-2.5 h-2.5 bg-white border-2 border-current opacity-0 group-hover:opacity-100 transition-opacity\"\n />\n </div>\n </div>\n );\n});\n\nRelatedNode.displayName = 'RelatedNode';\n\n// Dark mode variants (kept for backwards compatibility)\nexport const CenterNodeDark = CenterNode;\n","// Enhanced Custom React Flow Edges with Dotted Lines and Impact Badges\nimport { memo } from 'react';\nimport { EdgeProps, getBezierPath, EdgeLabelRenderer, BaseEdge } from 'reactflow';\n\ninterface CustomEdgeData {\n label?: string;\n strength?: 'primary' | 'secondary' | 'observer';\n}\n\n// Custom Edge Component with dotted lines and impact badges\nexport const CustomEdge = memo((({\n id,\n sourceX,\n sourceY,\n targetX,\n targetY,\n sourcePosition,\n targetPosition,\n data,\n markerEnd,\n}: EdgeProps<CustomEdgeData>) => {\n const [edgePath, labelX, labelY] = getBezierPath({\n sourceX,\n sourceY,\n sourcePosition,\n targetX,\n targetY,\n targetPosition,\n });\n\n const { label, strength = 'secondary' } = data || {};\n\n // Get edge styling based on strength (matching impact levels) - Theme aware\n const getEdgeStyle = () => {\n switch (strength) {\n case 'primary':\n return {\n stroke: 'hsl(var(--success))',\n strokeWidth: 3,\n impactLabel: 'High Impact',\n impactBg: 'bg-success',\n impactText: 'text-success-foreground',\n dotColor: 'hsl(var(--success))',\n };\n case 'secondary':\n return {\n stroke: 'hsl(var(--warning))',\n strokeWidth: 2.5,\n impactLabel: 'Medium Impact',\n impactBg: 'bg-warning',\n impactText: 'text-warning-foreground',\n dotColor: 'hsl(var(--warning))',\n };\n case 'observer':\n return {\n stroke: 'hsl(var(--muted-foreground))',\n strokeWidth: 2,\n impactLabel: 'Low Impact',\n impactBg: 'bg-muted',\n impactText: 'text-muted-foreground',\n dotColor: 'hsl(var(--muted-foreground))',\n };\n default:\n return {\n stroke: 'hsl(var(--muted-foreground))',\n strokeWidth: 2,\n impactLabel: 'Impact',\n impactBg: 'bg-muted',\n impactText: 'text-muted-foreground',\n dotColor: 'hsl(var(--muted-foreground))',\n };\n }\n };\n\n const style = getEdgeStyle();\n\n return (\n <>\n {/* Dotted edge path */}\n <BaseEdge\n id={id}\n path={edgePath}\n markerEnd={markerEnd}\n style={{\n stroke: style.stroke,\n strokeWidth: style.strokeWidth,\n strokeDasharray: '8 6', // Dotted pattern\n opacity: 0.7,\n }}\n />\n\n {/* Impact Badge positioned along the edge */}\n <EdgeLabelRenderer>\n <div\n style={{\n position: 'absolute',\n transform: `translate(-50%, -50%) translate(${labelX}px,${labelY}px)`,\n pointerEvents: 'all',\n }}\n className=\"nodrag nopan\"\n >\n <div className={`${style.impactBg} ${style.impactText} px-3 py-1.5 rounded-full shadow-lg text-xs font-semibold whitespace-nowrap`}>\n {style.impactLabel}\n </div>\n </div>\n </EdgeLabelRenderer>\n\n {/* Optional: Relationship label (if provided) - Theme aware */}\n {label && (\n <EdgeLabelRenderer>\n <div\n style={{\n position: 'absolute',\n transform: `translate(-50%, -50%) translate(${labelX}px,${labelY - 35}px)`,\n pointerEvents: 'all',\n }}\n className=\"nodrag nopan\"\n >\n <div className=\"bg-card border-2 border-border px-2.5 py-1 rounded-md shadow-md\">\n <span className=\"text-xs font-medium text-card-foreground whitespace-nowrap\">\n {label}\n </span>\n </div>\n </div>\n </EdgeLabelRenderer>\n )}\n </>\n );\n}) as any);\n\nCustomEdge.displayName = 'CustomEdge';\n\n// Simplified Custom Edge (for performance)\nexport const SimpleCustomEdge = memo((({\n id,\n sourceX,\n sourceY,\n targetX,\n targetY,\n sourcePosition,\n targetPosition,\n data,\n markerEnd,\n}: EdgeProps<CustomEdgeData>) => {\n const [edgePath] = getBezierPath({\n sourceX,\n sourceY,\n sourcePosition,\n targetX,\n targetY,\n targetPosition,\n });\n\n const { strength = 'secondary' } = data || {};\n\n // Theme-aware stroke colors\n const strokeColor =\n strength === 'primary' ? 'hsl(var(--success))' :\n strength === 'secondary' ? 'hsl(var(--warning))' :\n 'hsl(var(--muted-foreground))';\n const strokeWidth = strength === 'primary' ? 3 : strength === 'secondary' ? 2.5 : 2;\n\n return (\n <BaseEdge\n id={id}\n path={edgePath}\n markerEnd={markerEnd}\n style={{\n stroke: strokeColor,\n strokeWidth,\n strokeDasharray: '8 6',\n opacity: 0.7,\n }}\n />\n );\n}) as any);\n\nSimpleCustomEdge.displayName = 'SimpleCustomEdge';\n","// T049: RelationshipGraph component with React Flow\nimport { useCallback, useEffect, useMemo, useRef, useState } from 'react';\nimport { useTranslation } from 'react-i18next';\nimport { useNavigate } from '@tanstack/react-router';\nimport ReactFlow, {\n Background,\n Controls,\n Node,\n Edge,\n useNodesState,\n useEdgesState,\n MarkerType,\n Position,\n BackgroundVariant,\n ReactFlowInstance,\n} from 'reactflow';\nimport 'reactflow/dist/style.css';\n\nimport { useRelationshipsForDossier } from '@/hooks/useRelationships';\nimport { Card } from '@/components/ui/card';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Loader2 } from 'lucide-react';\nimport { CenterNode, RelatedNode } from './CustomNodes';\nimport { CustomEdge } from './CustomEdges';\n\ninterface RelationshipGraphProps {\n dossierId: string;\n dossierName?: string;\n}\n\n// Define custom node types OUTSIDE component to prevent recreation on every render\n// This fixes the React Flow warning and ensures nodes render correctly\nconst nodeTypes = {\n centerNode: CenterNode,\n relatedNode: RelatedNode,\n};\n\n// Define custom edge types OUTSIDE component\nconst edgeTypes = {\n customEdge: CustomEdge,\n};\n\nexport function RelationshipGraph({ dossierId, dossierName = 'Current Dossier' }: RelationshipGraphProps) {\n const { t, i18n } = useTranslation('dossiers');\n const navigate = useNavigate();\n const isRTL = i18n.language === 'ar';\n\n const [relationshipTypeFilter, setRelationshipTypeFilter] = useState<string | undefined>(undefined);\n\n const { data: relationshipsData, isLoading, error } = useRelationshipsForDossier(dossierId);\n const relationships = relationshipsData?.relationships || [];\n\n // Transform relationships to React Flow nodes and edges\n const { nodes: initialNodes, edges: initialEdges } = useMemo(() => {\n if (!relationships || relationships.length === 0) {\n return { nodes: [], edges: [] };\n }\n\n const nodes: Node[] = [];\n const edges: Edge[] = [];\n const nodeMap = new Map<string, boolean>();\n\n // Center node (current dossier) - Custom component with stats\n nodes.push({\n id: dossierId,\n type: 'centerNode',\n data: {\n label: dossierName,\n isCenter: true,\n description: 'Central hub for bilateral and multilateral relationships',\n stats: {\n mous: 12,\n positions: 8,\n engagements: 24,\n health_score: 85,\n },\n },\n position: { x: 600, y: 400 },\n sourcePosition: isRTL ? Position.Left : Position.Right,\n targetPosition: isRTL ? Position.Right : Position.Left,\n });\n nodeMap.set(dossierId, true);\n\n // Calculate positions in a circle around the center - Increased radius for better spread\n const radius = 500;\n const angleStep = (2 * Math.PI) / relationships.length;\n\n relationships.forEach((rel, index) => {\n const angle = index * angleStep;\n const x = 600 + radius * Math.cos(angle);\n const y = 400 + radius * Math.sin(angle);\n\n // Mock stats for related nodes (in production, fetch from dossier data)\n const mockStats = {\n mous: Math.floor(Math.random() * 10) + 1,\n engagements: Math.floor(Math.random() * 15) + 5,\n health_score: Math.floor(Math.random() * 30) + 60,\n };\n\n // Add target dossier node if not current dossier - Custom component with stats\n if (rel.target_dossier && rel.target_dossier.id !== dossierId && !nodeMap.has(rel.target_dossier.id)) {\n nodes.push({\n id: rel.target_dossier.id,\n type: 'relatedNode',\n data: {\n label: isRTL ? rel.target_dossier.name_ar : rel.target_dossier.name_en,\n referenceType: rel.target_dossier.type as 'country' | 'organization' | 'forum',\n description: `Key ${rel.target_dossier.type} partner with active collaboration`,\n stats: mockStats,\n },\n position: { x: isRTL ? 1200 - x : x, y },\n sourcePosition: isRTL ? Position.Left : Position.Right,\n targetPosition: isRTL ? Position.Right : Position.Left,\n });\n nodeMap.set(rel.target_dossier.id, true);\n }\n\n // Add source dossier node if not current dossier - Custom component with stats\n if (rel.source_dossier && rel.source_dossier.id !== dossierId && !nodeMap.has(rel.source_dossier.id)) {\n nodes.push({\n id: rel.source_dossier.id,\n type: 'relatedNode',\n data: {\n label: isRTL ? rel.source_dossier.name_ar : rel.source_dossier.name_en,\n referenceType: rel.source_dossier.type as 'country' | 'organization' | 'forum',\n description: `Key ${rel.source_dossier.type} partner with active collaboration`,\n stats: mockStats,\n },\n position: { x: isRTL ? 1200 - x : x, y },\n sourcePosition: isRTL ? Position.Left : Position.Right,\n targetPosition: isRTL ? Position.Right : Position.Left,\n });\n nodeMap.set(rel.source_dossier.id, true);\n }\n\n // Create edge with custom component\n // Default color since relationship_strength doesn't exist in new schema\n const edgeColor = '#3b82f6'; // Default blue color\n\n edges.push({\n id: `${rel.source_dossier_id}-${rel.target_dossier_id}-${rel.relationship_type}`,\n source: rel.source_dossier_id,\n target: rel.target_dossier_id,\n type: 'customEdge',\n data: {\n label: t(`relationships.types.${rel.relationship_type}`) || rel.relationship_type,\n strength: 'primary', // Default strength since it doesn't exist in new schema\n },\n markerEnd: {\n type: MarkerType.ArrowClosed,\n color: edgeColor,\n width: 20,\n height: 20,\n },\n });\n });\n\n return { nodes, edges };\n }, [relationships, dossierId, dossierName, isRTL]); // t is stable from i18next\n\n const [nodes, setNodes, onNodesChange] = useNodesState(initialNodes);\n const [edges, setEdges, onEdgesChange] = useEdgesState(initialEdges);\n const [reactFlowInstance, setReactFlowInstance] = useState<ReactFlowInstance | null>(null);\n\n // Track the last synced relationship count to prevent infinite loops\n const lastSyncedCount = useRef<number>(-1);\n\n // Sync nodes and edges state when relationships data changes\n // useNodesState/useEdgesState don't automatically update when their initial values change\n useEffect(() => {\n if (lastSyncedCount.current !== relationships.length) {\n setNodes(initialNodes);\n setEdges(initialEdges);\n lastSyncedCount.current = relationships.length;\n }\n }, [relationships.length, initialNodes, initialEdges]);\n\n // Fit view when instance becomes available\n useEffect(() => {\n if (reactFlowInstance && initialNodes.length > 0) {\n // Small delay to ensure nodes are rendered\n setTimeout(() => {\n reactFlowInstance.fitView({\n padding: 0.2,\n includeHiddenNodes: false,\n duration: 400,\n });\n }, 100);\n }\n }, [reactFlowInstance, initialNodes.length]); // Only re-fit when instance is ready or node count changes\n\n // Create a stable key for ReactFlow to force remount on data changes\n const graphKey = useMemo(() =>\n `${dossierId}-${relationships.length}-${relationshipTypeFilter || 'all'}-${isRTL}`,\n [dossierId, relationships.length, relationshipTypeFilter, isRTL]\n );\n\n // Handle node click - navigate to related dossier\n const onNodeClick = useCallback(\n (event: React.MouseEvent, node: Node) => {\n if (node.id !== dossierId) {\n navigate({ to: `/dossiers/${node.id}` });\n }\n },\n [dossierId, navigate]\n );\n\n // Handle React Flow initialization\n const onInit = useCallback((instance: ReactFlowInstance) => {\n setReactFlowInstance(instance);\n }, []);\n\n if (isLoading) {\n return (\n <Card className=\"p-12 text-center\">\n <div className=\"flex flex-col items-center gap-4\">\n <Loader2 className=\"h-10 w-10 animate-spin text-primary\" />\n <p className=\"text-muted-foreground animate-pulse\">{t('loading')}</p>\n </div>\n </Card>\n );\n }\n\n if (error) {\n return (\n <Card className=\"p-12 text-center bg-destructive/10 border-destructive/20\">\n <div className=\"flex flex-col items-center gap-3\">\n <div className=\"h-12 w-12 rounded-full bg-destructive/20 flex items-center justify-center\">\n <span className=\"text-2xl\"></span>\n </div>\n <p className=\"text-destructive font-medium\">{t('relationships.errors.loadFailed')}</p>\n </div>\n </Card>\n );\n }\n\n if (!relationships.length) {\n return (\n <Card className=\"p-12 text-center bg-muted/30\">\n <div className=\"flex flex-col items-center gap-3\">\n <div className=\"h-16 w-16 rounded-full bg-muted flex items-center justify-center\">\n <span className=\"text-3xl\"></span>\n </div>\n <p className=\"text-muted-foreground text-lg\">{t('relationships.no_relationships')}</p>\n </div>\n </Card>\n );\n }\n\n return (\n <div className=\"flex flex-col gap-4 sm:gap-6\" dir={isRTL ? 'rtl' : 'ltr'}>\n {/* Filter Controls - Theme aware */}\n <Card className=\"p-4 sm:p-6 bg-accent/10 border-accent/20\">\n <div className=\"flex flex-col sm:flex-row gap-3 sm:gap-4 items-start sm:items-center\">\n <label className=\"text-sm font-semibold text-foreground min-w-fit\">\n {t('relationships.filter_by_type')}\n </label>\n <Select value={relationshipTypeFilter} onValueChange={(value) => setRelationshipTypeFilter(value === 'all' ? undefined : value)}>\n <SelectTrigger className=\"w-full sm:w-72 bg-card border-border focus:ring-2 focus:ring-ring\">\n <SelectValue placeholder={t('relationships.all_types')} />\n </SelectTrigger>\n <SelectContent>\n <SelectItem value=\"all\">{t('relationships.all_types')}</SelectItem>\n <SelectItem value=\"member_of\">{t('relationships.types.member_of')}</SelectItem>\n <SelectItem value=\"participates_in\">{t('relationships.types.participates_in')}</SelectItem>\n <SelectItem value=\"collaborates_with\">{t('relationships.types.collaborates_with')}</SelectItem>\n <SelectItem value=\"monitors\">{t('relationships.types.monitors')}</SelectItem>\n <SelectItem value=\"is_member\">{t('relationships.types.is_member')}</SelectItem>\n <SelectItem value=\"hosts\">{t('relationships.types.hosts')}</SelectItem>\n </SelectContent>\n </Select>\n </div>\n </Card>\n\n {/* Network Graph - Enhanced Responsive with Larger Card Nodes - Theme aware */}\n <Card className=\"h-[700px] sm:h-[800px] md:h-[900px] overflow-hidden shadow-xl border-2 border-border\">\n <ReactFlow\n key={graphKey}\n nodes={nodes}\n edges={edges}\n onNodesChange={onNodesChange}\n onEdgesChange={onEdgesChange}\n onNodeClick={onNodeClick}\n onInit={onInit}\n nodeTypes={nodeTypes}\n edgeTypes={edgeTypes}\n fitView\n fitViewOptions={{\n padding: 0.2,\n includeHiddenNodes: false,\n }}\n attributionPosition={isRTL ? 'bottom-left' : 'bottom-right'}\n minZoom={0.1}\n maxZoom={1.0}\n defaultEdgeOptions={{\n animated: false,\n }}\n proOptions={{ hideAttribution: true }}\n >\n <Background\n variant={BackgroundVariant.Dots}\n gap={20}\n size={1.5}\n color=\"hsl(var(--border))\"\n className=\"bg-background\"\n />\n <Controls\n className=\"bg-card/90 backdrop-blur-sm shadow-xl border-2 border-border rounded-xl\"\n showInteractive={false}\n />\n </ReactFlow>\n </Card>\n\n </div>\n );\n}\n","/**\n * DossierMoUsTab Component (T055)\n *\n * Displays MoUs linked to a specific dossier\n * Features: Status badges, expiry alerts, click to view details\n * Mobile-first responsive design with RTL support\n */\n\nimport { useQuery } from '@tanstack/react-query';\nimport { useTranslation } from 'react-i18next';\nimport { format } from 'date-fns';\nimport { FileText, Clock, AlertCircle, Calendar } from 'lucide-react';\nimport { supabase } from '@/lib/supabase';\nimport { Card, CardContent } from '@/components/ui/card';\n\ninterface MoU {\n id: string;\n country_id?: string;\n organization_id?: string;\n title: string;\n title_ar: string;\n description?: string;\n dates: {\n signed?: string;\n effective?: string;\n expiry?: string;\n renewal_required?: string;\n };\n effective_date?: string;\n expiry_date?: string;\n lifecycle_state: 'draft' | 'pending' | 'active' | 'expired' | 'cancelled' | 'renewed';\n document_path?: string;\n created_at: string;\n}\n\ninterface DossierMoUsTabProps {\n dossierId: string;\n}\n\nexport function DossierMoUsTab({ dossierId }: DossierMoUsTabProps) {\n const { t, i18n } = useTranslation('dossiers');\n const isRTL = i18n.language === 'ar';\n\n // Fetch MoUs for this dossier using unified architecture\n const { data: mous, isLoading, error } = useQuery({\n queryKey: ['dossier-mous', dossierId],\n queryFn: async () => {\n // Query MoUs where this dossier is either signatory\n const { data, error } = await supabase\n .from('mous')\n .select('*')\n .or(`signatory_1_dossier_id.eq.${dossierId},signatory_2_dossier_id.eq.${dossierId}`)\n .order('created_at', { ascending: false });\n\n if (error) throw error;\n return data as MoU[];\n },\n });\n\n // Status color mapping\n const getStatusColor = (status: MoU['lifecycle_state']) => {\n switch (status) {\n case 'active':\n return 'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400';\n case 'draft':\n case 'pending':\n return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-400';\n case 'expired':\n return 'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-400';\n case 'cancelled':\n return 'bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-400';\n case 'renewed':\n return 'bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-400';\n default:\n return 'bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-400';\n }\n };\n\n // Check if MoU is approaching renewal\n const isApproachingRenewal = (mou: MoU): boolean => {\n const renewalDate = mou.dates?.renewal_required;\n if (!renewalDate || mou.lifecycle_state !== 'active') return false;\n const daysUntilRenewal = Math.floor(\n (new Date(renewalDate).getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24)\n );\n return daysUntilRenewal <= 90 && daysUntilRenewal > 0;\n };\n\n // Loading state\n if (isLoading) {\n return (\n <div className=\"space-y-4\">\n {[1, 2, 3].map((i) => (\n <div\n key={i}\n className=\"h-40 bg-gray-200 dark:bg-gray-700 rounded-lg animate-pulse\"\n />\n ))}\n </div>\n );\n }\n\n // Error state\n if (error) {\n return (\n <div\n className=\"bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-6 text-center\"\n role=\"alert\"\n >\n <p className=\"text-red-800 dark:text-red-200\">\n {t('mous.error_loading')}\n </p>\n <p className=\"mt-2 text-sm text-red-700 dark:text-red-300\">\n {error instanceof Error ? error.message : t('mous.error_generic')}\n </p>\n </div>\n );\n }\n\n // Empty state\n if (!mous || mous.length === 0) {\n return (\n <div className=\"text-center py-12\">\n <FileText className=\"mx-auto h-12 w-12 text-gray-400 dark:text-gray-600\" />\n <h3 className=\"mt-2 text-sm font-medium text-gray-900 dark:text-white\">\n {t('mous.no_mous')}\n </h3>\n <p className=\"mt-1 text-sm text-gray-500 dark:text-gray-400\">\n {t('mous.no_mous_description')}\n </p>\n </div>\n );\n }\n\n return (\n <div className=\"space-y-4\">\n {/* MoUs List */}\n {mous.map((mou) => (\n <Card\n key={mou.id}\n className=\"cursor-pointer hover:shadow-lg transition-shadow duration-200\"\n onClick={() => {\n // TODO: Navigate to MoU detail page or open modal\n }}\n >\n <CardContent className=\"p-4 sm:p-6\">\n <div className=\"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4\">\n {/* MoU Info */}\n <div className=\"flex-1 min-w-0\">\n {/* Title */}\n <h4\n className={`text-base sm:text-lg font-medium text-gray-900 dark:text-white truncate ${\n isRTL ? 'text-end' : 'text-start'\n }`}\n >\n {isRTL ? mou.title_ar : mou.title}\n </h4>\n\n {/* Summary */}\n {mou.description && (\n <p\n className={`mt-1 text-sm text-gray-600 dark:text-gray-400 line-clamp-2 ${\n isRTL ? 'text-end' : 'text-start'\n }`}\n >\n {mou.description}\n </p>\n )}\n\n {/* Dates */}\n <div className=\"mt-3 flex flex-wrap gap-x-4 gap-y-2 text-sm text-gray-500 dark:text-gray-400\">\n {/* Signed Date */}\n {mou.dates?.signed && (\n <div className=\"flex items-center gap-1\">\n <FileText className=\"h-4 w-4\" />\n <span>\n {t('mous.signed')}: {format(new Date(mou.dates.signed), 'dd MMM yyyy')}\n </span>\n </div>\n )}\n\n {/* Expiry Date */}\n {(mou.expiry_date || mou.dates?.expiry) && (\n <div className=\"flex items-center gap-1\">\n <Clock className=\"h-4 w-4\" />\n <span>\n {t('mous.expires')}: {format(new Date(mou.expiry_date || mou.dates?.expiry!), 'dd MMM yyyy')}\n </span>\n </div>\n )}\n\n {/* Effective Date */}\n {(mou.effective_date || mou.dates?.effective) && (\n <div className=\"flex items-center gap-1\">\n <Calendar className=\"h-4 w-4\" />\n <span>\n {t('mous.effective')}: {format(new Date(mou.effective_date || mou.dates?.effective!), 'dd MMM yyyy')}\n </span>\n </div>\n )}\n </div>\n </div>\n\n {/* Status & Alerts */}\n <div className=\"flex flex-col gap-2 items-start sm:items-end\">\n {/* Status Badge */}\n <span\n className={`inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${getStatusColor(\n mou.lifecycle_state\n )}`}\n >\n {t(`mous.status.${mou.lifecycle_state}`)}\n </span>\n\n {/* Renewal Alert */}\n {isApproachingRenewal(mou) && (\n <div className=\"flex items-center gap-1 text-yellow-600 dark:text-yellow-400 text-sm\">\n <AlertCircle className=\"h-4 w-4\" />\n <span>{t('mous.renewal_required')}</span>\n </div>\n )}\n </div>\n </div>\n </CardContent>\n </Card>\n ))}\n </div>\n );\n}\n","/**\n * CountryTimeline Component\n *\n * Type-specific timeline wrapper for Country dossiers\n * Default event types:\n * - Intelligence reports (primary)\n * - MoU signings\n * - Calendar events (bilateral meetings, state visits)\n * - Documents (treaties, policies)\n * - Relationships (diplomatic ties)\n */\n\nimport { useState } from 'react';\nimport { useTranslation } from 'react-i18next';\nimport { EnhancedVerticalTimeline } from './EnhancedVerticalTimeline';\nimport { TimelineFilters } from './TimelineFilters';\nimport { useUnifiedTimeline, getDefaultEventTypes, getAvailableEventTypes } from '@/hooks/useUnifiedTimeline';\nimport type { TimelineFilters as ITimelineFilters } from '@/types/timeline.types';\n\ninterface CountryTimelineProps {\n  dossierId: string;\n  className?: string;\n}\n\nexport function CountryTimeline({ dossierId, className }: CountryTimelineProps) {\n  const { t } = useTranslation('dossier');\n  const [showFilters, setShowFilters] = useState(false);\n\n  // Initialize with default event types for Country dossiers\n  const defaultEventTypes = getDefaultEventTypes('Country');\n  const availableEventTypes = getAvailableEventTypes('Country');\n\n  const {\n    events,\n    isLoading,\n    isFetchingNextPage,\n    hasNextPage,\n    error,\n    fetchNextPage,\n    refetch,\n    filters,\n    setFilters,\n  } = useUnifiedTimeline({\n    dossierId,\n    dossierType: 'Country',\n    initialFilters: {\n      event_types: defaultEventTypes,\n    },\n    itemsPerPage: 20,\n    enableRealtime: false,\n  });\n\n  const handleFiltersChange = (newFilters: ITimelineFilters) => {\n    setFilters(newFilters);\n  };\n\n  return (\n    <div className={className}>\n      {/* Filters Section */}\n      <TimelineFilters\n        filters={filters}\n        onFiltersChange={handleFiltersChange}\n        availableEventTypes={availableEventTypes}\n        defaultEventTypes={defaultEventTypes}\n        showFilters={showFilters}\n        onToggleFilters={() => setShowFilters(!showFilters)}\n        onRefresh={refetch}\n      />\n\n      {/* Timeline */}\n      <EnhancedVerticalTimeline\n        events={events}\n        isLoading={isLoading}\n        isFetchingNextPage={isFetchingNextPage}\n        hasNextPage={hasNextPage}\n        onLoadMore={fetchNextPage}\n        error={error}\n        emptyMessage={t('timeline.empty.country')}\n      />\n    </div>\n  );\n}\n"],"names":["KeyContactsPanel","contacts","isLoading","onAddContact","onEditContact","onDeleteContact","t","i18n","useTranslation","Card","jsx","CardHeader","CardTitle","CardContent","_","index","jsxs","Skeleton","Button","UserPlus","User","Badge","contact","Edit","Trash2","Building2","Mail","Phone","Calendar","useDossierPositionLinks","dossierId","filters","data","error","refetch","useQuery","query","supabase","links","queryError","count","filteredLinks","link","searchLower","position","positions","DossierPositionsTab","searchQuery","setSearchQuery","useState","statusFilter","setStatusFilter","typeFilter","setTypeFilter","linkTypeFilter","setLinkTypeFilter","showAttachDialog","setShowAttachDialog","debouncedSearch","useDebouncedValue","totalCount","handleCreatePosition","handleClearFilters","hasActiveFilters","Input","e","Select","value","SelectTrigger","SelectValue","SelectContent","SelectItem","PositionList","AttachPositionDialog","supabaseUrl","RelationshipAPIError","message","status","code","details","getAuthHeaders","session","handleResponse","response","getRelationshipsForDossier","page","page_size","headers","params","url","relationshipKeys","id","type","useRelationshipsForDossier","options","CenterNode","memo","Sparkles","FileText","Users","ChevronRight","Handle","Position","RelatedNode","isConnectable","referenceType","label","description","stats","style","Globe2","Users2","IconComponent","TrendingUp","CustomEdge","sourceX","sourceY","targetX","targetY","sourcePosition","targetPosition","markerEnd","edgePath","labelX","labelY","getBezierPath","strength","Fragment","BaseEdge","EdgeLabelRenderer","SimpleCustomEdge","strokeColor","strokeWidth","nodeTypes","edgeTypes","RelationshipGraph","dossierName","navigate","useNavigate","isRTL","relationshipTypeFilter","setRelationshipTypeFilter","relationshipsData","relationships","initialNodes","initialEdges","useMemo","nodes","edges","nodeMap","radius","angleStep","rel","angle","x","y","mockStats","MarkerType","setNodes","onNodesChange","useNodesState","setEdges","onEdgesChange","useEdgesState","reactFlowInstance","setReactFlowInstance","lastSyncedCount","useRef","useEffect","graphKey","onNodeClick","useCallback","event","node","onInit","instance","Loader2","ReactFlow","Background","BackgroundVariant","Controls","DossierMoUsTab","mous","getStatusColor","isApproachingRenewal","mou","renewalDate","daysUntilRenewal","i","format","Clock","AlertCircle","CountryTimeline","className","showFilters","setShowFilters","defaultEventTypes","getDefaultEventTypes","availableEventTypes","getAvailableEventTypes","events","isFetchingNextPage","hasNextPage","fetchNextPage","setFilters","useUnifiedTimeline","handleFiltersChange","newFilters","TimelineFilters","EnhancedVerticalTimeline"],"mappings":"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"}