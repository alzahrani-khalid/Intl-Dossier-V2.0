# Nginx Configuration for Self-Hosted Supabase
# Place this file in /etc/nginx/sites-available/supabase
# Then create symlink: sudo ln -s /etc/nginx/sites-available/supabase /etc/nginx/sites-enabled/
#
# Update all instances of:
#   - supabase.yourdomain.com → your actual domain
#   - yourdomain.com → your application domain
#
# After updating, test with: sudo nginx -t
# Then reload: sudo systemctl reload nginx

# Redirect HTTP to HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name supabase.yourdomain.com;

    # ACME challenge for Let's Encrypt (certbot)
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
        try_files $uri =404;
    }

    # Redirect all other traffic to HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# HTTPS Server
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name supabase.yourdomain.com;

    # SSL Certificates (managed by certbot)
    # These paths will be automatically configured by certbot
    ssl_certificate /etc/letsencrypt/live/supabase.yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/supabase.yourdomain.com/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/supabase.yourdomain.com/chain.pem;

    # SSL Configuration
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    ssl_session_tickets off;

    # OCSP Stapling
    ssl_stapling on;
    ssl_stapling_verify on;
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 5s;

    # Security Headers
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;

    # Logging
    access_log /var/log/nginx/supabase-access.log;
    error_log /var/log/nginx/supabase-error.log;

    # Client body size (for file uploads)
    client_max_body_size 50M;

    # Timeouts
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    send_timeout 60s;

    # Proxy headers (common for all locations)
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;

    # WebSocket support (for Realtime)
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # Disable buffering for real-time responses
    proxy_buffering off;
    proxy_request_buffering off;

    # Root location - API Gateway (Kong)
    location / {
        proxy_pass http://localhost:8000;
    }

    # REST API
    location /rest/ {
        proxy_pass http://localhost:8000/rest/;
    }

    # Auth API
    location /auth/ {
        proxy_pass http://localhost:8000/auth/;
    }

    # Realtime (WebSocket)
    location /realtime/ {
        proxy_pass http://localhost:8000/realtime/;

        # WebSocket specific
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Prevent timeout on idle connections
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # Storage API
    location /storage/ {
        proxy_pass http://localhost:8000/storage/;

        # Longer timeout for file uploads
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }

    # Edge Functions
    location /functions/ {
        proxy_pass http://localhost:8000/functions/;

        # Edge Functions might take longer
        proxy_read_timeout 120s;
    }

    # PostgreSQL Meta (Database Management)
    location /pg/ {
        proxy_pass http://localhost:8000/pg/;
    }

    # Studio (Admin Dashboard) - Optional separate subdomain recommended
    # For better security, consider hosting Studio on studio.yourdomain.com instead
    location /studio {
        proxy_pass http://localhost:3000;

        # Auth required for Studio
        # Consider adding basic auth or IP whitelisting:
        # auth_basic "Supabase Studio";
        # auth_basic_user_file /etc/nginx/.htpasswd;

        # Or restrict by IP:
        # allow 192.168.1.0/24;  # Your office network
        # deny all;
    }

    # Health check endpoint
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Block common vulnerability scans
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Deny access to sensitive files
    location ~ \.(env|sql|bak|config)$ {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# Optional: Separate subdomain for Studio (Recommended for production)
# Uncomment and configure for better security

# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     server_name studio.yourdomain.com;
#
#     ssl_certificate /etc/letsencrypt/live/studio.yourdomain.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/studio.yourdomain.com/privkey.pem;
#
#     # Copy SSL configuration from above
#
#     # IP Whitelist (recommended)
#     allow 192.168.1.0/24;  # Your office network
#     allow YOUR_HOME_IP;     # Your home IP
#     deny all;
#
#     location / {
#         proxy_pass http://localhost:3000;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
# }

# Rate Limiting Configuration (Optional but recommended)
# Add to http block in /etc/nginx/nginx.conf:
#
# limit_req_zone $binary_remote_addr zone=api_limit:10m rate=100r/s;
# limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=10r/s;
#
# Then in server block, add:
# location /auth/ {
#     limit_req zone=auth_limit burst=20 nodelay;
#     proxy_pass http://localhost:8000/auth/;
# }
#
# location /rest/ {
#     limit_req zone=api_limit burst=50 nodelay;
#     proxy_pass http://localhost:8000/rest/;
# }

# Connection Limiting (Optional)
# Add to http block:
# limit_conn_zone $binary_remote_addr zone=addr:10m;
# limit_conn addr 10;

# Monitoring with Nginx Status (Optional)
# Uncomment to enable Nginx status page for monitoring
# server {
#     listen 127.0.0.1:8080;
#     server_name localhost;
#
#     location /nginx_status {
#         stub_status on;
#         access_log off;
#         allow 127.0.0.1;
#         deny all;
#     }
# }

# Notes:
# 1. After copying this file, run: sudo nginx -t
# 2. If test passes, reload: sudo systemctl reload nginx
# 3. For Let's Encrypt: sudo certbot --nginx -d supabase.yourdomain.com
# 4. Auto-renewal is configured via systemd timer
# 5. Monitor logs: tail -f /var/log/nginx/supabase-*.log
# 6. For production, consider enabling rate limiting (uncomment sections above)
# 7. Review and adjust timeouts based on your application needs
# 8. Consider using separate subdomain for Studio with IP whitelist
